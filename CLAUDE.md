# Project: binkterm-php

## Project Description

A modern web interface and mailer tool that receives and sends Fidonet message packets using its own binkp Fidonet mailer. The project provides users with a delightful, modern web experience that allows them to send and receive netmail (private messages) and echomail (forums) with the help of binkp.

## Tech Stack

 - Frontend: jQuery, Bootstrap 5
 - Backend: PHP, SimpleRouter request library, Twig templates
 - Database: Postgres
 

## Code Conventions

 - camelCase for variables and functions
 - PascalCase for components and classes
 - 4 space indents

## Project Structure

 - src/ - main source code
 - scripts/ - CLI tools (binkp_server, binkp_poll, maintenance scripts, etc.)
 - templates/ - html templates
 - public_html/ - the web site files, static assets
 - tests/ - test scripts used in debugging and troubleshooting
 - vendor/ - 3rd party libraries managed by composer and should not be touched by Claude
 - data/ - runtime data (binkp.json, nodelists.json, logs, inbound/outbound packets)

## Important Notes
 - User authentication is simple username and password with long lived cookie
 - Both usernames and Real Names are considered unique. Two users cannot have the same username or real name
 - The web interface should use ajax requests by api for queries
 - This is for FTN style networks and forums
 - Always write out schema changes. A database will need to be created from scratch and schema/migrations are how it needs to be done. Migration scripts follow the naming convention v<VERSION>_<description>.sql, eg: v1.7.5_description.sql
 - When adding features to netmail and echomail, keep in mind feature parity. Ask for clarification about whether a feature is appropriate to both
 - Leave the vendor directory alone. It's managed by composer only
 - When updating style.css, also update the theme stylesheets: amber.css, dark.css, greenterm.css, and cyberpunk.css
 - Database migrations are handled through scripts/setup.php.  setup.php will also call upgrade.php which handles other upgrade related tasks. 
 - Migrations can be SQL or PHP. Use the naming convention vX.Y.Z_description (e.g., v1.9.1.6_migrate_file_area_dirs.sql or .php). PHP migrations are executed by scripts/upgrade.php and receive a $db PDO connection.
 - setup.php must be called when upgrading - this is to ensure certain things like file permissions are correct.
 - See FAQ.md for common questions and troubleshooting
 - To get a database connection use $db = Database::getInstance()->getPdo()
 - Don't edit postgres_schema.sql unless specifically instructed to.  Database changes are typically migration based.
 - Avoid duplicating code.  Whenever possible centralize methods using a class.
 - **Git Workflow**: Do NOT stage or commit changes until explicitly instructed. Changes should be tested first before committing to git.
 - When writing out a proposal document state in the preamble that the proposal is a draft, was generated by AI and may not have been reviewed for accuracy.
 - **Service Worker Cache**: When making changes to CSS or JavaScript files, increment the CACHE_NAME version in public_html/sw.js (e.g., 'binkcache-v2' to 'binkcache-v3') to force clients to download fresh copies. The service worker handles all static asset caching to bypass aggressive browser caching on mobile devices.
 - Write phpDoc blocks when possible

## URL Construction
When constructing full URLs for the application (e.g., share links, reset password links, meta tags), **always** use the centralized `Config::getSiteUrl()` method:

### Why This Matters
- The application may be behind an HTTPS proxy/load balancer
- In this scenario, `$_SERVER['HTTPS']` may not be set even though the public-facing URL uses HTTPS
- The `SITE_URL` environment variable ensures correct URL generation regardless of proxy configuration
- Using the centralized method prevents code duplication and ensures consistent behavior

### Usage Pattern
```php
// Build URL using centralized method
$url = \BinktermPHP\Config::getSiteUrl() . '/path/to/resource';
```

The `getSiteUrl()` method:
1. Checks `SITE_URL` environment variable first (handles proxies correctly)
2. Falls back to protocol detection using `$_SERVER['HTTPS']` and `$_SERVER['HTTP_HOST']`
3. Returns the base URL without trailing slash

### Examples in Codebase
- `MessageHandler::buildShareUrl()` - share link generation
- `routes/web-routes.php` - shared message page
- `PasswordResetController` - password reset emails

## Admin Daemon

The admin daemon (scripts/admin_daemon.php) is a critical system management component.  It provides an API to the web interface
for retrieving and setting configuration elements through various commands as well as polling and other tasks.

When adding new configuration settings you'll be working with the configuration daemon that performs the actual work.  The web interface will make an API request.

You may need to add new commands, or update existing ones depending on the context of the setting being added.  Be sure to clarify and confirm this.

## Changelog Workflow
 - **IMPORTANT**: When completing significant features, bug fixes, or improvements, ALWAYS update the changelog at `templates/recent_updates.twig` by adding entries to the top of the file with the current date
 - Use this format:
   ```html
   <div class="update-item mb-3" data-version="1.4.1" data-date="2025-08-29">
       <div class="d-flex justify-content-between align-items-start">
           <div>
               <h6 class="mb-1"><span class="badge bg-primary me-2">Feature</span>Webshare Functionality</h6>
               <p class="mb-1 text-muted">Users can now share echomail messages via secure web links with privacy controls and expiration settings.</p>
           </div>
           <small class="text-muted">v1.4.1</small>
       </div>
   </div>
   ```
 - Badge types: `bg-primary` (Feature), `bg-success` (Improvement), `bg-warning` (Fix), `bg-info` (Update)
 - Keep entries concise but descriptive
 - Limit to 10-15 most recent entries (remove older ones)
 - This file is automatically displayed on the admin dashboard's "Recent Updates" section

## Credits System Workflow
When adding new UserCredit credit/reward types or debit types, you must update configuration, code defaults, and admin interface:

### Required Updates
1. **Update Code Defaults**: Add the new credit type with fallback values in `src/UserCredit.php`
   - The `UserCredit` class contains hardcoded default values in the `getCreditsConfig()` method
   - Add your new credit type to the `$defaults` array
   - Add validation for the new field in the `$merged` array processing
   - These defaults ensure the system works even if bbs.json is not fully configured
   - Code defaults serve as the ultimate fallback and should be sensible values

2. **Update bbs.json.example**: Add the new credit type to the `credits` section
   - This ensures new installations have the credit type properly documented
   - Values in bbs.json.example should match or override code defaults with production-ready values
   - Include comments explaining what the credit type does

3. **Update Admin Credit Settings Page**: Add the new credit type to the admin interface
   - Location: `templates/admin/bbs_settings.twig` in the Credits System Configuration section
   - Add appropriate form fields within the credit configuration section
   - Add JavaScript to load the value in `loadBbsSettings()` function
   - Add JavaScript validation in `saveBbsCredits()` function
   - Add the field to the config object being sent to the API
   - Ensure field names match the keys in bbs.json
   - The admin page allows runtime configuration which gets saved to data/bbs.json

4. **Update Admin API Endpoint**: Add backend validation and saving in `routes/admin-routes.php`
   - Location: The POST `/admin/api/bbs-settings` endpoint handler
   - Add validation for the new credit field (check if numeric, non-negative, etc.)
   - Add the field to the `$config['credits']` array that gets saved
   - Ensure proper type casting (int for costs/rewards, float for percentages)
   - **CRITICAL**: The admin daemon must be restarted after code changes to pick up the new validation
   - Without this step, the admin interface will send the field but it won't be saved to config

5. **Update README.md**: Document the new credit type in the README
   - Add the new credit type to the credits system documentation section
   - Explain what the credit type does and when it's awarded/charged
   - Include the default value for reference

### Configuration Priority
The system uses this priority order for credit values:
1. Runtime configuration in `data/bbs.json` (highest priority - set via admin interface)
2. Default template in `bbs.json.example` (used during initial setup)
3. Code defaults in `src/UserCredit.php` (lowest priority - fallback values)

### Example Credit Types
- Login rewards (daily login bonus)
- Message posting rewards (credits per netmail/echomail)
- WebDoor game costs (credits charged to play games)
- File download costs
- Premium feature access costs

### Important Notes
- Always add code defaults first so the system remains functional even without configuration files
- Credit values should be sensible defaults that work for most installations
- Document the purpose of each credit type in comments within bbs.json.example
- Ensure the admin interface provides clear descriptions of what each credit type does
- Test both new installations (using defaults) and existing installations (manual config) when adding new credit types
- When updating a template to add information about user credits use the credits_enabled variable in the twig template to determine whether to show the information

## Recent Features Added

### WebDoors System
WebDoors is an evolving specification for embedding HTML5/JavaScript games into the BBS. The specification as used by BinktermPHP is documented in `docs/WebDoors.md`.

A draft status specification with ideas we can draw upon is in `docs/proposals/WebDoor_Proposal.md` however it does not reflect the current state of implementation.

**Current Implementation:**
- **Game Manifest System**: Each WebDoor includes a `webdoor.json` manifest describing capabilities, requirements, and configuration
- **Auto-Discovery**: System automatically scans `public_html/webdoors/` for games with manifests
- **Drop-In Installation**: Games can be installed by simply copying to the webdoors directory
- **Configuration Merging**: Manifest config defaults are automatically applied when enabling a door
- **Admin Interface**: Web-based configuration UI for enabling/disabling doors and adjusting settings
- **Credits Integration**: Games can integrate with the BBS credits economy system

**Key Classes:**
- `WebDoorManifest` - Scans and parses webdoor.json manifests from installed games
- `GameConfig` - Manages per-door configuration from config/webdoors.json
- `WebDoorController` - Handles game session management and API endpoints

**Important Notes:**
- When adding WebDoor API functionality or making changes to the WebDoor system (not individual webdoors themselves), update `docs/WebDoors.md` to reflect new features
- WebDoor specification is evolving - keep documentation synchronized with implementation
- All WebDoor games must include a valid `webdoor.json` manifest
- Configuration from manifest `config` section is merged into `config/webdoors.json` on activation
- Games access BBS functionality through REST API endpoints at `/api/webdoor/*`

### Multi-Network Support
- **Multiple Networks**: The system supports multiple FTN networks through individual uplinks with domain-based routing
- **Local Echo Areas**: `is_local` flag identifies echoareas for local use only (messages not transmitted to uplinks)
- **ANSI Decoder**: Javascript renderer for ANSI art in echomail messages
- **Hyperlink Detection**: Automatic URL detection and linking in message display

### Gateway Tokens
- **External Authentication**: Gateway tokens provide temporary SSO-like authentication for external services
- **One-Time Use**: Tokens are single-use with configurable expiration (default 5 minutes)
- **API Verification**: External services can verify tokens via API with X-API-Key authentication

### User Management Improvements
- **Unique Real Names**: Case-insensitive unique constraint on real names prevents impersonation
- **Registration Validation**: Duplicate checking for both username and real name during registration

### Packet Logging
- **Dedicated Log File**: Packet processing now logs to `data/logs/packets.log` instead of PHP error log

### Webshare Feature
- **Message Sharing**: Users can share echomail messages via secure web links
- **Privacy Controls**: Public (anonymous access) vs private (login required) sharing options
- **Expiration Settings**: Links can expire after 1 hour, 24 hours, 1 week, 30 days, or never
- **Access Management**: Share revocation, access statistics, and usage tracking

### Character Encoding Improvements
- **Enhanced CP437 Support**: Added iconv fallback for better DOS codepage handling
- **FidoNet Compatibility**: Improved handling of legacy character encodings in message packets

### Date Parsing Fixes
- **Regex Pattern Improvements**: Fixed date parsing for FidoNet timestamps
- **Timezone Processing**: Enhanced TZUTC offset calculations

## Known Issues
 - Some technical information on the protocols used by 'binkp' are old and may be difficult to find
 - Date parsing occasionally has edge cases with malformed timestamps from various FTN software
 - PostgreSQL is picky about boolean values - ensure they are properly cast

## Future Plans
 - More BBS-like features such as multi-user interaction, messaging, games, etc.
 - Continued bug fixes and stability improvements

## Version Management

### Overview
BinktermPHP uses a centralized application version management system that ensures consistent version numbers across:
- Message tearlines in FidoNet packets
- Web interface footer display
- Package metadata (composer.json)
- API responses and system information

- Database version is separate from application version.  Database versions are reflected in the database schema migration files.
- Database versions can be in the format of 1.2.3 or 1.2.3.4
- Application versions can be in the format of 1.2.3


### How to Update the Version

When releasing a new version of BinktermPHP, follow these steps:

#### 1. Update the Version Constant
Edit `src/Version.php` and change the `VERSION` constant:

```php
private const VERSION = '1.4.3';  // Update this line
```

#### 2. Update composer.json (Optional but Recommended)
Edit `composer.json` to match the new version:

```json
{
    "name": "binkterm-php/fidonet-web",
    "version": "1.4.3",  // Update this line
    ...
}
```

#### 3. Update Recent Updates Template
Add an entry to `templates/recent_updates.twig` documenting the changes in this version:

```html
<div class="update-item mb-3" data-version="1.4.3" data-date="2025-08-29">
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <h6 class="mb-1"><span class="badge bg-primary me-2">Feature</span>Version Management System</h6>
            <p class="mb-1 text-muted">Added centralized version management with consistent tearlines and web interface display.</p>
        </div>
        <small class="text-muted">v1.4.3</small>
    </div>
</div>
```

#### 4. Commit and Tag
Commit your changes. Do NOT create a tag.

```bash
git add src/Version.php composer.json templates/recent_updates.twig
git commit -m "Bump version to 1.4.3"
git push origin main 
```

#### 5. Update UPGRADING_x.x.x.md documentation

For new releases we create a document named UPGRADING_x.x.x.md (eg: UPGRADING_1.6.7.md) in the docs/ directory with a summary of changes and important upgrade instructions

### What Updates Automatically

Once you change the version in `src/Version.php`, the following will automatically use the new version:

- **Message Tearlines**: All outbound FidoNet messages will include `--- BinktermPHP v1.4.3`
- **Web Interface Footer**: All web pages will show "BinktermPHP v1.4.3 on Github"
- **API Responses**: Any code using `Version::getVersionInfo()` will return current version
- **Template Variables**: All Twig templates have access to `{{ app_version }}`, `{{ app_full_version }}`, etc.

### Version Format

BinktermPHP follows semantic versioning (semver):
- **MAJOR.MINOR.PATCH** format (e.g., 1.4.2)
- **Major**: Breaking changes
- **Minor**: New features, backwards compatible
- **Patch**: Bug fixes, backwards compatible

### Version Class Methods

The `Version` class provides several methods for different use cases:

```php
Version::getVersion()        // "1.4.2"
Version::getAppName()        // "BinktermPHP"  
Version::getFullVersion()    // "BinktermPHP v1.4.2"
Version::getTearline()       // "--- BinktermPHP v1.4.2"
Version::getVersionInfo()    // Complete array with all info
Version::compareVersion('1.4.1')  // Version comparison
```

### Notes
- Only edit the version in `src/Version.php` - all other locations will update automatically
- The tearline format follows FidoNet standards (starts with "---" and under 79 characters)
- Version is displayed to users, so keep it professional and consistent
- Database migrations have their own versioning system (v1.7.x_description.sql) separate from application version
- Application version and database migration version are independent and do not need to match
