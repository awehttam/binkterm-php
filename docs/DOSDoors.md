# DOS Door Games - Sysop Documentation

This document was generated by AI and may contain errors. Report issues on Github.

## Table of Contents
- [Overview](#overview)
- [System Architecture](#system-architecture)
- [Prerequisites](#prerequisites)
- [Initial Setup](#initial-setup)
- [Configuration](#configuration)
- [Adding New Door Games](#adding-new-door-games)
- [Door Manifest Format](#door-manifest-format)
- [Troubleshooting](#troubleshooting)
- [Advanced Configuration](#advanced-configuration)

---

## Overview

BinktermPHP supports classic DOS door games through a DOSBox-X bridge system. This allows users to play traditional BBS door games like Legend of the Red Dragon (LORD), Trade Wars 2002, and others directly in their web browser.

**Key Features:**
- Multi-user support (up to 100 concurrent sessions; default 10)
- Automatic node allocation
- Session management with expiration
- Configurable disconnect and carrier loss behavior
- Drop file generation (DOOR.SYS format)
- ANSI/CP437 encoding support
- Custom icons and screenshots per door
- Secure asset serving (manifest-declared assets only)

---

## System Architecture

The DOS door system uses a **multiplexing bridge** architecture where a single long-running bridge process manages the entire session lifecycle:

```
[Browser 1] ─┐
[Browser 2] ─┼─→ wss://bbs.com:6001 ─→ [Multiplexing Bridge] ─┬─→ 127.0.0.1:5000 ←─ DOSBox 1 → LORD
[Browser 3] ─┘      (WebSocket)           (Node.js Process)     ├─→ 127.0.0.1:5001 ←─ DOSBox 2 → TW2002
                                                                 └─→ 127.0.0.1:5002 ←─ DOSBox 3 → LORD
```

**Components:**

1. **Multiplexing Bridge** (`scripts/dosbox-bridge/multiplexing-server.js`):
   - Single long-running Node.js process
   - Listens on one WebSocket port (default: 6001)
   - Authenticates clients using tokens
   - **Dynamically allocates TCP ports** from pool (5000-5100)
   - **Generates DOSBox configs** with session-specific settings
   - **Launches DOSBox processes** when WebSocket connects
   - Creates TCP listeners for DOSBox connections
   - Multiplexes data between WebSocket clients and DOSBox TCP ports
   - Handles up to 100 concurrent sessions efficiently (60-100MB RAM per dosbox-x session on x64)

2. **DOSBox-X**: Runs the actual DOS door game in headless mode
   - Each session gets its own DOSBox process (launched by bridge)
   - Connects TO bridge via TCP on dynamically allocated port
   - Built-in FOSSIL emulation for door compatibility

3. **Session Manager** (`src/DoorSessionManager.php`):
   - Allocates nodes (1-100)
   - Generates authentication tokens
   - Stores user data in session record (for drop file generation)
   - Creates session record in database
   - **Bridge handles everything else** (port allocation, drop file creation, config generation, DOSBox launch)

**Data Flow:**
1. User clicks door game link
2. PHP allocates node, generates unique token
3. PHP creates database record with session info (token, node, door_id, user data for drop file)
4. PHP returns session data with WebSocket URL and token to browser
5. Browser connects to multiplexing bridge with token: `wss://bbs.com:6001?token=abc123...`
6. Bridge validates token against database, retrieves session details including user data
7. **Bridge allocates dynamic TCP port** from available pool (no port conflicts!)
8. **Bridge generates drop file (DOOR.SYS)** using user data from session record
9. **Bridge generates DOSBox config** with allocated port and door-specific settings
10. **Bridge creates TCP listener** on allocated port
11. **Bridge launches DOSBox** which connects back to bridge's TCP listener
12. **Bridge updates database** with allocated port and DOSBox PID
13. User input flows: Browser → WebSocket → Bridge → TCP → DOSBox → Door Game
14. Game output flows: Door Game → DOSBox → TCP → Bridge → WebSocket → Browser
15. When done, DOSBox exits, bridge detects disconnect and cleans up

**Advantages of This Architecture:**
- **No Port Conflicts**: Dynamic allocation from pool, only binds ports for active sessions
- **Efficient**: One Node.js process manages all sessions
- **Scalable**: Handles many concurrent sessions with minimal overhead
- **Easy SSL**: Works seamlessly behind reverse proxy (Caddy, nginx)
- **Centralized**: All WebSocket connections through single port
- **Reliable**: Long-running daemon with full lifecycle control
- **Simple**: PHP just creates database record, bridge does the heavy lifting

---

## Prerequisites

### Required Software

1. **DOSBox-X** (recommended) or vanilla DOSBox
   - **DOSBox-X is strongly recommended** due to better serial port stability and features:
     - Vanilla DOSBox has known issues with serial port handling
     - DOSBox-X provides better FOSSIL emulation and multiplexing support
     - Memory usage: ~60-100 MB RAM per instance in headless mode on x64
     - With 10 concurrent users: ~1 GB RAM (very reasonable)

   **Installation:**
   - Windows: Download from https://dosbox-x.com/
   - Linux: `sudo apt install dosbox-x` or compile from source
   - macOS: `brew install dosbox-x`

   **Vanilla DOSBox (alternative, not recommended for production):**
   - Similar memory usage (~60-100 MB per instance)
   - Known serial port stability issues
   - May work for testing but not recommended for production use (it didn't work well for me in testing!)
   - Linux: `sudo apt install dosbox`
   - Windows: Download from https://www.dosbox.com/
   - macOS: `brew install dosbox`

   **Note:** The bridge auto-detects and prefers vanilla DOSBox if both are installed.
   Set `DOSBOX_EXECUTABLE=/usr/bin/dosbox-x` in `.env` to specify a dosbox executable to use.

   **DOSEMU Support (Experimental, Not Recommended):**
   - The bridge includes experimental DOSEMU support via `DOOR_EMULATOR=dosemu`
   - **NOT recommended for production use** - numerous issues and requires further testing+development
   - Console I/O vs serial I/O conflicts with FOSSIL drivers
   - Complex configuration requirements
   - Only for adventurous sysops willing to troubleshoot and debug
   - DOSBox is proven, reliable, and recommended for all deployments

2. **Node.js** 18.x or newer (tested with 24)
   - Download from https://nodejs.org/
   - Required for the bridge server

3. **Node.js Dependencies** (in bridge directory):
   ```bash
   cd scripts/dosbox-bridge
   npm install ws iconv-lite pg dotenv
   ```
   - `ws` - WebSocket library
   - `iconv-lite` - Character encoding (CP437 ↔ UTF-8)
   - `pg` - PostgreSQL client (for authentication)
   - `dotenv` - Load environment variables from .env

### File Structure

```
binktest/
├── dosbox-bridge/                          # DOSBox configuration and DOS files
│   ├── dosbox-bridge-production.conf       # Headless config (default)
│   ├── dosbox-bridge-test.conf             # Visible window config (testing)
│   └── dos/                                # DOS drive (mounted as C:)
│       └── doors/                          # Door game installations
│           └── lord/                       # Example: Legend of the Red Dragon
│               ├── dosdor.json            # Door manifest (required)
│               ├── START.BAT               # Launch script
│               └── ... (game files)
├── scripts/
│   ├── dosbox-bridge/
│   │   └── server.js                       # WebSocket-to-TCP bridge
│   └── cleanup_expired_dosdoor_sessions.php # Cleanup script
└── data/
    └── doorsessions/                       # Per-session temp directories
        └── door_<user>_node<N>_<timestamp>/ # Session folder
            ├── DOOR.SYS                    # Drop file for this session
            └── dosbox.conf                 # Session-specific DOSBox config
```

---

## Initial Setup

### 1. Install DOSBox-X

**Windows:**
1. Download DOSBox-X from https://dosbox-x.com/
2. Install to `C:\DOSBox-X\` (recommended)
3. Verify installation: Open Start Menu → DOSBox-X

**Linux (Debian/Ubuntu):**
```bash
# Option 1: Package manager (if available)
sudo apt install dosbox-x

# Option 2: Compile from source
# Install build dependencies
sudo apt update
sudo apt install -y automake gcc g++ make libncurses-dev nasm \
    libsdl2-dev libsdl2-net-dev libpcap-dev libslirp-dev fluidsynth \
    libfluidsynth-dev libavformat-dev libavcodec-dev libswscale-dev \
    libfreetype-dev libxkbfile-dev libxrandr-dev libglu1-mesa-dev git

# Clone and build
git clone https://github.com/joncampbell123/dosbox-x.git
cd dosbox-x
./build
sudo make install

# Verify installation
dosbox-x --version
```

### 2. Install Node.js Dependencies

From your BinktermPHP root directory:
```bash
cd scripts/dosbox-bridge
npm install ws iconv-lite pg dotenv
```

### 3. Configure Environment Variables

Edit `.env` and add/verify:

```bash
# DOS Emulator Selection (default: dosbox)
# dosbox = DOSBox or DOSBox-X (RECOMMENDED for stability)
# dosemu = DOSEMU (EXPERIMENTAL, Linux only, not recommended)
# DOOR_EMULATOR=dosbox

# DOSBox executable path (auto-detected if not specified)
# Auto-detection order: dosbox, dosbox-x
# DOSBOX_EXECUTABLE=/usr/bin/dosbox-x
DOSBOX_EXECUTABLE=/usr/local/bin/dosbox-x
#DOSBOX_EXECUTABLE=C:\DOSBox-X\dosbox-x.exe

# DOSEMU executable path (auto-detected if not specified)
# Linux only - experimental support, not recommended for production
# DOSEMU_EXECUTABLE=/usr/bin/dosemu

# DOSBox config file (default: dosbox-bridge-production.conf)
# DOSDOOR_CONFIG=dosbox-bridge-production.conf
# DOSDOOR_CONFIG=dosbox-bridge-test.conf
# DOSDOOR_CONFIG=dosbox-bridge-custom.conf

# WebSocket disconnect behavior (in minutes, default: 0 = immediate)
# 0 = Immediately simulate carrier loss when WebSocket disconnects
# >0 = Wait X minutes for user to reconnect before triggering carrier loss
DOSDOOR_DISCONNECT_TIMEOUT=0

# Carrier loss timeout (in milliseconds, default: 5000)
# How long to wait for door process to exit gracefully after carrier loss
# before force-killing the process
DOSDOOR_CARRIER_LOSS_TIMEOUT=5000

# WebSocket port for multiplexing bridge (default: 6001)
DOSDOOR_WS_PORT=6001

# WebSocket bind address (default: 127.0.0.1 for reverse proxy)
# 127.0.0.1 = Localhost only (production behind SSL proxy)
# 0.0.0.0 = All interfaces (development/direct access)
DOSDOOR_WS_BIND_HOST=127.0.0.1

# WebSocket URL for browser (optional, auto-detected if not set)
# If behind SSL proxy, configure proxy to forward /dosdoor or use separate port
# DOSDOOR_WS_URL=wss://bbs.example.com:6001
# DOSDOOR_WS_URL=wss://bbs.example.com/dosdoor

# Headless mode for DOSBox (default: true)
# true = Run DOSBox headless (production)
# false = Show DOSBox window (debugging)
# DOSDOOR_HEADLESS=true

# Maximum simultaneous door sessions (concurrent players)
# Limits how many users can play door games at the same time
# Each session uses one node number (1 to MAX_SESSIONS)
# Each dosbox instance may take upwards of 100 MB RAM each in headless mode
DOSDOOR_MAX_SESSIONS=10

# Debug mode - keep session files for inspection (default: false)
# Set to 'true' to disable cleanup of DOOR.SYS and session directories
# Useful for debugging drop file generation and DOSBox config issues
# DOSDOOR_DEBUG_KEEP_FILES=false
```

### 4. Verify Database Schema

The door system requires these tables (created by `scripts/setup.php`):
- `door_sessions` - Active session tracking
- `door_session_logs` - Session event logging

Run setup if needed:
```bash
php scripts/setup.php
```

### 5. Test the System

Start the multiplexing bridge manually:
```bash
node scripts/dosbox-bridge/multiplexing-server.js
```

You should see:
```
=== DOSBox Door Bridge - Multiplexing Server ===
WebSocket Port: 6001
Bind Address: 127.0.0.1
TCP Port Range: 5000-5100
Disconnect Timeout: 0 minutes
Base Path: C:\devel\binktest
Database: binktest@localhost:5432/binktest

[WS] Server listening on 127.0.0.1:6001
[WS] Waiting for connections...

Bridge server started successfully!
Press Ctrl+C to stop.
```

Then visit your BBS and try launching a door game. The bridge will:
1. Authenticate your WebSocket connection
2. Allocate a TCP port dynamically (e.g., 5000)
3. Generate a DOSBox config for your session
4. Launch DOSBox which connects back to the bridge
5. Multiplex data between your browser and the door game

Press Ctrl+C to stop the bridge.

---

## Starting the Multiplexing Bridge

The bridge is a long-running process that should be started before users can play door games.

### Development / Testing

**Windows:**
```cmd
start-door-bridge.cmd
```

**Linux:**
```bash
./start-door-bridge.sh
```

The bridge will output:
```
=== DOSBox Door Bridge - Multiplexing Server ===
WebSocket Port: 6001
Bind Address: 127.0.0.1
Disconnect Timeout: 0 minutes
Database: binktest@localhost:5432/binktest

[WS] Server listening on 127.0.0.1:6001
[WS] Waiting for connections...

Bridge server started successfully!
Press Ctrl+C to stop.
```

### Production (Linux with systemd)

For production, run the bridge as a systemd service:

1. **Copy service file:**
```bash
sudo cp docs/dosdoor-bridge.service.example /etc/systemd/system/dosdoor-bridge.service
```

2. **Edit service file:**
```bash
sudo nano /etc/systemd/system/dosdoor-bridge.service
```

Update these fields:
- `User=` - Your application user (e.g., `binkterm`)
- `WorkingDirectory=` - Full path to binktest directory
- `ExecStart=` - Full path to multiplexing-server.js

3. **Enable and start:**
```bash
sudo systemctl daemon-reload
sudo systemctl enable dosdoor-bridge
sudo systemctl start dosdoor-bridge
```

4. **Check status:**
```bash
sudo systemctl status dosdoor-bridge
sudo journalctl -u dosdoor-bridge -f  # Follow logs
```

### Production (Linux with cron)

Alternatively, you can start the bridge via cron using `@reboot`:

```bash
# Edit crontab
crontab -e

# Add line to start bridge on boot
@reboot cd /path/to/binkterm && /usr/bin/node scripts/dosbox-bridge/multiplexing-server.js >> data/logs/dosdoor-bridge.log 2>&1
```

**Notes:**
- The bridge runs in the background and logs to `data/logs/dosdoor-bridge.log`
- Make sure the log directory exists: `mkdir -p /path/to/binkterm/data/logs`
- Verify the bridge started after reboot: `ps aux | grep multiplexing-server`
- To stop: `pkill -f multiplexing-server.js`
- For better process management, consider using systemd (above) or a process supervisor like PM2

### Production (Windows)

On Windows, run the bridge as a service using [NSSM](https://nssm.cc/) or similar:

```cmd
nssm install DOSBoxBridge "C:\Program Files\nodejs\node.exe" "C:\path\to\binktest\scripts\dosbox-bridge\multiplexing-server.js"
nssm set DOSBoxBridge AppDirectory "C:\path\to\binktest"
nssm start DOSBoxBridge
```

### Monitoring

The bridge logs status every 60 seconds:
```
[STATUS] Active sessions: 3
  - door_1_node1_123: 45s, WS:true, DOS:true
  - door_2_node2_456: 120s, WS:true, DOS:true
  - door_3_node3_789: 30s, WS:false, DOS:true
```

---

## Configuration

### DOSBox Configuration Files

**Production Config** (`dosbox-bridge-production.conf`):
- Headless mode (window positioned off-screen on Windows)
- Serial port configured for TCP connection
- Auto-exit when door closes
- Used by default for live BBS

**Test Config** (`dosbox-bridge-test.conf`):
- Visible window for debugging
- Same serial port settings
- Useful for testing door installations

**Custom Config:**
Create `dosbox-bridge-custom.conf` for your own settings:
```bash
# In .env:
DOSDOOR_CONFIG=dosbox-bridge-custom.conf
```

### Key DOSBox Settings

In your config file:

```ini
[sdl]
# Production: Window off-screen (Windows only)
windowposition=-2000,-2000

[serial]
# DOSBox connects TO bridge on dynamically allocated port
# Port number will be replaced by bridge with actual allocated port
# transparent:1 = Pass through control signals (required for FOSSIL)
# serial1_fossil=true = Enable built-in FOSSIL emulation
serial1=nullmodem server:127.0.0.1 port:5000 transparent:1
serial1_fossil=true

[autoexec]
# Mount DOS drive
mount c dosbox-bridge/dos
c:

# Door-specific commands will be appended here by the bridge
# The bridge reads the door manifest and generates:
# cd \doors\lord
# call start.bat 1
```

### Session Settings

Sessions are configured in `src/DoorSessionManager.php`:

```php
private const TCP_PORT_BASE = 5000;  // DOSBox serial ports: 5001-5100
private const WS_PORT_BASE = 6000;   // WebSocket ports: 6001-6100
private const MAX_SESSIONS = 100;    // Maximum concurrent sessions
```

**Session Expiration:**
- Default: 2 hours per session
- Configurable in `startSession()` method (line 101)
- Enforced by cleanup script

---

## Adding New Door Games

**Important Note:** BinktermPHP includes sample `dosdor.json` manifests and icons for popular door games (LORD, BRE, etc.) but does **not** include the actual door game files due to licensing restrictions. Sysops must download and install door game executables separately.

### Step 1: Prepare the Door Game

1. **Obtain the door game files**
   - Download from archives (e.g., https://www.bbsdoorarchive.com/)
   - Must be DOS-compatible (16-bit DOS executable or batch file)
   - Check licensing terms before installing

2. **Test locally first**
   - Extract to a test folder
   - Run in DOSBox manually to verify it works and to perform configuration.  From within an X Terminal, run `dosbox-bridge/dosdoor-maint.sh` to run DOSBox-X with the door system mounted.
   - Note the executable name and any configuration needed

### Step 2: Install to BinktermPHP

1. **Create door directory:**
   ```bash
   mkdir dosbox-bridge/dos/doors/yourdoor
   ```

2. **Copy door files:**
   ```bash
   cp -r /path/to/door/files/* dosbox-bridge/dos/doors/yourdoor/
   ```

3. **Create launch script** (optional but recommended):

   Create `dosbox-bridge/dos/doors/yourdoor/START.BAT`:
   ```batch
   @ECHO OFF
   REM %1 is the node number passed by BinktermPHP
   YOURDOOR.EXE DOOR%1.SYS
   ```

   Some doors may need different syntax:
   ```batch
   @ECHO OFF
   CALL YOURDOOR.BAT %1
   ```

### Step 3: Create Door Manifest

Create `dosbox-bridge/dos/doors/yourdoor/dosdor.json`:

```json
{
    "version": "1.0",
    "type": "dosdoor",
    "game": {
        "name": "Your Door Game",
        "short_name": "YDG",
        "author": "Author Name",
        "version": "1.0",
        "release_year": 1995,
        "description": "A classic BBS door game",
        "genre": ["Adventure", "RPG"],
        "players": "Multi-player",
        "icon": "icon.gif",
        "screenshot": "screenshot.png"
    },
    "door": {
        "type": "dos",
        "executable": "START.BAT",
        "launch_command": "call start.bat {node}",
        "directory": "dosbox-bridge/dos/doors/yourdoor",
        "dropfile_format": "DOOR.SYS",
        "max_nodes": 10,
        "fossil_required": true
    },
    "config": {
        "enabled": false,
        "credit_cost": 0,
        "max_time_minutes": 30
    }
}
```

**Manifest Field Reference:**
- `id`: Unique identifier (must match directory name)
- `name`: Display name shown to users
- `executable`: Main executable or batch file
- `launch_command`: Full command with {node} and {dropfile} macros
- `drop_file_format`: Currently only "DOOR.SYS" is supported
- `max_nodes`: Maximum concurrent players (1-100)
- `require_ansi`: Whether door requires ANSI support
- `fossil_required`: Load FOSSIL driver (default: `true`). Set to `false` for doors with internal comm routines (faster)

### Step 4: Enable the Door

1. **Scan for new doors:**
   The system automatically scans `dosbox-bridge/dos/doors/` for `dosdor.json` files

2. **Enable via admin panel:**
   - Login as admin
   - Navigate to Games → DOS Doors
   - Find your door in the list
   - Click "Enable"
   - Adjust settings if needed

3. **Or enable manually:**

   Edit `config/dosdoors.json`:
   ```json
   {
       "yourdoor": {
           "enabled": true,
           "name": "Your Door Game",
           "max_nodes": 10
       }
   }
   ```

### Step 5: Test the Door

1. **Launch the door** from the games menu
2. **Check for issues:**
   - Does it display properly?
   - Does input work correctly?
   - Does it save game state?
   - Does it exit cleanly?

3. **Review logs:**
   ```bash
   # Filter for DOSDOOR-prefixed logs
   tail -f data/logs/php-errors.log | grep DOSDOOR
   ```

### Example: Installing LORD

Note: We ship a working dosdor.json for LORD - the information below is for example only.

```bash
# 1. Create directory
mkdir dosbox-bridge/dos/doors/lord

# 2. Copy LORD files (from archive or existing installation)
cp -r /path/to/lord/* dosbox-bridge/dos/doors/lord/

# 3. Create START.BAT
cat > dosbox-bridge/dos/doors/lord/START.BAT << 'EOF'
@ECHO OFF
REM Launch Legend of the Red Dragon
REM %1 = node number from BinktermPHP
LORD.EXE DOOR%1.SYS
EOF

# 4. Create manifest
cat > dosbox-bridge/dos/doors/lord/dosdor.json << 'EOF'
{
    "version": "1.0",
    "id": "lord",
    "name": "Legend of the Red Dragon",
    "author": "Seth Able Robinson",
    "description": "Classic fantasy adventure door game",
    "executable": "START.BAT",
    "launch_command": "call start.bat {node}",
    "drop_file_format": "DOOR.SYS",
    "max_nodes": 10,
    "require_ansi": true,
    "fossil_required": false,
    "category": "game",
    "notes": "LORD uses internal comm routines - FOSSIL not required (faster performance)"
}
EOF

# 5. Enable via admin panel or config file
# 6. Test by launching from games menu
```

---

## Door Manifest Format

### Complete Manifest Specification

```json
{
    "version": "1.0",
    "type": "dosdoor",
    "game": {
        "name": "Display Name",
        "short_name": "Short",
        "author": "Author Name",
        "version": "1.0",
        "release_year": 1995,
        "description": "Description shown to users",
        "genre": ["Genre1", "Genre2"],
        "players": "Single-player or Multi-player",
        "icon": "icon.gif",
        "screenshot": "screenshot.png"
    },
    "door": {
        "type": "dos",
        "executable": "FILENAME.EXE",
        "launch_command": "call start.bat {node}",
        "directory": "dosbox-bridge/dos/doors/doorid",
        "dropfile_format": "DOOR.SYS",
        "dropfile_path": "\\doors\\doorid",
        "node_support": true,
        "max_nodes": 10,
        "fossil_required": true,
        "notes": "Optional notes about this door"
    },
    "requirements": {
        "dosbox": "dosbox-x"
    },
    "config": {
        "enabled": false,
        "credit_cost": 0,
        "max_time_minutes": 30
    }
}
```

### Field Descriptions

**game.icon** (string, optional):
- Filename of the door's icon image (displayed on games page)
- File must be placed in the door's directory alongside dosdor.json
- Supported formats: GIF, PNG, JPG, JPEG, SVG, BMP, ICO
- Served securely via `/door-assets/{doorid}/icon` endpoint
- Only assets declared in manifest can be accessed (security)
- Example: `"icon": "icon.gif"`

**game.screenshot** (string, optional):
- Filename of the door's screenshot image
- File must be placed in the door's directory alongside dosdor.json
- Supported formats: GIF, PNG, JPG, JPEG, SVG, BMP, ICO
- Served securely via `/door-assets/{doorid}/screenshot` endpoint
- Example: `"screenshot": "screenshot.png"`

**door.dropfile_path** (string, optional):
- Custom path where DOOR.SYS should be placed (for non-multi-node doors)
- Overrides default per-node drop file location
- Format: `"\\doors\\doorid"` (DOS path format)
- Use for doors that expect DOOR.SYS in their own directory
- Example: BRE expects DOOR.SYS in `\doors\bre\` not `\drops\node1\`

**fossil_required** (boolean, default: `true`):
- Controls whether the FOSSIL driver (BNU.COM) is loaded before launching the door
- `true`: Load FOSSIL driver (required for most DOS doors)
- `false`: Skip FOSSIL loading (for doors with internal comm routines)
- **Performance impact**:
  - FOSSIL loading adds ~100-200ms startup delay
  - Doors with internal routines (e.g., LORD) are noticeably faster without FOSSIL
  - Set to `false` only if you've verified the door works with internal comm routines
- **Memory impact**: FOSSIL driver uses ~30-50KB RAM per session

### Macro Replacements in launch_command

- `{node}`: Replaced with node number (1-100)
- `{dropfile}`: Replaced with drop file name (e.g., "DOOR1.SYS")

### Examples

**Simple executable:**
```json
{
    "launch_command": "doorgame.exe {dropfile}"
}
```

**Batch file with node:**
```json
{
    "launch_command": "call start.bat {node}"
}
```

**Direct executable with node:**
```json
{
    "launch_command": "lord.exe DOOR{node}.SYS"
}
```

---

## Door Assets (Icons & Screenshots)

The system supports custom icons and screenshots for each door game.

### Asset Security

**Important:** Only assets explicitly declared in the door manifest can be accessed. This prevents arbitrary file access within door directories.

**Allowed asset types:**
- `icon` - Door game icon (displayed on games page)
- `screenshot` - Door game screenshot

### Adding Assets

1. **Place asset files in door directory:**
   ```bash
   dosbox-bridge/dos/doors/lord/
   ├── dosdor.json
   ├── icon.gif          # Your icon file
   └── screenshot.png    # Your screenshot file
   ```

2. **Declare in manifest:**
   ```json
   {
       "game": {
           "name": "Legend of the Red Dragon",
           "icon": "icon.gif",
           "screenshot": "screenshot.png"
       }
   }
   ```

3. **Supported formats:**
   - GIF, PNG, JPG/JPEG, SVG, BMP, ICO
   - Recommended icon size: 64x64 pixels
   - Recommended screenshot size: 640x400 pixels

### Asset URLs

Assets are served via secure endpoints that verify manifest declarations:

```
/door-assets/{doorid}/icon        → Serves icon file from manifest
/door-assets/{doorid}/screenshot  → Serves screenshot file from manifest
```

**Examples:**
- `/door-assets/lord/icon` → Serves `icon.gif` (declared in LORD's manifest)
- `/door-assets/bre/screenshot` → Serves `screenshot.png` (declared in BRE's manifest)

### Browser Caching

Assets are served with 24-hour cache headers for performance:
```
Cache-Control: public, max-age=86400
```

---

## Troubleshooting

### Door Won't Launch

**Symptoms:** Clicking door does nothing, or shows "Connecting..." forever

**Check:**
1. Is the multiplexing bridge running? `ps aux | grep multiplexing-server` or check Task Manager
2. Is Node.js installed? `node --version`
3. Are npm dependencies installed? Check `node_modules/ws` and `node_modules/iconv-lite`
4. Is DOSBox-X installed? Check `DOSBOX_EXECUTABLE` in `.env`
5. Is WebSocket port available? Check for conflicts on port 6001 (TCP ports 5000-5100 are allocated dynamically)


### Door Launches But Nothing Displays

**Symptoms:** Terminal connects but shows blank screen

**Check:**
1. Is the door executable correct in `dosdor.json`?
2. Does the door exist in `dosbox-bridge/dos/doors/`?
3. Is the launch command correct?

**Debug:**
```bash
# Test DOSBox manually
# Edit dosbox-bridge-test.conf to add:
cd \doors\yourdoor
call start.bat 1

# Run DOSBox with visible window:
"C:\DOSBox-X\dosbox-x.exe" -conf dosbox-bridge-test.conf

# Watch for errors in DOSBox window
```


### Door Doesn't Save Game State

**Symptoms:** Player progress is lost between sessions

**Check:**
1. Does the door directory have write permissions?
   ```bash
   # Windows - Right click folder → Properties → Security
   # Linux
   chmod -R 775 dosbox-bridge/dos/doors/yourdoor
   ```

2. Is the door configured for multi-node operation?
   - Some doors need separate data files per node
   - Check door documentation for multi-node setup

3. Are drop files being generated correctly?
   ```bash
   # After launching, check:
   ls dosbox-bridge/dos/drops/nodeX/door.sys
   ```

### WebSocket Disconnects Immediately

**Symptoms:** "Connection closed" right after connecting

**Check:**
1. Disconnect timeout setting:
   ```bash
   # In .env:
   DOSDOOR_DISCONNECT_TIMEOUT=0  # Change to 5 for 5-minute grace period
   ```

2. Bridge server logs:
   ```bash
   # Bridge logs to console - check for errors
   # Look for [WS] messages
   ```

3. Firewall blocking WebSocket ports (6001-6100)

---

## Advanced Configuration

### Custom DOSBox Configurations

Create a custom config to preserve your changes across upgrades:

```bash
# 1. Copy production config
cp dosbox-bridge/dosbox-bridge-production.conf dosbox-bridge/dosbox-bridge-custom.conf

# 2. Edit your custom config
nano dosbox-bridge/dosbox-bridge-custom.conf

# 3. Set in .env
DOSDOOR_CONFIG=dosbox-bridge-custom.conf
```

**Common customizations:**

```ini
[cpu]
# Increase cycles for faster doors
cycles=20000

[serial]
# Adjust serial port settings if needed
serial1=nullmodem port:5001 transparent:1 telnet:1 rxdelay:0

[dos]
# Set XMS/EMS memory for doors that need it
xms=true
ems=true

[autoexec]
# Set DOS environment variables
set TEMP=C:\TEMP
set FOSSIL=ENABLED
```

### Disconnect Behavior Modes

The door system uses a **two-stage timeout process** when users disconnect:

**Stage 1: WebSocket Disconnect (DOSDOOR_DISCONNECT_TIMEOUT)**
- Controls whether to wait for user reconnection
- Measured in **minutes**
- Default: `0` (immediate carrier loss)

**Stage 2: Carrier Loss (DOSDOOR_CARRIER_LOSS_TIMEOUT)**
- Controls graceful shutdown of door process
- Measured in **milliseconds**
- Default: `5000` (5 seconds)

**Immediate Mode (Default):**
```bash
DOSDOOR_DISCONNECT_TIMEOUT=0
DOSDOOR_CARRIER_LOSS_TIMEOUT=5000
```
**Flow:**
1. User closes browser → WebSocket disconnects
2. Immediately close TCP socket (simulate carrier loss)
3. Wait 5 seconds for door to detect carrier loss and exit
4. If still running, force-kill the process

**Behavior:**
- Traditional BBS "lost carrier" behavior
- Quick cleanup, frees resources immediately
- Clean state, no confusion

**Grace Period Mode:**
```bash
DOSDOOR_DISCONNECT_TIMEOUT=5
DOSDOOR_CARRIER_LOSS_TIMEOUT=5000
```
**Flow:**
1. User closes browser → WebSocket disconnects
2. Wait 5 minutes for user to reconnect
3. If reconnected → Resume session seamlessly
4. If not reconnected → Close TCP socket (carrier loss)
5. Wait 5 seconds for door to exit gracefully
6. If still running, force-kill the process

**Behavior:**
- Good for mobile users with spotty connections
- Users can close/reopen browser without losing progress
- Uses more resources (processes stay alive during wait)

**Why Two Timeouts?**
- **DISCONNECT_TIMEOUT**: User convenience (reconnection grace period)
- **CARRIER_LOSS_TIMEOUT**: Door compatibility (cleanup grace period)
- Some doors need time to save state after carrier loss
- Prevents data loss from abrupt termination

### Session Duration

Edit `src/DoorSessionManager.php`:

```php
// Line ~101 in startSession()
'time_remaining' => 7200,  // 2 hours in seconds

// Line ~114
$expiresAt = date('Y-m-d H:i:s', time() + 7200);  // 2 hours
```

Change `7200` to your desired duration in seconds:
- 1800 = 30 minutes
- 3600 = 1 hour
- 7200 = 2 hours (default)
- 14400 = 4 hours

### Port Ranges

Edit `src/DoorSessionManager.php`:

```php
// Lines ~27-29
private const TCP_PORT_BASE = 5000;  // DOSBox ports: 5001-5100
private const WS_PORT_BASE = 6000;   // WebSocket ports: 6001-6100
private const MAX_SESSIONS = 100;    // Maximum concurrent sessions
```

**Note:** After changing ports, update firewall rules if needed.

### Credits System Integration

To charge credits for playing doors, edit the door manifest:

```json
{
    "id": "yourdoor",
    "name": "Your Door Game",
    "credits_cost": 10
}
```

Users will be charged 10 credits each time they launch the door.

Configure credit costs in Admin Panel → BBS Settings → Credits System.

---

## SSL/TLS and Reverse Proxy Configuration

For production deployments with HTTPS, use a reverse proxy (Caddy or nginx) to handle SSL termination.

### Architecture

```
Browser → HTTPS (wss://bbs.com:443) → [Caddy] → WebSocket (ws://127.0.0.1:6001) → [Bridge]
```

The multiplexing bridge binds to `127.0.0.1:6001` (localhost only). Caddy handles:
- SSL/TLS termination
- WebSocket upgrade
- Proxying to local bridge

### Configuration

**1. Set bind address to localhost:**

In `.env`:
```bash
DOSDOOR_WS_BIND_HOST=127.0.0.1  # Localhost only (DEFAULT)
```

**2. Configure WebSocket URL for browsers:**

In `.env`:
```bash
# Let browsers know where to connect
DOSDOOR_WS_URL=wss://bbs.example.com/dosdoor
```

If not set, auto-detects based on page protocol and hostname.

**3. Configure Caddy:**

Add to your Caddyfile:

```caddyfile
bbs.example.com {
    # DOS Door WebSocket endpoint
    handle /dosdoor {
        reverse_proxy 127.0.0.1:6001
    }

    # Main BBS traffic
    reverse_proxy 127.0.0.1:1244
}
```

Or use a separate port:

```caddyfile
bbs.example.com {
    reverse_proxy 127.0.0.1:1244
}

bbs.example.com:6001 {
    reverse_proxy 127.0.0.1:6001
}
```

**4. Configure nginx (alternative to Caddy):**

```nginx
upstream dosdoor_bridge {
    server 127.0.0.1:6001;
}

server {
    listen 443 ssl http2;
    server_name bbs.example.com;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    # DOS Door WebSocket
    location /dosdoor {
        proxy_pass http://dosdoor_bridge;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # Main BBS
    location / {
        proxy_pass http://127.0.0.1:1244;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### Testing SSL Configuration

1. **Start bridge:**
```bash
sudo systemctl start dosdoor-bridge
```

2. **Reload Caddy:**
```bash
sudo systemctl reload caddy
```

3. **Test WebSocket connection:**
```bash
# Install wscat if needed: npm install -g wscat
wscat -c "wss://bbs.example.com/dosdoor?token=test123"
```

You should see authentication error (expected - test token invalid) but connection should establish.

---

## Best Practices

### Security

1. **Validate door files** before installing - only install doors from trusted sources
2. **Limit door execution** to the `dosbox-bridge/dos/doors/` directory
3. **Review door configs** for potentially dangerous DOS commands
4. **Monitor logs** for suspicious activity
5. **Keep DOSBox-X updated** for security patches

### Performance

1. **Run cleanup script regularly** (every 10 minutes recommended)
2. **Monitor active sessions** - adjust `DOSDOOR_MAX_SESSIONS` in `.env` based on server capacity
3. **Set reasonable session timeouts** (2 hours default)
4. **Use immediate disconnect mode** (`DOSDOOR_DISCONNECT_TIMEOUT=0`) to free resources quickly
5. **Optimize FOSSIL loading** for faster door response:
   - Test if doors work without FOSSIL (internal comm routines)
   - Set `fossil_required: false` in manifest for doors that support it
   - Example: LORD performs significantly faster without FOSSIL
   - Result: Faster startup, lower memory usage, better user experience

### Reliability

1. **Test doors before making them public**
2. **Document door-specific requirements** (memory, special configs)
3. **Keep backups** of working door installations
4. **Monitor bridge server** for crashes or errors
5. **Set up automated cleanup** via Task Scheduler or cron

---

## Support & Resources

### Getting Help

- Review this documentation thoroughly
- Check door game documentation for specific requirements

### Useful Commands Reference

```bash
# Check active sessions
php test/check-db-sessions.php

# Verify processes
php test/verify-session-procs.php

# Clean up expired sessions
php scripts/cleanup_expired_dosdoor_sessions.php

# Kill all door processes
kill-all-door-procs.cmd

# Start multiplexing bridge
node scripts/dosbox-bridge/multiplexing-server.js

# Check WebSocket port in use
netstat -ano | findstr :6001

# Check dynamically allocated TCP ports
netstat -ano | findstr :500
```

---

*Last updated: February 2026*
