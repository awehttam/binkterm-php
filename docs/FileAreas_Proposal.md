# File Area System Proposal

**DRAFT DOCUMENT**: This proposal is a draft that was generated by AI and may not have been reviewed for accuracy. Implementation details may change based on technical constraints, security considerations, and user feedback.

---

## Executive Summary

This proposal outlines a comprehensive file area system for BinktermPHP that enables users to upload, download, and share files through both the web interface and Fidonet networking. The system includes virus scanning, credit-based economy integration, sysop approval workflows, and future support for Fidonet file requests (FREQ).

## Table of Contents

1. [Overview](#overview)
2. [Design Decisions](#design-decisions)
3. [Architecture](#architecture)
4. [Database Schema](#database-schema)
5. [Core Components](#core-components)
6. [API Endpoints](#api-endpoints)
7. [User Interface](#user-interface)
8. [Integration Points](#integration-points)the system 
9. [Security Considerations](#security-considerations)
10. [Implementation Roadmap](#implementation-roadmap)
11. [Future Enhancements](#future-enhancements)

---

## Overview

The file area system extends BinktermPHP's capabilities beyond message-based communication to include file distribution, similar to traditional BBS file bases. This feature enables:

- **User File Sharing**: Upload and download files through the web interface
- **Fidonet File Distribution**: Receive and distribute files via binkp protocol
- **Credit Economy**: Reward uploads and charge for downloads
- **Quality Control**: Sysop approval queue for user-uploaded content
- **Security**: Optional ClamAV virus scanning
- **Multi-Network Support**: File areas per network domain
- **Future FREQ Support**: Framework for Fidonet file request protocol

### Use Cases

1. **Software Distribution**: Share utilities, tools, and applications
2. **Document Libraries**: Technical documentation, guides, tutorials
3. **Media Sharing**: Images, music, videos (subject to size limits)
4. **Archive Preservation**: Historical BBS files, vintage software
5. **Network Collaboration**: Share files between Fidonet nodes
6. **User Contributions**: Allow users to upload content for community benefit

---

## Design Decisions

Based on stakeholder input and architectural review, the following design decisions have been made:

### 1. Credits Integration
**Decision**: Integrate with existing credit system
**Rationale**: Incentivizes quality uploads and prevents abuse of downloads
**Implementation**:
- Charge configurable credits per download
- Award configurable credits for approved uploads
- Use existing `UserCredit` class for consistency

### 2. Storage Structure
**Decision**: Organize by file area tag (`data/files/{area_tag}/{filename}`)
**Rationale**: Mirrors Fidonet file area structure, simplifies backup/management
**Benefits**:
- Easy to locate files for specific areas
- Supports area-level operations (archive, delete, backup)
- Aligns with Fidonet conventions

### 3. Metadata Tracking
**Decision**: Store both short and long descriptions plus download statistics
**Rationale**: Follows BBS tradition, provides user-friendly browsing
**Fields**:
- Short description (255 chars) - Quick summary
- Long description (unlimited) - Detailed information
- Download count, last download date
- Uploader information

### 4. File Request Support
**Decision**: Plan for both binkp FREQ and netmail-based requests
**Rationale**: Maximum compatibility with Fidonet ecosystem
**Phases**:
- Phase 1: Database schema and queue system (this proposal)
- Phase 2: Binkp M_GET frame handling
- Phase 3: Netmail command parsing

### 5. Virus Detection Strategy
**Decision**: Flag infected files with visual indicator, don't auto-delete
**Rationale**: Allows sysop review of false positives, maintains audit trail
**Workflow**:
- Scan uploads with ClamAV (optional)
- Mark infected files with status='quarantined'
- Move to `.quarantine/` directory
- Display prominent warning in approval queue
- Sysop makes final decision

### 6. Size Limits
**Decision**: Per-area configurable maximum file size
**Rationale**: Flexibility for different area purposes
**Examples**:
- Text files area: 1 MB limit
- General files: 10 MB limit
- Large archives: 100 MB limit
- Sysop-only area: Unlimited

### 7. Duplicate Handling
**Decision**: Reject duplicates with error message (no auto-rename)
**Rationale**: Prevents confusion, maintains file integrity
**Implementation**:
- Calculate SHA256 hash of uploaded file
- Check for existing file with same hash in same area
- Return error if duplicate found
- UNIQUE constraint: (file_area_id, file_hash)

### 8. File Type Control
**Decision**: Configurable blacklist per area (e.g., `.exe`, `.bat`)
**Rationale**: Security and content control flexibility
**Features**:
- Whitelist mode: `allowed_extensions` (e.g., `.txt,.zip,.pdf`)
- Blacklist mode: `blocked_extensions` (e.g., `.exe,.bat,.com`)
- Admin can configure per-area

---

## Architecture

### Architecture Pattern

The file area system follows existing BinktermPHP patterns for consistency:

| Component | Pattern Source | Similarity |
|-----------|----------------|------------|
| Database Schema | `echoareas` table | Multi-network support, subscriptions, domains |
| Approval Queue | `crashmail_queue` | Pending status, admin review, approval/rejection |
| Admin UI | `templates/echoareas.twig` | List view, modals, color coding |
| Queue Management | `templates/admin/crashmail_queue.twig` | Pending items, approve/reject actions |
| API Endpoints | `routes/admin-routes.php` | RESTful design, admin authentication |
| Credit Integration | Crashmail debit system | UserCredit class usage |

### System Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User Upload    â”‚
â”‚   (Web Form)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FileUploadHandler          â”‚
â”‚  - Validate size/extension  â”‚
â”‚  - Calculate SHA256 hash    â”‚
â”‚  - Check duplicates         â”‚
â”‚  - Scan virus (optional)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Store to disk              â”‚
â”‚  data/files/{tag}/{file}    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Create database record     â”‚
â”‚  status = 'pending'         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Admin Approval Queue       â”‚
â”‚  (FileApprovalController)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Approve â”‚ â”‚ Reject  â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚           â”‚
    â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Award   â”‚ â”‚ Notify   â”‚
â”‚Credits â”‚ â”‚ User     â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  File available for         â”‚
â”‚  download                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Download   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FileDownloadHandler        â”‚
â”‚  - Check subscription       â”‚
â”‚  - Check credits            â”‚
â”‚  - Deduct credits           â”‚
â”‚  - Log download             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stream file to user        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Database Schema

### Migration File
**Filename**: `database/migrations/v1.9.0_add_file_areas.sql`

### Table: `file_areas`

File distribution areas configuration (similar to `echoareas`).

```sql
CREATE TABLE file_areas (
    id SERIAL PRIMARY KEY,
    tag VARCHAR(255) NOT NULL,
    description TEXT,
    domain VARCHAR(255) NOT NULL DEFAULT 'fidonet',
    is_local BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    is_sysop_only BOOLEAN DEFAULT FALSE,
    color VARCHAR(7) DEFAULT '#007bff',

    -- File-specific settings
    max_file_size BIGINT DEFAULT 10485760, -- 10MB default
    allowed_extensions TEXT, -- Comma-separated: .txt,.zip,.pdf
    blocked_extensions TEXT, -- Comma-separated: .exe,.bat,.com
    download_credit_cost INTEGER DEFAULT 0,
    upload_credit_reward INTEGER DEFAULT 0,
    require_approval BOOLEAN DEFAULT TRUE,
    scan_virus BOOLEAN DEFAULT TRUE,

    -- Statistics
    file_count INTEGER DEFAULT 0,
    total_size BIGINT DEFAULT 0,
    download_count INTEGER DEFAULT 0,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT unique_tag_domain UNIQUE(tag, domain)
);
```

**Key Fields**:
- `tag`: File area identifier (e.g., GENERAL_FILES, SOFTWARE)
- `domain`: Network domain for multi-network support
- `is_local`: If true, files not transmitted to uplinks
- `max_file_size`: Maximum file size in bytes
- `require_approval`: If false, uploads auto-approved
- `scan_virus`: Enable ClamAV scanning for this area

### Table: `files`

File metadata and tracking.

```sql
CREATE TABLE files (
    id SERIAL PRIMARY KEY,
    file_area_id INTEGER NOT NULL REFERENCES file_areas(id) ON DELETE CASCADE,

    -- File information
    filename VARCHAR(255) NOT NULL,
    filesize BIGINT NOT NULL,
    file_hash VARCHAR(64) NOT NULL, -- SHA256
    storage_path TEXT NOT NULL,

    -- Upload information
    uploaded_by_user_id INTEGER REFERENCES users(id) ON DELETE SET NULL,
    uploaded_from_address VARCHAR(255), -- Fidonet address (e.g., 1:123/456)
    source_type VARCHAR(20) DEFAULT 'user', -- 'user', 'fidonet', 'freq'

    -- Descriptions
    short_description VARCHAR(255),
    long_description TEXT,

    -- Approval workflow
    status VARCHAR(20) DEFAULT 'pending', -- pending, approved, rejected, quarantined
    approved_by_user_id INTEGER REFERENCES users(id) ON DELETE SET NULL,
    approved_at TIMESTAMP,
    rejection_reason TEXT,

    -- Virus scanning
    virus_scanned BOOLEAN DEFAULT FALSE,
    virus_scan_result VARCHAR(20), -- clean, infected, error, skipped
    virus_signature VARCHAR(255), -- Name of detected virus
    virus_scanned_at TIMESTAMP,

    -- Download statistics
    download_count INTEGER DEFAULT 0,
    last_downloaded_at TIMESTAMP,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT unique_file_hash_per_area UNIQUE(file_area_id, file_hash)
);
```

**Key Fields**:
- `file_hash`: SHA256 hash for duplicate detection
- `source_type`: Track origin (user upload vs Fidonet)
- `status`: Workflow state (pending â†’ approved/rejected/quarantined)
- `virus_scan_result`: ClamAV scan outcome

### Table: `user_file_area_subscriptions`

Access control for file areas.

```sql
CREATE TABLE user_file_area_subscriptions (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    file_area_id INTEGER NOT NULL REFERENCES file_areas(id) ON DELETE CASCADE,
    subscription_type VARCHAR(20) DEFAULT 'read_write', -- read_only, read_write, upload_only
    is_active BOOLEAN DEFAULT TRUE,
    subscribed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT unique_user_file_area UNIQUE(user_id, file_area_id)
);
```

**Subscription Types**:
- `read_write`: Browse and upload (most common)
- `read_only`: Browse and download only
- `upload_only`: Upload only (rare, for contribution areas)

### Table: `file_downloads`

Download history and audit trail.

```sql
CREATE TABLE file_downloads (
    id SERIAL PRIMARY KEY,
    file_id INTEGER NOT NULL REFERENCES files(id) ON DELETE CASCADE,
    user_id INTEGER REFERENCES users(id) ON DELETE SET NULL,
    credits_charged INTEGER DEFAULT 0,
    ip_address INET,
    user_agent TEXT,
    downloaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Purpose**:
- Track who downloaded what and when
- Audit trail for credit charges
- Statistics for popular files
- Security monitoring

### Table: `file_requests`

File request queue (FREQ) - future implementation.

```sql
CREATE TABLE file_requests (
    id SERIAL PRIMARY KEY,
    request_type VARCHAR(20) NOT NULL, -- 'binkp_freq', 'netmail_command'
    requested_filename VARCHAR(255) NOT NULL,
    requesting_address VARCHAR(255), -- Fidonet address
    requesting_user_id INTEGER REFERENCES users(id) ON DELETE SET NULL,

    status VARCHAR(20) DEFAULT 'pending', -- pending, matched, sent, failed
    matched_file_id INTEGER REFERENCES files(id) ON DELETE SET NULL,

    password VARCHAR(255), -- FREQ password (if required)
    error_message TEXT,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    processed_at TIMESTAMP,
    sent_at TIMESTAMP
);
```

**Future Use**:
- Queue incoming FREQ requests
- Match requests to available files
- Track fulfillment status

### Indexes

```sql
-- Performance indexes
CREATE INDEX idx_files_file_area_id ON files(file_area_id);
CREATE INDEX idx_files_status ON files(status);
CREATE INDEX idx_files_hash ON files(file_hash);
CREATE INDEX idx_files_uploaded_by ON files(uploaded_by_user_id);
CREATE INDEX idx_files_virus_scan ON files(virus_scanned, virus_scan_result);

CREATE INDEX idx_subscriptions_user_id ON user_file_area_subscriptions(user_id);
CREATE INDEX idx_subscriptions_file_area_id ON user_file_area_subscriptions(file_area_id);

CREATE INDEX idx_downloads_file_id ON file_downloads(file_id);
CREATE INDEX idx_downloads_user_id ON file_downloads(user_id);
CREATE INDEX idx_downloads_date ON file_downloads(downloaded_at);

CREATE INDEX idx_requests_status ON file_requests(status);
CREATE INDEX idx_requests_address ON file_requests(requesting_address);
```

### Default Data

```sql
-- Create default file areas
INSERT INTO file_areas (tag, description, domain, is_local, color, max_file_size, download_credit_cost, upload_credit_reward) VALUES
('GENERAL_FILES', 'General purpose file area for miscellaneous files', 'fidonet', TRUE, '#007bff', 10485760, 10, 25),
('LOCALTEST_FILES', 'Testing area for local file uploads', 'fidonet', TRUE, '#6c757d', 5242880, 0, 0);
```

---

## Core Components

### 1. FileAreaManager

**File**: `src/FileAreaManager.php`
**Pattern**: Similar to `EchoareaSubscriptionManager.php`
**Purpose**: Business logic for file area management and subscriptions

#### Key Methods

```php
class FileAreaManager
{
    /**
     * Get all file areas user is subscribed to
     */
    public function getUserSubscribedFileAreas(int $userId): array;

    /**
     * Subscribe user to file area
     */
    public function subscribeUser(int $userId, int $fileAreaId, string $type = 'read_write'): bool;

    /**
     * Unsubscribe user from file area
     */
    public function unsubscribeUser(int $userId, int $fileAreaId): bool;

    /**
     * Check if user has access to file area
     */
    public function isUserSubscribed(int $userId, int $fileAreaId): bool;

    /**
     * Get file area details with statistics
     */
    public function getFileAreaWithStats(int $fileAreaId): ?array;

    /**
     * Get all file areas with statistics (admin)
     */
    public function getFileAreasWithStats(string $domain = 'fidonet'): array;

    /**
     * Create new file area (admin)
     */
    public function createFileArea(array $data): int;

    /**
     * Update file area (admin)
     */
    public function updateFileArea(int $id, array $data): bool;

    /**
     * Delete file area (admin)
     */
    public function deleteFileArea(int $id): bool;

    /**
     * Update file area statistics
     */
    public function updateStats(int $fileAreaId): void;
}
```

#### Responsibilities
- Subscription management
- Access control checks
- CRUD operations for file areas
- Statistics aggregation

---

### 2. FileUploadHandler

**File**: `src/FileUploadHandler.php`
**Pattern**: Similar to packet processing in `BinkdProcessor.php`
**Purpose**: Process and validate file uploads from users and Fidonet

#### Key Methods

```php
class FileUploadHandler
{
    /**
     * Handle user upload from web interface
     */
    public function handleUserUpload(
        int $fileAreaId,
        array $uploadedFile,
        int $userId,
        array $metadata
    ): array;

    /**
     * Handle file from Fidonet (binkp)
     */
    public function handleFidonetFile(
        int $fileAreaId,
        string $filePath,
        string $fromAddress,
        array $metadata
    ): array;

    /**
     * Validate file against area rules
     */
    protected function validateFile(array $fileArea, string $filePath): array;

    /**
     * Calculate SHA256 hash
     */
    protected function calculateFileHash(string $filePath): string;

    /**
     * Check for duplicate files
     */
    protected function isDuplicate(int $fileAreaId, string $hash): bool;

    /**
     * Move file to storage location
     */
    protected function moveToStorage(string $tempPath, string $areaTag, string $filename): string;

    /**
     * Create database record
     */
    protected function storeFileRecord(array $data): int;

    /**
     * Trigger virus scan
     */
    protected function scanForViruses(string $filePath): array;
}
```

#### Upload Workflow

1. **Validation**:
   - Check file size â‰¤ `max_file_size`
   - Validate extension against whitelist/blacklist
   - Calculate SHA256 hash
   - Check for duplicate hash in area

2. **Virus Scanning** (if enabled):
   - Call `VirusScanner::scanFile()`
   - If infected: status='quarantined', move to `.quarantine/`
   - If clean: continue to storage

3. **Storage**:
   - Move from temp to `data/files/{area_tag}/{filename}`
   - Set appropriate permissions (644)

4. **Database Record**:
   - Insert into `files` table
   - Set status='pending' (user) or 'approved' (Fidonet if auto-approve enabled)
   - Record uploader, source, descriptions

5. **Logging**:
   - Log upload via error_log or dedicated file logger
   - Log admin action if auto-approved

**Return**: `['success' => true, 'file_id' => 123]` or `['success' => false, 'error' => 'message']`

---

### 3. FileDownloadHandler

**File**: `src/FileDownloadHandler.php`
**Pattern**: Similar to credit deduction in crashmail
**Purpose**: Handle file downloads with credit integration

#### Key Methods

```php
class FileDownloadHandler
{
    /**
     * Initiate download process
     */
    public function initiateDownload(int $fileId, int $userId): array;

    /**
     * Check user has access to file area
     */
    protected function checkAccess(int $fileId, int $userId): bool;

    /**
     * Check user has sufficient credits
     */
    protected function checkCredits(int $fileId, int $userId): bool;

    /**
     * Deduct credits from user balance
     */
    protected function deductCredits(int $fileId, int $userId): bool;

    /**
     * Record download in history
     */
    protected function recordDownload(int $fileId, int $userId, int $creditsCharged): void;

    /**
     * Update file statistics
     */
    protected function updateDownloadStats(int $fileId): void;

    /**
     * Stream file to user
     */
    public function streamFile(int $fileId): void;
}
```

#### Download Workflow

1. **Access Check**:
   - Verify user subscribed to file area
   - Check file status = 'approved'
   - Verify file exists on disk

2. **Credit Check**:
   - Get `download_credit_cost` from file area
   - Check user balance via `UserCredit` class
   - If insufficient: return error

3. **Credit Deduction**:
   - Call `UserCredit::debit($userId, $cost, $description)`
   - Transaction description: "Downloaded: {filename}"

4. **Download Logging**:
   - Insert into `file_downloads` table
   - Record: file_id, user_id, credits_charged, IP, user agent, timestamp

5. **Statistics Update**:
   - Increment `files.download_count`
   - Update `files.last_downloaded_at`
   - Increment `file_areas.download_count`

6. **File Streaming**:
   - Set headers: Content-Type, Content-Disposition, Content-Length
   - Stream file in chunks (memory efficient)
   - Support resume/partial content (HTTP 206)

**Error Handling**:
- Insufficient credits: Return error, no charge
- File missing: Log error, refund if charged
- Download interrupted: No refund (user initiated)

---

### 4. VirusScanner

**File**: `src/VirusScanner.php`
**Purpose**: Optional ClamAV integration for virus detection

#### Key Methods

```php
class VirusScanner
{
    /**
     * Check if virus scanning is enabled
     */
    public static function isEnabled(): bool;

    /**
     * Scan file for viruses
     */
    public static function scanFile(string $filePath): array;

    /**
     * Update virus scan result in database
     */
    public static function updateVirusScanResult(int $fileId, array $result): void;

    /**
     * Get scanner status/version
     */
    public static function getStatus(): array;
}
```

#### Configuration

Environment variables in `.env`:

```bash
CLAMAV_ENABLED=false
CLAMAV_PATH=/usr/bin/clamdscan
CLAMAV_SOCKET=/var/run/clamav/clamd.ctl
CLAMAV_TIMEOUT=30
```

#### Scan Results

Return array structure:
```php
[
    'scanned' => true,
    'result' => 'clean|infected|error|skipped',
    'signature' => 'Win.Trojan.Eicar-1', // If infected
    'error' => 'Scanner timeout', // If error
    'scanned_at' => '2025-01-30 12:34:56'
]
```

**Result Values**:
- `clean`: No virus detected
- `infected`: Virus found (signature in 'signature' field)
- `error`: Scan failed (error in 'error' field)
- `skipped`: Scanning disabled

#### Implementation

```php
public static function scanFile(string $filePath): array
{
    if (!self::isEnabled()) {
        return ['scanned' => false, 'result' => 'skipped'];
    }

    $clamPath = getenv('CLAMAV_PATH') ?: '/usr/bin/clamdscan';
    $timeout = intval(getenv('CLAMAV_TIMEOUT') ?: 30);

    $command = escapeshellarg($clamPath) . ' --no-summary ' . escapeshellarg($filePath);

    exec($command, $output, $returnCode);

    // Return code 0 = clean, 1 = infected, 2 = error
    switch ($returnCode) {
        case 0:
            return ['scanned' => true, 'result' => 'clean', 'scanned_at' => date('Y-m-d H:i:s')];
        case 1:
            // Parse signature from output
            $signature = self::parseSignature($output);
            return [
                'scanned' => true,
                'result' => 'infected',
                'signature' => $signature,
                'scanned_at' => date('Y-m-d H:i:s')
            ];
        default:
            return [
                'scanned' => true,
                'result' => 'error',
                'error' => implode("\n", $output),
                'scanned_at' => date('Y-m-d H:i:s')
            ];
    }
}
```

**Testing**:
- Use EICAR test file for infected file testing
- ClamAV must be installed and running (`clamd` daemon)

---

### 5. FileApprovalController

**File**: `src/FileApprovalController.php`
**Pattern**: Similar to crashmail queue management
**Purpose**: Admin approval workflow for user uploads

#### Key Methods

```php
class FileApprovalController
{
    /**
     * Get pending files for approval
     */
    public function getPendingFiles(?int $fileAreaId = null, int $limit = 50): array;

    /**
     * Approve file
     */
    public function approveFile(int $fileId, int $adminUserId): bool;

    /**
     * Reject file
     */
    public function rejectFile(int $fileId, int $adminUserId, string $reason): bool;

    /**
     * Get approval statistics
     */
    public function getApprovalStats(): array;

    /**
     * Get file details for approval review
     */
    public function getFileDetails(int $fileId): ?array;
}
```

#### Approval Workflow

**Approve Action**:
1. Update `files` table:
   - Set status='approved'
   - Set approved_by_user_id=$adminUserId
   - Set approved_at=NOW()

2. Award Credits:
   - If source_type='user' and uploaded_by_user_id exists
   - Get upload_credit_reward from file area
   - Call `UserCredit::credit($userId, $amount, "File approved: {filename}", $adminUserId, UserCredit::TYPE_SYSTEM_REWARD)`

3. Update Statistics:
   - Increment `file_areas.file_count`
   - Add to `file_areas.total_size`

4. Log Action:
   - `AdminActionLogger::logAction($adminUserId, 'file_approved', ['file_id' => $fileId, 'filename' => $filename])`

5. Notify User (optional):
   - Send netmail notification
   - Or web notification

**Reject Action**:
1. Update `files` table:
   - Set status='rejected'
   - Set rejection_reason
   - Set approved_by_user_id=$adminUserId (who rejected)
   - Set approved_at=NOW() (when rejected)

2. File Handling Options:
   - Move to `.quarantine/` directory
   - Or delete from disk
   - Configurable via admin UI

3. Log Action:
   - `AdminActionLogger::logAction($adminUserId, 'file_rejected', ['file_id' => $fileId, 'reason' => $reason])`

4. Notify User:
   - Send rejection reason via netmail or web notification

#### Statistics

Return array:
```php
[
    'pending_count' => 15,
    'approved_today' => 8,
    'rejected_today' => 2,
    'quarantined_count' => 3,
    'total_pending_size' => 125829120 // bytes
]
```

---

### 6. FileAreaController

**File**: `src/FileAreaController.php`
**Purpose**: Web/API controller for user and admin endpoints

#### User Methods

```php
class FileAreaController
{
    /**
     * List file areas user has access to
     */
    public function handleListFileAreas(Request $request): Response;

    /**
     * Browse files in a specific area
     */
    public function handleBrowseArea(Request $request, int $fileAreaId): Response;

    /**
     * Upload file to area
     */
    public function handleUploadFile(Request $request, int $fileAreaId): Response;

    /**
     * Download file
     */
    public function handleDownloadFile(Request $request, int $fileId): Response;

    /**
     * Get file details
     */
    public function handleFileDetails(Request $request, int $fileId): Response;

    /**
     * Subscribe to file area
     */
    public function handleSubscribe(Request $request, int $fileAreaId): Response;

    /**
     * Unsubscribe from file area
     */
    public function handleUnsubscribe(Request $request, int $fileAreaId): Response;
}
```

#### Admin Methods

```php
/**
 * File area management page
 */
public function handleAdminFileAreas(Request $request): Response;

/**
 * Approval queue page
 */
public function handleApprovalQueue(Request $request): Response;

/**
 * CRUD operations (via API)
 */
public function handleCreateFileArea(Request $request): Response;
public function handleUpdateFileArea(Request $request, int $id): Response;
public function handleDeleteFileArea(Request $request, int $id): Response;

/**
 * Approval actions (via API)
 */
public function handleApproveFile(Request $request, int $fileId): Response;
public function handleRejectFile(Request $request, int $fileId): Response;
```

---

### 7. FileRequestHandler

**File**: `src/FileRequestHandler.php`
**Purpose**: Stub for future FREQ implementation

#### Planned Methods (Phase 2+)

```php
class FileRequestHandler
{
    /**
     * Create file request in queue
     */
    public function createRequest(array $requestData): int;

    /**
     * Process binkp FREQ (M_GET frame)
     */
    public function handleBinkpFreq(string $address, string $filename, ?string $password = null): array;

    /**
     * Process netmail file request command
     */
    public function handleNetmailFreq(int $netmailId): array;

    /**
     * Match request to available file
     */
    protected function matchFile(string $filename): ?int;

    /**
     * Verify FREQ password
     */
    protected function verifyFreqPassword(int $fileAreaId, string $password): bool;

    /**
     * Queue file for transmission
     */
    protected function queueFileTransmission(int $fileId, string $address): bool;
}
```

**Note**: This is a placeholder for future implementation. Phase 1 focuses on core upload/download functionality.

---

## API Endpoints

### User Endpoints

Add to `routes/api-routes.php`:

```php
// File area browsing
$router->get('/api/file-areas',
    [FileAreaController::class, 'handleListFileAreas']);

$router->get('/api/file-areas/{id}/files',
    [FileAreaController::class, 'handleBrowseArea']);

$router->get('/api/files/{id}',
    [FileAreaController::class, 'handleFileDetails']);

// File upload
$router->post('/api/file-areas/{id}/upload',
    [FileAreaController::class, 'handleUploadFile']);

// File download
$router->get('/api/files/{id}/download',
    [FileAreaController::class, 'handleDownloadFile']);

// Subscriptions
$router->post('/api/file-areas/{id}/subscribe',
    [FileAreaController::class, 'handleSubscribe']);

$router->post('/api/file-areas/{id}/unsubscribe',
    [FileAreaController::class, 'handleUnsubscribe']);
```

### Admin Endpoints

Add to `routes/admin-routes.php`:

```php
// File area management pages
$router->get('/admin/file-areas',
    [FileAreaController::class, 'handleAdminFileAreas']);

$router->get('/admin/file-approval',
    [FileAreaController::class, 'handleApprovalQueue']);

// File area CRUD API
$router->get('/admin/api/file-areas',
    [FileAreaController::class, 'handleListFileAreasAdmin']);

$router->post('/admin/api/file-areas',
    [FileAreaController::class, 'handleCreateFileArea']);

$router->put('/admin/api/file-areas/{id}',
    [FileAreaController::class, 'handleUpdateFileArea']);

$router->delete('/admin/api/file-areas/{id}',
    [FileAreaController::class, 'handleDeleteFileArea']);

// Approval queue API
$router->get('/admin/api/files/pending',
    [FileAreaController::class, 'handleGetPendingFiles']);

$router->post('/admin/api/files/{id}/approve',
    [FileAreaController::class, 'handleApproveFile']);

$router->post('/admin/api/files/{id}/reject',
    [FileAreaController::class, 'handleRejectFile']);

$router->get('/admin/api/files/stats',
    [FileAreaController::class, 'handleApprovalStats']);
```

### Request/Response Examples

#### Upload File (POST /api/file-areas/1/upload)

**Request**:
```http
POST /api/file-areas/1/upload HTTP/1.1
Content-Type: multipart/form-data

------WebKitFormBoundary
Content-Disposition: form-data; name="file"; filename="example.zip"
Content-Type: application/zip

[binary data]
------WebKitFormBoundary
Content-Disposition: form-data; name="short_description"

Useful utility for X
------WebKitFormBoundary
Content-Disposition: form-data; name="long_description"

This is a detailed description of the utility...
------WebKitFormBoundary--
```

**Response (Success)**:
```json
{
    "success": true,
    "file_id": 42,
    "message": "File uploaded successfully and awaiting approval",
    "status": "pending"
}
```

**Response (Error)**:
```json
{
    "success": false,
    "error": "File exceeds maximum size of 10MB"
}
```

#### Download File (GET /api/files/42/download)

**Response (Success)**:
```http
HTTP/1.1 200 OK
Content-Type: application/zip
Content-Disposition: attachment; filename="example.zip"
Content-Length: 1024000

[binary file stream]
```

**Response (Insufficient Credits)**:
```json
{
    "success": false,
    "error": "Insufficient credits. This download costs 20 credits, you have 15."
}
```

#### Approve File (POST /admin/api/files/42/approve)

**Request**:
```json
{
    "admin_user_id": 1
}
```

**Response**:
```json
{
    "success": true,
    "message": "File approved successfully",
    "credits_awarded": 25
}
```

---

## User Interface

### Admin Templates

#### 1. File Areas Management (`templates/admin/file_areas.twig`)

**Pattern**: Similar to `templates/echoareas.twig`

**Features**:
- List all file areas with statistics
- Color-coded area tags
- Add/Edit modal dialogs
- Delete confirmation
- Real-time updates via AJAX

**Layout**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ File Areas Management                    [+ Add Area]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Filter: [All â–¾] [Active] [Inactive]                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TAG              â”‚ DESC        â”‚ FILES â”‚ SIZE  â”‚ DL    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ GENERAL_FILES    â”‚ General...  â”‚ 145   â”‚ 2.1GB â”‚ 1,234 â”‚
â”‚ â—                â”‚ [Edit] [Del]â”‚       â”‚       â”‚       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SOFTWARE         â”‚ Software... â”‚ 78    â”‚ 890MB â”‚ 567   â”‚
â”‚ â—                â”‚ [Edit] [Del]â”‚       â”‚       â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Add/Edit Modal**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Add File Area                      [Ã—]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Tag:         [________________]         â”‚
â”‚ Description: [________________]         â”‚
â”‚ Domain:      [fidonet â–¾]                â”‚
â”‚ Color:       [#007bff] [ðŸŽ¨]            â”‚
â”‚                                         â”‚
â”‚ File Settings:                          â”‚
â”‚ Max Size:    [10] MB                    â”‚
â”‚ Allowed Ext: [.txt,.zip,.pdf]          â”‚
â”‚ Blocked Ext: [.exe,.bat,.com]          â”‚
â”‚                                         â”‚
â”‚ Credits:                                â”‚
â”‚ Download Cost:  [10] credits            â”‚
â”‚ Upload Reward:  [25] credits            â”‚
â”‚                                         â”‚
â”‚ Options:                                â”‚
â”‚ â˜‘ Active                                â”‚
â”‚ â˜ Local Only                            â”‚
â”‚ â˜ Sysop Only                            â”‚
â”‚ â˜‘ Require Approval                      â”‚
â”‚ â˜‘ Scan for Viruses                      â”‚
â”‚                                         â”‚
â”‚         [Cancel]  [Save Area]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### 2. File Approval Queue (`templates/admin/file_approval.twig`)

**Pattern**: Similar to `templates/admin/crashmail_queue.twig`

**Features**:
- List pending files
- Virus scan results prominently displayed
- File preview (images)
- Approve/Reject actions
- Statistics sidebar

**Layout**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ File Approval Queue                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚ â”‚ Statistics      â”‚                                             â”‚
â”‚ â”‚ Pending: 15     â”‚                                             â”‚
â”‚ â”‚ Approved: 8     â”‚                                             â”‚
â”‚ â”‚ Rejected: 2     â”‚                                             â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Filter by Area: [All â–¾]    Status: [All â–¾]                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ðŸ“„ example.zip (2.4 MB)                                   â”‚   â”‚
â”‚ â”‚ Area: GENERAL_FILES                                       â”‚   â”‚
â”‚ â”‚ Uploaded by: JohnDoe (user_id: 42) on 2025-01-30 10:23  â”‚   â”‚
â”‚ â”‚ From: 1:123/456.0                                        â”‚   â”‚
â”‚ â”‚                                                           â”‚   â”‚
â”‚ â”‚ âœ… Virus Scan: CLEAN (Scanned: 2025-01-30 10:23)        â”‚   â”‚
â”‚ â”‚                                                           â”‚   â”‚
â”‚ â”‚ Short: Useful utility for X                              â”‚   â”‚
â”‚ â”‚ Long: This is a detailed description...                  â”‚   â”‚
â”‚ â”‚                                                           â”‚   â”‚
â”‚ â”‚         [âœ“ Approve]  [âœ— Reject]                          â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ðŸ“„ suspicious.exe (142 KB)                                â”‚   â”‚
â”‚ â”‚ Area: SOFTWARE                                            â”‚   â”‚
â”‚ â”‚ Uploaded by: JaneSmith (user_id: 99) on 2025-01-30 11:45â”‚   â”‚
â”‚ â”‚                                                           â”‚   â”‚
â”‚ â”‚ âš ï¸  Virus Scan: INFECTED - Win.Trojan.Generic           â”‚   â”‚
â”‚ â”‚     Signature: Win.Trojan.Generic                        â”‚   â”‚
â”‚ â”‚                                                           â”‚   â”‚
â”‚ â”‚ Short: Productivity tool                                 â”‚   â”‚
â”‚ â”‚                                                           â”‚   â”‚
â”‚ â”‚         [âœ“ Approve]  [âœ— Reject]                          â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Virus Scan Display**:
- Green checkmark + "CLEAN" for clean files
- Red warning + "INFECTED" with signature for infected
- Yellow warning + "ERROR" if scan failed
- Gray "SKIPPED" if scanning disabled

**Reject Modal**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Reject File                        [Ã—]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Filename: suspicious.exe                â”‚
â”‚                                         â”‚
â”‚ Reason for rejection:                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ File contains malware detected by   â”‚ â”‚
â”‚ â”‚ virus scanner                       â”‚ â”‚
â”‚ â”‚                                     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚ Action:                                 â”‚
â”‚ â—‹ Move to quarantine                    â”‚
â”‚ â— Delete from disk                      â”‚
â”‚                                         â”‚
â”‚         [Cancel]  [Reject File]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### User Templates

#### 3. File Browsing (`templates/file_browse.twig`)

**Features**:
- Tabbed interface for file areas
- File list with icons and descriptions
- Download buttons with credit cost display
- Upload button
- Search and filter

**Layout**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ File Areas                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [GENERAL_FILES] [SOFTWARE] [DOCS]                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Search: [__________]  Sort: [Name â–¾]        [â¬† Upload File]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Your Balance: 150 credits                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ðŸ“„ example.zip (2.4 MB) - Downloaded 145 times                 â”‚
â”‚    Useful utility for X                                        â”‚
â”‚    [â¬‡ Download (10 credits)]                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ðŸ“„ another-file.txt (24 KB) - Downloaded 67 times              â”‚
â”‚    Text documentation for Y                                    â”‚
â”‚    [â¬‡ Download (5 credits)]                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ðŸ“„ large-archive.7z (45 MB) - Downloaded 12 times              â”‚
â”‚    Complete archive of Z                                       â”‚
â”‚    [â¬‡ Download (50 credits)] âš ï¸ Large file                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**File Icons**:
- ðŸ“„ Generic file
- ðŸ“¦ Archive (.zip, .rar, .7z)
- ðŸ“ Text file (.txt, .md)
- ðŸ–¼ï¸ Image (.jpg, .png, .gif)
- ðŸŽµ Audio (.mp3, .wav)
- ðŸŽ¬ Video (.mp4, .avi)

---

#### 4. File Upload (`templates/file_upload.twig`)

**Features**:
- Drag-and-drop file picker
- Description fields
- Progress bar
- Upload status

**Layout**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Upload File                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ File Area: [GENERAL_FILES â–¾]                                   â”‚
â”‚                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚                                                           â”‚   â”‚
â”‚ â”‚         ðŸ“ Drag and drop file here                       â”‚   â”‚
â”‚ â”‚              or click to browse                          â”‚   â”‚
â”‚ â”‚                                                           â”‚   â”‚
â”‚ â”‚         Max size: 10 MB                                  â”‚   â”‚
â”‚ â”‚         Allowed: .txt, .zip, .pdf                        â”‚   â”‚
â”‚ â”‚                                                           â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚ Short Description (255 chars):                                 â”‚
â”‚ [_________________________________________________________]     â”‚
â”‚                                                                 â”‚
â”‚ Long Description:                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚                                                         â”‚     â”‚
â”‚ â”‚                                                         â”‚     â”‚
â”‚ â”‚                                                         â”‚     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                 â”‚
â”‚ Reward: 25 credits upon approval                               â”‚
â”‚                                                                 â”‚
â”‚                                    [Cancel]  [Upload File]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Upload Progress**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Uploading: example.zip                  â”‚
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 65%         â”‚
â”‚ 1.5 MB / 2.4 MB                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Success Message**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… Upload Successful                    â”‚
â”‚                                         â”‚
â”‚ Your file has been uploaded and is      â”‚
â”‚ awaiting approval by a sysop.           â”‚
â”‚                                         â”‚
â”‚ You will receive 25 credits once        â”‚
â”‚ approved.                               â”‚
â”‚                                         â”‚
â”‚              [OK]                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Integration Points

### 1. BinkpSession.php Integration

**File**: `src/Binkp/Protocol/BinkpSession.php`
**Location**: `handleFileFrame()` method (around line 743)

**Current Behavior**:
- Receives M_FILE frame from binkp session
- Saves all files to inbound directory
- Only processes .pkt files

**New Behavior**:
- Distinguish between .pkt files and other files
- Route non-packet files to FileUploadHandler
- Determine target file area based on filename or configuration

**Implementation**:

```php
protected function handleFileFrame($filename, $fileData)
{
    $inboundPath = $this->config->getInboundPath();
    $tempPath = $inboundPath . '/' . $filename;

    // Save to temp location first
    file_put_contents($tempPath, $fileData);

    if (str_ends_with(strtolower($filename), '.pkt')) {
        // Existing packet processing
        $this->logger->info("Received packet: $filename");
        // ... existing packet handling code
    } else {
        // NEW: File area processing
        $this->logger->info("Received file: $filename from {$this->remoteAddress}");

        try {
            $fileHandler = new \BinktermPHP\FileUploadHandler();

            // Determine target file area (could be from filename pattern, config, etc.)
            $fileAreaId = $this->determineFileArea($filename);

            $result = $fileHandler->handleFidonetFile(
                $fileAreaId,
                $tempPath,
                $this->remoteAddress,
                [
                    'domain' => $this->getCurrentDomain(),
                    'session_id' => $this->sessionId
                ]
            );

            if ($result['success']) {
                $this->logger->info("File processed successfully: file_id={$result['file_id']}");
                // Optionally send acknowledgment back
            } else {
                $this->logger->error("File processing failed: {$result['error']}");
            }

        } catch (\Exception $e) {
            $this->logger->error("File handling exception: " . $e->getMessage());
        }
    }
}

/**
 * Determine target file area for incoming file
 * TODO: This could be enhanced with routing rules, filename patterns, etc.
 */
protected function determineFileArea(string $filename): int
{
    // Simple implementation: use GENERAL_FILES for now
    // Future: Could check routing table, filename patterns, etc.

    $db = \BinktermPHP\Database::getInstance()->getPdo();
    $stmt = $db->prepare("SELECT id FROM file_areas WHERE tag = ? AND is_active = TRUE LIMIT 1");
    $stmt->execute(['GENERAL_FILES']);
    $area = $stmt->fetch(\PDO::FETCH_ASSOC);

    if ($area) {
        return $area['id'];
    }

    throw new \Exception("No active file area found for incoming file");
}
```

**File Area Routing** (Future Enhancement):

Could be enhanced with routing table:
```sql
CREATE TABLE file_area_routing (
    id SERIAL PRIMARY KEY,
    from_address VARCHAR(255), -- Pattern like "1:123/*"
    filename_pattern VARCHAR(255), -- Pattern like "*.txt"
    target_file_area_id INTEGER REFERENCES file_areas(id),
    priority INTEGER DEFAULT 0
);
```

---

### 2. BinkdProcessor.php Integration

**File**: `src/BinkdProcessor.php`

**Purpose**: Process files from inbound directory

**New Method**:

```php
/**
 * Process non-packet files from inbound directory
 */
public function processInboundFiles(): void
{
    $allFiles = glob($this->inboundPath . '/*');
    if ($allFiles === false) {
        return;
    }

    // Filter out .pkt files (already handled by processInbound)
    $pktFiles = glob($this->inboundPath . '/*.pkt') ?: [];
    $otherFiles = array_diff($allFiles, $pktFiles);

    foreach ($otherFiles as $filePath) {
        if (!is_file($filePath) || is_dir($filePath)) {
            continue;
        }

        try {
            $this->processFileAreaFile($filePath);
        } catch (\Exception $e) {
            error_log("Error processing file {$filePath}: " . $e->getMessage());
        }
    }
}

/**
 * Process a single file area file
 */
protected function processFileAreaFile(string $filePath): void
{
    $filename = basename($filePath);

    // Determine file area (simple implementation)
    $db = Database::getInstance()->getPdo();
    $stmt = $db->prepare("SELECT id FROM file_areas WHERE tag = ? AND is_active = TRUE LIMIT 1");
    $stmt->execute(['GENERAL_FILES']);
    $area = $stmt->fetch(\PDO::FETCH_ASSOC);

    if (!$area) {
        error_log("No active file area found for: $filename");
        return;
    }

    $fileHandler = new FileUploadHandler();
    $result = $fileHandler->handleFidonetFile(
        $area['id'],
        $filePath,
        'unknown', // Address not available in batch processing
        ['domain' => 'fidonet']
    );

    if ($result['success']) {
        error_log("File processed successfully: $filename (file_id={$result['file_id']})");
        // Remove from inbound after successful processing
        unlink($filePath);
    } else {
        error_log("File processing failed: $filename - {$result['error']}");
    }
}
```

**Integration Point**:

Modify the main processing loop or create a separate cron job:

```php
// In scripts/binkp_poll.php or similar
$processor = new BinktermPHP\BinkdProcessor();
$processor->processInbound(); // Existing packet processing
$processor->processInboundFiles(); // NEW: File area processing
```

---

### 3. UserCredit Integration

**Purpose**: Award credits for approved uploads, charge for downloads

#### Download Credit Deduction

**File**: `src/FileDownloadHandler.php`

```php
use BinktermPHP\UserCredit;

protected function deductCredits(int $fileId, int $userId): bool
{
    $file = $this->getFileDetails($fileId);
    $fileArea = $this->getFileArea($file['file_area_id']);

    $cost = $fileArea['download_credit_cost'];

    if ($cost <= 0) {
        return true; // Free download
    }

    return UserCredit::debit(
        $userId,
        $cost,
        "Downloaded: {$file['filename']}",
        null, // No source user
        UserCredit::TYPE_PAYMENT
    );
}
```

#### Upload Credit Reward

**File**: `src/FileApprovalController.php`

```php
use BinktermPHP\UserCredit;

public function approveFile(int $fileId, int $adminUserId): bool
{
    $file = $this->getFileDetails($fileId);

    // Only award credits for user uploads (not Fidonet)
    if ($file['source_type'] === 'user' && $file['uploaded_by_user_id']) {
        $fileArea = $this->getFileArea($file['file_area_id']);
        $reward = $fileArea['upload_credit_reward'];

        if ($reward > 0) {
            UserCredit::credit(
                $file['uploaded_by_user_id'],
                $reward,
                "File approved: {$file['filename']}",
                $adminUserId,
                UserCredit::TYPE_SYSTEM_REWARD
            );
        }
    }

    // Update file status
    $db = Database::getInstance()->getPdo();
    $stmt = $db->prepare("
        UPDATE files
        SET status = 'approved',
            approved_by_user_id = ?,
            approved_at = NOW(),
            updated_at = NOW()
        WHERE id = ?
    ");
    $stmt->execute([$adminUserId, $fileId]);

    // Update file area stats
    $this->updateFileAreaStats($file['file_area_id']);

    return true;
}
```

---

### 4. AdminActionLogger Integration

**Purpose**: Audit trail for all file area admin actions

**Actions to Log**:

```php
use BinktermPHP\AdminActionLogger;

// File area created
AdminActionLogger::logAction($userId, 'file_area_created', [
    'tag' => $tag,
    'domain' => $domain,
    'max_file_size' => $maxFileSize
]);

// File area updated
AdminActionLogger::logAction($userId, 'file_area_updated', [
    'file_area_id' => $id,
    'tag' => $tag,
    'changes' => $changedFields
]);

// File area deleted
AdminActionLogger::logAction($userId, 'file_area_deleted', [
    'file_area_id' => $id,
    'tag' => $tag
]);

// File approved
AdminActionLogger::logAction($adminUserId, 'file_approved', [
    'file_id' => $fileId,
    'filename' => $filename,
    'uploader_id' => $uploaderId,
    'credits_awarded' => $creditsAwarded
]);

// File rejected
AdminActionLogger::logAction($adminUserId, 'file_rejected', [
    'file_id' => $fileId,
    'filename' => $filename,
    'uploader_id' => $uploaderId,
    'reason' => $rejectionReason
]);

// File quarantined (virus detected)
AdminActionLogger::logAction($adminUserId, 'file_quarantined', [
    'file_id' => $fileId,
    'filename' => $filename,
    'virus_signature' => $signature
]);
```

---

## Security Considerations

### 1. File Extension Blacklist

**Implementation**:

```php
protected function validateExtension(string $filename, array $fileArea): bool
{
    $extension = strtolower(pathinfo($filename, PATHINFO_EXTENSION));

    // Check blacklist
    if (!empty($fileArea['blocked_extensions'])) {
        $blocked = array_map('trim', explode(',', $fileArea['blocked_extensions']));
        $blocked = array_map('strtolower', $blocked);

        if (in_array('.' . $extension, $blocked) || in_array($extension, $blocked)) {
            return false;
        }
    }

    // Check whitelist (if configured)
    if (!empty($fileArea['allowed_extensions'])) {
        $allowed = array_map('trim', explode(',', $fileArea['allowed_extensions']));
        $allowed = array_map('strtolower', $allowed);

        if (!in_array('.' . $extension, $allowed) && !in_array($extension, $allowed)) {
            return false;
        }
    }

    return true;
}
```

**Default Blacklist**:
- Executables: `.exe`, `.bat`, `.com`, `.cmd`, `.scr`, `.pif`
- Scripts: `.vbs`, `.js`, `.wsf`, `.hta`
- System files: `.sys`, `.dll`, `.drv`

---

### 2. Path Traversal Prevention

**Implementation**:

```php
protected function sanitizeFilename(string $filename): string
{
    // Remove path components
    $filename = basename($filename);

    // Remove dangerous characters
    $filename = preg_replace('/[^a-zA-Z0-9._-]/', '_', $filename);

    // Prevent hidden files
    $filename = ltrim($filename, '.');

    // Ensure not empty
    if (empty($filename)) {
        $filename = 'file_' . bin2hex(random_bytes(8));
    }

    return $filename;
}

protected function moveToStorage(string $tempPath, string $areaTag, string $filename): string
{
    // Sanitize area tag
    $areaTag = preg_replace('/[^a-zA-Z0-9_-]/', '', $areaTag);

    // Sanitize filename
    $filename = $this->sanitizeFilename($filename);

    // Build safe storage path
    $storagePath = realpath(__DIR__ . '/../data/files') . '/' . $areaTag . '/' . $filename;

    // Verify path is within allowed directory
    $allowedBase = realpath(__DIR__ . '/../data/files');
    if (!str_starts_with($storagePath, $allowedBase)) {
        throw new \Exception("Invalid storage path detected");
    }

    // Create directory if needed
    $areaDir = $allowedBase . '/' . $areaTag;
    if (!is_dir($areaDir)) {
        mkdir($areaDir, 0755, true);
    }

    // Move file
    if (!rename($tempPath, $storagePath)) {
        throw new \Exception("Failed to move file to storage");
    }

    // Set permissions
    chmod($storagePath, 0644);

    return $storagePath;
}
```

---

### 3. Access Control

**Subscription Checks**:

```php
protected function checkAccess(int $fileId, int $userId): bool
{
    $db = Database::getInstance()->getPdo();

    $stmt = $db->prepare("
        SELECT f.id, fa.is_sysop_only
        FROM files f
        JOIN file_areas fa ON f.file_area_id = fa.id
        LEFT JOIN user_file_area_subscriptions sub ON fa.id = sub.file_area_id AND sub.user_id = ?
        WHERE f.id = ? AND f.status = 'approved'
    ");
    $stmt->execute([$userId, $fileId]);
    $result = $stmt->fetch(\PDO::FETCH_ASSOC);

    if (!$result) {
        return false; // File not found or not approved
    }

    // Check if sysop-only and user is not sysop
    if ($result['is_sysop_only']) {
        // Check if user is sysop
        $userStmt = $db->prepare("SELECT is_sysop FROM users WHERE id = ?");
        $userStmt->execute([$userId]);
        $user = $userStmt->fetch(\PDO::FETCH_ASSOC);

        if (!$user || !$user['is_sysop']) {
            return false;
        }
    }

    // Check subscription
    $subStmt = $db->prepare("
        SELECT id FROM user_file_area_subscriptions
        WHERE user_id = ? AND file_area_id = (SELECT file_area_id FROM files WHERE id = ?)
        AND is_active = TRUE
    ");
    $subStmt->execute([$userId, $fileId]);

    return $subStmt->fetch() !== false;
}
```

---

### 4. Credit Balance Checks

**Pre-Download Validation**:

```php
protected function checkCredits(int $fileId, int $userId): array
{
    $file = $this->getFileDetails($fileId);
    $fileArea = $this->getFileArea($file['file_area_id']);

    $cost = $fileArea['download_credit_cost'];

    if ($cost <= 0) {
        return ['sufficient' => true, 'cost' => 0, 'balance' => null];
    }

    $balance = UserCredit::getBalance($userId);

    return [
        'sufficient' => $balance >= $cost,
        'cost' => $cost,
        'balance' => $balance,
        'shortage' => max(0, $cost - $balance)
    ];
}
```

---

### 5. Virus Scanning

See **VirusScanner** component above.

**Key Security Points**:
- Scan before making file available
- Quarantine infected files immediately
- Don't auto-delete (allow sysop review)
- Update virus definitions regularly
- Timeout protection (30 seconds default)

---

### 6. Audit Logging

**All Critical Actions Logged**:
- File uploads (user, file, size, timestamp)
- File downloads (user, file, credits, IP)
- Admin approvals/rejections
- File area changes
- Virus detections

**Example Log Queries**:

```sql
-- Recent file uploads
SELECT f.filename, u.username, f.created_at
FROM files f
LEFT JOIN users u ON f.uploaded_by_user_id = u.id
ORDER BY f.created_at DESC
LIMIT 50;

-- Download history for file
SELECT u.username, fd.downloaded_at, fd.ip_address
FROM file_downloads fd
JOIN users u ON fd.user_id = u.id
WHERE fd.file_id = ?
ORDER BY fd.downloaded_at DESC;

-- Virus detections
SELECT f.filename, f.virus_signature, f.virus_scanned_at
FROM files f
WHERE f.virus_scan_result = 'infected'
ORDER BY f.virus_scanned_at DESC;
```

---

## Implementation Roadmap

### Phase 1: Foundation (Week 1)

**Tasks**:
1. Create database migration `v1.9.0_add_file_areas.sql`
2. Run migration and verify tables created
3. Create directory structure (`data/files/`, `.quarantine/`, etc.)
4. Create `FileAreaManager` class
5. Create `FileUploadHandler` class (basic validation)
6. Create `FileDownloadHandler` class (basic download)
7. Unit tests for core classes

**Deliverables**:
- Working database schema
- Core class functionality
- Basic upload/download flow

---

### Phase 2: Web Interface (Week 2)

**Tasks**:
1. Create API endpoints (user routes)
2. Create admin API endpoints
3. Create `FileAreaController`
4. Create admin templates (file_areas.twig, file_approval.twig)
5. Create user templates (file_browse.twig, file_upload.twig)
6. Create JavaScript files (file_areas.js, file_approval.js, file_browse.js)
7. CSS styling for file area pages

**Deliverables**:
- Working admin interface
- Working user interface
- AJAX-based interactions

---

### Phase 3: Advanced Features (Week 3)

**Tasks**:
1. Implement `VirusScanner` class
2. Configure ClamAV integration
3. Implement `FileApprovalController`
4. Add credit integration (UserCredit)
5. Add admin action logging (AdminActionLogger)
6. File area subscription management
7. Download statistics and tracking

**Deliverables**:
- Virus scanning functional
- Credit economy integrated
- Approval workflow complete
- Statistics tracking

---

### Phase 4: Fidonet Integration (Week 4)

**Tasks**:
1. Modify `BinkpSession.php` for file handling
2. Modify `BinkdProcessor.php` for batch processing
3. Implement file area routing logic
4. Test receiving files via binkp
5. Auto-approval for Fidonet sources
6. File area routing table (optional)

**Deliverables**:
- Files received via binkp processed correctly
- Auto-approval for trusted nodes
- Routing logic functional

---

### Phase 5: Testing & Documentation (Week 5)

**Tasks**:
1. End-to-end testing (see test plan below)
2. Security audit (penetration testing)
3. Performance testing (large files, many users)
4. Documentation: UPGRADING_1.9.0.md
5. Documentation: Update FAQ.md
6. Update recent_updates.twig changelog
7. Bug fixes and refinements

**Deliverables**:
- Complete test coverage
- Documentation complete
- Production-ready system

---

### Phase 6: Future Enhancements (Post-Release)

**Planned Features**:
1. Binkp FREQ protocol (M_GET frame)
2. Netmail file request commands
3. File area statistics dashboard
4. Automatic file aging/archival
5. File tagging and categories
6. Thumbnail generation for images
7. File versioning system
8. Bandwidth quotas per user
9. File area mirroring between nodes
10. Advanced routing rules

---

## Testing Plan

### Unit Tests

**FileAreaManager Tests**:
- Create/update/delete file areas
- Subscription management
- Access control checks
- Statistics aggregation

**FileUploadHandler Tests**:
- File size validation
- Extension validation
- Duplicate detection (hash)
- Path traversal prevention
- Filename sanitization

**FileDownloadHandler Tests**:
- Access control
- Credit checks
- Credit deduction
- Download logging
- File streaming

**VirusScanner Tests**:
- Clean file detection
- Infected file detection (EICAR)
- Error handling
- Timeout handling

---

### Integration Tests

**Upload Flow**:
1. User uploads valid file â†’ status='pending'
2. Virus scan runs â†’ result='clean'
3. File stored in correct directory
4. Database record created
5. Admin sees file in approval queue

**Approval Flow**:
1. Admin approves file
2. User awarded credits
3. File status='approved'
4. File appears in browse list
5. Download statistics initialized

**Download Flow**:
1. User initiates download
2. Access checked
3. Credits checked and deducted
4. Download logged
5. Statistics updated
6. File streamed to user

**Fidonet Flow**:
1. File received via binkp
2. Routed to correct file area
3. Auto-approved (if configured)
4. Available for download immediately

---

### End-to-End Tests

**Test Scenario 1: User Upload to Approval to Download**

1. Login as regular user
2. Navigate to file upload page
3. Select GENERAL_FILES area
4. Upload test.txt (1 KB)
5. Add descriptions
6. Submit upload
7. Verify status: "Awaiting approval"
8. Logout

9. Login as admin
10. Navigate to approval queue
11. See test.txt in pending list
12. Review file details
13. Approve file
14. Verify user awarded credits
15. Logout

16. Login as different user (with credits)
17. Navigate to file browse
18. See test.txt in GENERAL_FILES
19. Click download
20. Verify credit deduction
21. Verify file downloaded correctly

**Expected Results**:
- Upload successful
- Approval workflow correct
- Credits awarded/deducted correctly
- File download successful
- All statistics updated

---

**Test Scenario 2: Virus Detection**

1. Login as user
2. Upload EICAR test file
3. Verify virus scan detects infection
4. Verify file status='quarantined'
5. Verify file moved to .quarantine/

6. Login as admin
7. See prominent virus warning in approval queue
8. Review virus signature
9. Reject file with reason
10. Verify file not available for download

**Expected Results**:
- Virus detected correctly
- File quarantined
- Admin notified
- Rejection logged

---

**Test Scenario 3: Insufficient Credits**

1. Login as user with 10 credits
2. Attempt to download file costing 20 credits
3. Verify error: "Insufficient credits"
4. Verify no download
5. Verify no credit deduction
6. Verify download not logged

**Expected Results**:
- Download blocked
- Clear error message
- No credit charge
- No false statistics

---

**Test Scenario 4: Duplicate Detection**

1. Upload file: example.zip
2. Approve and publish
3. Attempt to upload same file again (same hash)
4. Verify error: "Duplicate file exists"
5. Verify no database record created
6. Verify no duplicate file on disk

**Expected Results**:
- Duplicate detected
- Upload rejected
- No duplicate storage

---

**Test Scenario 5: Access Control**

1. Create sysop-only file area
2. Upload file to that area
3. Login as regular user
4. Verify area not visible in browse list
5. Attempt direct URL access to file
6. Verify access denied

7. Login as sysop
8. Verify area visible
9. Verify download allowed

**Expected Results**:
- Regular users blocked
- Sysops have access
- No security bypass

---

## Future Enhancements

### Phase 2: File Request (FREQ) Support

**Binkp FREQ Protocol**:
- Implement M_GET frame handling in BinkpSession
- Match requested filenames to file_areas
- Queue files for transmission
- Support password-protected FREQ
- Implement file request limits (rate limiting)

**Netmail File Requests**:
- Parse netmail body for FREQ commands
- Support commands: REQUEST, FREQ, SENDFILE
- Respond with availability status
- Queue files for next binkp session

**Database Extensions**:
```sql
-- Already created in Phase 1
CREATE TABLE file_requests (
    ...
);

-- Add routing rules
CREATE TABLE file_freq_rules (
    id SERIAL PRIMARY KEY,
    file_area_id INTEGER REFERENCES file_areas(id),
    require_password BOOLEAN DEFAULT FALSE,
    password_hash VARCHAR(255),
    max_requests_per_day INTEGER DEFAULT 10,
    max_file_size BIGINT,
    allowed_addresses TEXT -- Comma-separated patterns
);
```

---

### Phase 3: Statistics Dashboard

**Features**:
- Top downloaded files
- Most active uploaders
- File area popularity
- Credit economy statistics
- Virus detection trends
- Storage usage graphs

**Implementation**:
- New template: `templates/admin/file_statistics.twig`
- Chart.js for visualizations
- API endpoint: `/admin/api/file-stats`

---

### Phase 4: File Aging & Archival

**Features**:
- Auto-archive files not downloaded in X days
- Move old files to archive area
- Delete files older than X days (configurable)
- Sysop notifications before deletion

**Configuration**:
```php
// Per file area
'auto_archive_days' => 180, // Move to archive after 180 days
'auto_delete_days' => 365,  // Delete after 1 year
'notify_before_delete' => true
```

---

### Phase 5: File Tagging & Categories

**Features**:
- User-defined tags (e.g., "utility", "game", "documentation")
- Category browsing
- Tag-based search
- Tag clouds

**Database**:
```sql
CREATE TABLE file_tags (
    id SERIAL PRIMARY KEY,
    tag_name VARCHAR(50) UNIQUE NOT NULL
);

CREATE TABLE file_tag_assignments (
    file_id INTEGER REFERENCES files(id) ON DELETE CASCADE,
    tag_id INTEGER REFERENCES file_tags(id) ON DELETE CASCADE,
    PRIMARY KEY (file_id, tag_id)
);
```

---

### Phase 6: Thumbnail Generation

**Features**:
- Auto-generate thumbnails for images
- Preview for videos (first frame)
- PDF preview (first page)
- Archive content listing (.zip, .rar)

**Implementation**:
- GD library or ImageMagick for image processing
- Store thumbnails in `data/files/.thumbnails/`
- Lazy loading in file browse interface

---

### Phase 7: File Versioning

**Features**:
- Upload new version of existing file
- Keep version history
- Download specific versions
- Compare versions

**Database**:
```sql
ALTER TABLE files ADD COLUMN version INTEGER DEFAULT 1;
ALTER TABLE files ADD COLUMN parent_file_id INTEGER REFERENCES files(id);
```

---

### Phase 8: Bandwidth Quotas

**Features**:
- Daily/weekly/monthly download limits per user
- Quota tracking
- Reset schedules
- Quota exceeded notifications

**Database**:
```sql
CREATE TABLE user_bandwidth_quotas (
    user_id INTEGER PRIMARY KEY REFERENCES users(id),
    daily_limit BIGINT DEFAULT 104857600, -- 100 MB
    weekly_limit BIGINT,
    monthly_limit BIGINT,
    current_period_usage BIGINT DEFAULT 0,
    period_start TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

### Phase 9: File Area Mirroring

**Features**:
- Designate file areas for mirroring
- Automatically send new files to linked nodes
- Receive mirrored files from uplinks
- Conflict resolution

**Configuration**:
```sql
CREATE TABLE file_area_mirrors (
    id SERIAL PRIMARY KEY,
    file_area_id INTEGER REFERENCES file_areas(id),
    remote_address VARCHAR(255), -- Fidonet address
    direction VARCHAR(10), -- 'send', 'receive', 'both'
    is_active BOOLEAN DEFAULT TRUE
);
```

---

## Conclusion

This proposal outlines a comprehensive file area system for BinktermPHP that:

1. **Enhances User Experience**: Modern web interface for file sharing
2. **Maintains BBS Tradition**: Classic file base features with credit economy
3. **Ensures Security**: Virus scanning, approval workflows, access control
4. **Integrates Seamlessly**: Works with existing code patterns and architecture
5. **Supports Growth**: Extensible design for future FREQ and advanced features

**Key Benefits**:
- âœ… Multi-network file distribution
- âœ… Credit-based economy integration
- âœ… Virus protection with ClamAV
- âœ… Sysop approval workflow
- âœ… Download statistics and tracking
- âœ… Fidonet file reception via binkp
- âœ… Future FREQ protocol support
- âœ… Scalable storage architecture

**Implementation Timeline**: 5 weeks for core features, ongoing enhancements

**Risk Mitigation**:
- Follows existing code patterns (low integration risk)
- Incremental rollout (Phase 1 â†’ 2 â†’ 3...)
- Extensive testing plan
- Security audit before production

---

## Appendix: Configuration Examples

### .env Configuration

```bash
# File Area Settings
FILES_MAX_UPLOAD_SIZE=10485760          # 10MB default
FILES_AUTO_APPROVE_FIDONET=true         # Auto-approve from trusted nodes
FILES_QUARANTINE_INFECTED=true          # Move infected to .quarantine/
FILES_DEFAULT_DOWNLOAD_COST=10          # Default credits per download
FILES_DEFAULT_UPLOAD_REWARD=25          # Default credits per approved upload

# ClamAV Virus Scanning (optional)
CLAMAV_ENABLED=false
CLAMAV_PATH=/usr/bin/clamdscan
CLAMAV_SOCKET=/var/run/clamav/clamd.ctl
CLAMAV_TIMEOUT=30

# File Area Routing (future)
FILES_AUTO_ROUTE_ENABLED=false
FILES_ROUTING_CONFIG=/path/to/routing.json
```

### File Area Routing Configuration (Future)

**File**: `config/file_routing.json`

```json
{
    "routes": [
        {
            "from_address": "1:123/*",
            "filename_pattern": "*.txt",
            "target_area": "TEXT_FILES",
            "priority": 1
        },
        {
            "from_address": "*",
            "filename_pattern": "*",
            "target_area": "GENERAL_FILES",
            "priority": 99
        }
    ]
}
```

---

## Appendix: SQL Schema Summary

**Complete schema available in**: `database/migrations/v1.9.0_add_file_areas.sql`

**Tables Created**:
1. `file_areas` - File distribution areas (8 rows expected initially)
2. `files` - File metadata (grows over time)
3. `user_file_area_subscriptions` - Access control (per user/area)
4. `file_downloads` - Download history (audit trail)
5. `file_requests` - FREQ queue (future use)

**Total Storage Estimate**:
- Database: ~100 MB for 10,000 files
- Files: Varies (configurable limits)
- Thumbnails: ~50 MB for 10,000 images (future)

---

**Document Version**: 1.0
**Last Updated**: 2025-01-30
**Status**: DRAFT - Pending Review
