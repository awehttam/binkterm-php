# Community Wireless Node List (CWN) WebDoor Proposal

**Status:** DRAFT
**Generated:** 2026-01-31
**Version:** 1.0

---

## âš ï¸ Disclaimer

This proposal is a **draft** and was **generated by AI**. It may not have been reviewed for accuracy or completeness. All architectural decisions, security considerations, and implementation details should be reviewed by the development team and system administrators before implementation.

---

## Executive Summary

The Community Wireless Node List (CWN) is a WebDoor that allows users to discover and share interesting community wireless networks. These include independent networks that provide local content beyond simple internet access - such as local mesh networks, wireless BBS systems, community networks, and other grassroots wireless infrastructure.

### Key Objectives

- Provide a searchable directory of community wireless networks
- Enable users to contribute network discoveries
- Display networks on an interactive map
- Encourage exploration and documentation of community networks
- Integrate with the BBS credits economy

### Architecture Philosophy

**Self-Contained WebDoor:** All code lives within `public_html/webdoors/cwn/` - no modifications to core BinktermPHP code required. The webdoor is completely modular and can be installed/removed without touching the main codebase.

### Scope

**Version 1.0 (This Proposal):** Local-only implementation
- Networks stored in local database
- Users submit and search networks
- Map display and search functionality
- Credit integration

**Future Versions:**
- Network federation (possibly via HTTP API instead of Fidonet)
- Inter-BBS sharing of network data
- Master node coordination

---

## Use Cases

### Primary Use Cases

1. **Network Discovery**
   - User searches for community networks in their area
   - Map shows nearby networks with details
   - User learns about local wireless infrastructure

2. **Network Submission**
   - User discovers a community wireless network
   - Submits network details (SSID, location, description, password if applicable)
   - Earns credits for contribution
   - Network appears on map for other users

3. **Network Documentation**
   - Community builds a comprehensive directory
   - Networks include descriptions of services/content
   - Historical record of community wireless infrastructure

4. **Network Maintenance**
   - User visits previously documented network
   - Finds network is offline or changed
   - Updates or removes listing

### Example Networks

- **Local Mesh Networks:** Community-run mesh networks with local services
- **Wireless BBS Systems:** BBSs accessible via WiFi
- **Community WiFi:** Free public WiFi with local content portals
- **Event Networks:** Temporary networks at hacker/maker spaces, conferences
- **Experimental Networks:** Amateur radio data networks, LoRa networks
- **Community ISPs:** Small independent wireless internet providers with local services

---

## Features

### Core Functionality

1. **Network Submission**
   - Add new network with: SSID, latitude, longitude, description, optional password
   - Earn 3 credits per submission
   - Instant publication (no moderation queue)
   - Users can edit their own submissions
   - Users can delete their own submissions

2. **Network Display**
   - Interactive map showing all networks
   - Markers at network locations
   - Click marker to view network details
   - Color-coded by network type or recency

3. **Search & Filter**
   - Search by location (city, address, coordinates)
   - Find networks within radius of location
   - Filter by network characteristics
   - Search costs 1 credit per query

4. **Network Details**
   - SSID (network name)
   - Location (latitude/longitude, plus reverse-geocoded address)
   - Description (what makes this network interesting)
   - WiFi Password (if public network)
   - Date added
   - Date last verified/updated
   - Submitting user
   - Submitting BBS (for future federation)

### User Experience

- **Geolocation:** Automatically detect user's location to show nearby networks
- **Mobile-Friendly:** Responsive design for use in the field
- **Simple Interface:** Easy to submit from a phone while near a network
- **Credits Integration:** Clear display of credit costs/earnings

---

## Database Schema

### Migration `v1.8.9_add_cwn_webdoor.sql`

```sql
-- Community Wireless Networks table
CREATE TABLE IF NOT EXISTS cwn_networks (
    id SERIAL PRIMARY KEY,
    ssid VARCHAR(100) NOT NULL,
    latitude DECIMAL(10, 3) NOT NULL,  -- WGS84, 3 decimal places (~111m precision)
    longitude DECIMAL(10, 3) NOT NULL,
    description TEXT NOT NULL,
    wifi_password VARCHAR(100),        -- Optional, for public networks
    network_type VARCHAR(50),          -- mesh, bbs, community, experimental, etc.
    submitted_by INT NOT NULL REFERENCES users(id),
    submitted_by_username VARCHAR(50) NOT NULL,
    bbs_name VARCHAR(50) NOT NULL,     -- For future federation
    date_added TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    date_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    date_verified TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- Composite unique constraint on SSID + location
    UNIQUE(ssid, latitude, longitude)
);

-- Search history for analytics
CREATE TABLE IF NOT EXISTS cwn_searches (
    id SERIAL PRIMARY KEY,
    user_id INT NOT NULL REFERENCES users(id),
    search_type VARCHAR(50),           -- location, radius, keyword
    search_query TEXT,
    results_count INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Usage tracking
CREATE TABLE IF NOT EXISTS cwn_sessions (
    id SERIAL PRIMARY KEY,
    user_id INT NOT NULL REFERENCES users(id),
    session_started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    session_ended_at TIMESTAMP,
    actions_taken INT DEFAULT 0,       -- Number of submissions/searches
    credits_earned INT DEFAULT 0,
    credits_spent INT DEFAULT 0
);

-- Indexes for performance
CREATE INDEX IF NOT EXISTS idx_cwn_networks_location ON cwn_networks(latitude, longitude);
CREATE INDEX IF NOT EXISTS idx_cwn_networks_active ON cwn_networks(is_active, date_added DESC);
CREATE INDEX IF NOT EXISTS idx_cwn_networks_user ON cwn_networks(submitted_by);
CREATE INDEX IF NOT EXISTS idx_cwn_searches_user ON cwn_searches(user_id, created_at DESC);
```

### Network Types

Suggested network types (user-selectable or free-form):
- `mesh` - Mesh network
- `bbs` - Wireless BBS
- `community` - Community WiFi
- `experimental` - Experimental/research
- `event` - Temporary event network
- `isp` - Community ISP
- `other` - Other/uncategorized

---

## WebDoor Configuration

### WebDoor Manifest (`public_html/webdoors/cwn/webdoor.json`)

```json
{
    "name": "Community Wireless Node List",
    "shortName": "CWN",
    "version": "1.0.0",
    "author": "BinktermPHP",
    "description": "Discover and share community wireless networks - mesh networks, wireless BBSs, and grassroots wireless infrastructure",
    "icon": "fa-wifi",
    "entryPoint": "index.html",
    "capabilities": [
        "credits",
        "geolocation",
        "map_display"
    ],
    "requirements": {
        "minAccountAge": 0,
        "minLoginCount": 1,
        "requiresApproval": false
    },
    "config": {
        "credits": {
            "submission_reward": 3,
            "search_cost": 1,
            "edit_cost": 0,
            "delete_cost": 0
        },
        "limits": {
            "max_submissions_per_day": 20,
            "max_searches_per_day": 50,
            "max_description_length": 500
        },
        "map": {
            "default_zoom": 10,
            "cluster_radius": 50,
            "tile_provider": "openstreetmap"
        }
    },
    "api": {
        "endpoints": [
            "GET /webdoors/cwn/api.php?action=list",
            "GET /webdoors/cwn/api.php?action=get&id={id}",
            "POST /webdoors/cwn/api.php?action=submit",
            "PUT /webdoors/cwn/api.php?action=update&id={id}",
            "DELETE /webdoors/cwn/api.php?action=delete&id={id}",
            "POST /webdoors/cwn/api.php?action=search"
        ]
    }
}
```

---

## API Endpoints

### Network Management

#### List Networks

```
GET /webdoors/cwn/api.php?action=list
```

**Query Parameters:**
- `limit` (default: 100, max: 500)
- `offset` (default: 0)
- `active_only` (default: true)
- `bbox` - Bounding box: `min_lat,min_lon,max_lat,max_lon`

**Response:**
```json
{
    "networks": [
        {
            "id": 1,
            "ssid": "MeshNet_Downtown",
            "latitude": 40.712,
            "longitude": -74.006,
            "description": "Downtown mesh network with local file sharing and chat",
            "wifi_password": null,
            "network_type": "mesh",
            "submitted_by_username": "user123",
            "bbs_name": "YourBBS",
            "date_added": "2026-01-15T10:30:00Z",
            "date_verified": "2026-01-15T10:30:00Z",
            "is_active": true
        }
    ],
    "total": 1,
    "limit": 100,
    "offset": 0
}
```

#### Get Network Details

```
GET /webdoors/cwn/api.php?action=get&id={id}
```

**Response:** Single network object (same structure as list item)

#### Submit Network

```
POST /webdoors/cwn/api.php?action=submit
```

**Request Body:**
```json
{
    "ssid": "Community_WiFi_Park",
    "latitude": 40.758,
    "longitude": -73.985,
    "description": "Free WiFi at Central Park with local news portal",
    "wifi_password": "publicwifi2026",
    "network_type": "community"
}
```

**Response:**
```json
{
    "success": true,
    "network_id": 42,
    "credits_earned": 3,
    "message": "Network submitted successfully"
}
```

**Validation:**
- SSID: 1-100 characters, required
- Latitude: -90 to 90, 3 decimal places, required
- Longitude: -180 to 180, 3 decimal places, required
- Description: 10-500 characters, required
- WiFi Password: Optional, max 100 characters
- Network Type: Optional, max 50 characters

**Errors:**
- 400: Validation error
- 402: Insufficient credits (if we add submission cost later)
- 409: Duplicate network (same SSID + location)
- 429: Rate limit exceeded

#### Update Network

```
PUT /webdoors/cwn/api.php?action=update&id={id}
```

**Authorization:** User must be the original submitter

**Request Body:** Same as POST (partial updates allowed)

**Response:**
```json
{
    "success": true,
    "message": "Network updated successfully"
}
```

#### Delete Network

```
DELETE /webdoors/cwn/api.php?action=delete&id={id}
```

**Authorization:** User must be the original submitter OR admin

**Response:**
```json
{
    "success": true,
    "message": "Network deleted successfully"
}
```

### Search & Discovery

#### Search Networks

```
POST /webdoors/cwn/api.php?action=search
```

**Cost:** 1 credit per search

**Request Body:**
```json
{
    "type": "radius",
    "latitude": 40.758,
    "longitude": -73.985,
    "radius_km": 5,
    "filters": {
        "network_type": "mesh",
        "has_password": false
    }
}
```

**Search Types:**
- `radius` - Find networks within X km of coordinates
- `bbox` - Find networks in bounding box
- `keyword` - Search descriptions/SSIDs

**Response:**
```json
{
    "success": true,
    "results": [...],
    "count": 15,
    "credits_spent": 1,
    "search_id": 123
}
```

#### Get Nearby Networks (Geolocation)

```
GET /webdoors/cwn/api.php?action=search
POST body: {"type": "radius", "latitude": lat, "longitude": lon, "radius_km": km}
```

**Cost:** 1 credit

**Response:** Same as search

---

## Web Interface

### File Structure

```
public_html/webdoors/cwn/
â”œâ”€â”€ webdoor.json          # Manifest
â”œâ”€â”€ index.html            # Main UI (entry point)
â”œâ”€â”€ api.php               # All backend logic (API endpoints, database, validation)
â”œâ”€â”€ css/
â”‚   â””â”€â”€ cwn.css          # Styles
â”œâ”€â”€ js/
â”‚   â”œâ”€â”€ cwn.js           # Main application logic
â”‚   â””â”€â”€ map.js           # Map functionality
â””â”€â”€ assets/
    â””â”€â”€ icons/           # Network type icons
```

**Important:** All code is self-contained within the webdoor directory. No modifications to core BinktermPHP code (`src/`) are needed.

### User Interface Design

#### Main View

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Community Wireless Node List        Credits: 145  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  [Search Location...]  [ðŸ“ Use My Location]        â”‚
â”‚  [Filter: All Types â–¼]  [Radius: 5km â–¼]           â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                              â”‚  â”‚
â”‚  â”‚          Interactive Map                     â”‚  â”‚
â”‚  â”‚                                              â”‚  â”‚
â”‚  â”‚     ðŸ“ You are here                          â”‚  â”‚
â”‚  â”‚                                              â”‚  â”‚
â”‚  â”‚     ðŸ“¡ (markers for networks)                â”‚  â”‚
â”‚  â”‚                                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                     â”‚
â”‚  [âž• Submit New Network]                           â”‚
â”‚                                                     â”‚
â”‚  Recent Networks:                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ðŸ“¡ MeshNet_Downtown                          â”‚  â”‚
â”‚  â”‚    Downtown mesh with local services         â”‚  â”‚
â”‚  â”‚    Distance: 0.5 km â€¢ Added: 2 days ago     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ðŸ“¡ Community_WiFi_Park                       â”‚  â”‚
â”‚  â”‚    Free WiFi with local portal               â”‚  â”‚
â”‚  â”‚    Distance: 1.2 km â€¢ Added: 1 week ago     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Network Details Modal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ðŸ“¡ MeshNet_Downtown           [âœ•]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  SSID: MeshNet_Downtown             â”‚
â”‚  Type: Mesh Network                 â”‚
â”‚                                     â”‚
â”‚  ðŸ“ Location:                       â”‚
â”‚  40.712, -74.006                    â”‚
â”‚  123 Main St, New York, NY          â”‚
â”‚                                     â”‚
â”‚  ðŸ“ Description:                    â”‚
â”‚  Downtown mesh network with local   â”‚
â”‚  file sharing, chat services, and   â”‚
â”‚  community bulletin board.          â”‚
â”‚                                     â”‚
â”‚  ðŸ” Password: (none - open network) â”‚
â”‚                                     â”‚
â”‚  â„¹ï¸ Submitted by: user123@YourBBS   â”‚
â”‚  ðŸ“… Added: Jan 15, 2026             â”‚
â”‚  âœ“ Last verified: Jan 15, 2026      â”‚
â”‚                                     â”‚
â”‚  [ðŸ—ºï¸ Get Directions]                â”‚
â”‚  [âœï¸ Edit] [ðŸ—‘ï¸ Delete]             â”‚
â”‚  (if you submitted it)              â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Submission Form

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Submit New Network            [âœ•]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  Network Name (SSID):               â”‚
â”‚  [_____________________________]    â”‚
â”‚                                     â”‚
â”‚  Location:                          â”‚
â”‚  Latitude:  [_________]             â”‚
â”‚  Longitude: [_________]             â”‚
â”‚  [ðŸ“ Use Current Location]          â”‚
â”‚  [ðŸ—ºï¸ Pick on Map]                   â”‚
â”‚                                     â”‚
â”‚  Network Type:                      â”‚
â”‚  [Mesh Network        â–¼]            â”‚
â”‚                                     â”‚
â”‚  Description:                       â”‚
â”‚  [_____________________________]    â”‚
â”‚  [_____________________________]    â”‚
â”‚  [_____________________________]    â”‚
â”‚  (10-500 characters)                â”‚
â”‚                                     â”‚
â”‚  WiFi Password (optional):          â”‚
â”‚  [_____________________________]    â”‚
â”‚  â˜ This network is open/public      â”‚
â”‚                                     â”‚
â”‚  ðŸ’° You will earn 3 credits         â”‚
â”‚                                     â”‚
â”‚  [Cancel]  [Submit Network]         â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Map Implementation

**Map Library:** Leaflet.js (open source, lightweight)

**Tile Provider:** OpenStreetMap (free, no API key required)

**Features:**
- Cluster markers when zoomed out (using MarkerCluster plugin)
- Custom icons for different network types
- Popup on marker click showing network summary
- "Get Directions" link to Google/Apple Maps
- Geolocation button to center on user
- Drawing tool for radius search

**Map Controls:**
- Zoom in/out
- Full screen toggle
- Layer selector (different map styles)
- Geolocation button
- Search box

---

## Credits Integration

### Credit Transactions

| Action | Cost/Reward | Notes |
|--------|-------------|-------|
| Submit network | **+3 credits** | Reward for contribution |
| Search networks | **-1 credit** | Per search query |
| Edit own network | Free | Encourage maintenance |
| Delete own network | Free | User control |
| View network details | Free | Encourage exploration |
| Browse map | Free | Open discovery |

### Transaction Logging

All credit transactions logged via `UserCredit::addTransaction()`:

```php
// Submission reward
UserCredit::addTransaction(
    $userId,
    3,
    'cwn_submission',
    "Submitted network: {$ssid}"
);

// Search cost
UserCredit::addTransaction(
    $userId,
    -1,
    'cwn_search',
    "Searched networks near {$location}"
);
```

### Insufficient Credits Handling

- **Search:** User must have at least 1 credit to search
- **Error Message:** "Insufficient credits. You need 1 credit to search. Earn credits by submitting networks!"
- **Display:** Show current credit balance prominently

---

## Validation & Security

### Input Validation

**SSID:**
- Length: 1-100 characters
- Allow: alphanumeric, spaces, hyphens, underscores
- Trim whitespace
- Check for SQL injection patterns

**Coordinates:**
- Latitude: -90.000 to 90.000
- Longitude: -180.000 to 180.000
- Format: Decimal degrees with 3 decimal places
- Validate: Must be valid numbers

**Description:**
- Length: 10-500 characters
- Allow: UTF-8 text
- Strip HTML tags
- Check for spam patterns

**WiFi Password:**
- Optional field
- Length: 0-100 characters if provided
- No special validation (any characters allowed)

### Rate Limiting

- **Submissions:** Maximum 20 per user per day
- **Searches:** Maximum 50 per user per day
- **Edits:** Maximum 10 per user per day

### Spam Prevention

**Basic Checks:**
- Detect duplicate submissions (same user, similar SSID/location)
- Flag excessive submissions from single user
- Check for URL spam in descriptions
- Review if user submits >10 networks in one session

**Admin Tools:**
- View all submissions by user
- Bulk delete by user
- Flag suspicious patterns
- Disable user's WebDoor access

### Authorization

- **Submit:** Any authenticated user
- **Edit:** Original submitter only (or admin)
- **Delete:** Original submitter only (or admin)
- **View:** Any authenticated user

---

## Implementation Plan

### Phase 1: Database & Backend (Week 1)

**Tasks:**
- [ ] Create database migration
- [ ] Create API endpoints (CRUD)
- [ ] Implement credit integration
- [ ] Add rate limiting
- [ ] Input validation
- [ ] Unit tests for API

**Deliverables:**
- Working API endpoints
- Database schema in place
- Credit transactions working

### Phase 2: WebDoor Frontend (Week 2)

**Tasks:**
- [ ] Create WebDoor manifest
- [ ] Build HTML interface
- [ ] Implement map display (Leaflet.js)
- [ ] Network submission form
- [ ] Network details view
- [ ] Edit/delete functionality

**Deliverables:**
- Functional web interface
- Interactive map
- Submission workflow complete

### Phase 3: Search & Discovery (Week 3)

**Tasks:**
- [ ] Implement geolocation
- [ ] Radius search
- [ ] Keyword search
- [ ] Filter by network type
- [ ] Nearby networks display
- [ ] Search results optimization

**Deliverables:**
- Working search functionality
- Geolocation integration
- User can find nearby networks

### Phase 4: Polish & Testing (Week 4)

**Tasks:**
- [ ] Mobile responsive design
- [ ] User feedback/error messages
- [ ] Loading states and animations
- [ ] Admin interface for moderation
- [ ] User testing
- [ ] Bug fixes

**Deliverables:**
- Production-ready WebDoor
- Mobile-optimized interface
- Complete documentation

### Phase 5: Documentation & Launch (Week 5)

**Tasks:**
- [ ] User documentation/help page
- [ ] Admin documentation
- [ ] Launch announcement
- [ ] Initial content seeding (if desired)
- [ ] Monitor usage and feedback

**Deliverables:**
- Complete documentation
- WebDoor launched
- User feedback collected

---

## Technical Implementation Details

### Backend: API Handler

**File: `public_html/webdoors/cwn/api.php`**

All backend logic is contained in this single file within the webdoor directory.

```php
<?php
/**
 * Community Wireless Node List - API Endpoint
 *
 * Self-contained API for CWN WebDoor
 * Handles all CRUD operations, validation, and credit integration
 */

require_once __DIR__ . '/../../../vendor/autoload.php';

use BinktermPHP\Auth;
use BinktermPHP\Database;
use BinktermPHP\UserCredit;

// Enable error reporting for debugging (disable in production)
error_reporting(E_ALL);
ini_set('display_errors', '0');

// Set JSON header
header('Content-Type: application/json');

// CORS headers (if needed)
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type');

// Handle preflight requests
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit;
}

// Require authentication
$auth = new Auth();
$user = $auth->getCurrentUser();

if (!$user) {
    http_response_code(401);
    echo json_encode(['error' => 'Authentication required']);
    exit;
}

$userId = $user['user_id'] ?? $user['id'];
$username = $user['username'];
$isAdmin = $user['is_admin'] ?? false;

// Get database connection
$db = Database::getInstance()->getPdo();

// Route the request
$requestMethod = $_SERVER['REQUEST_METHOD'];
$requestUri = $_SERVER['REQUEST_URI'];
$pathParts = explode('/', trim(parse_url($requestUri, PHP_URL_PATH), '/'));
$action = $_GET['action'] ?? '';

try {
    switch ($action) {
        case 'list':
            handleListNetworks($db);
            break;

        case 'get':
            handleGetNetwork($db);
            break;

        case 'submit':
            handleSubmitNetwork($db, $userId, $username);
            break;

        case 'update':
            handleUpdateNetwork($db, $userId, $isAdmin);
            break;

        case 'delete':
            handleDeleteNetwork($db, $userId, $isAdmin);
            break;

        case 'search':
            handleSearch($db, $userId);
            break;

        default:
            http_response_code(400);
            echo json_encode(['error' => 'Invalid action']);
    }
} catch (Exception $e) {
    http_response_code(400);
    echo json_encode(['error' => $e->getMessage()]);
}

exit;

// ============================================================================
// HANDLER FUNCTIONS
// ============================================================================

/**
 * List networks
 */
function handleListNetworks($db)
{
    $params = $_GET;
        $limit = min((int)($params['limit'] ?? 100), 500);
        $offset = max((int)($params['offset'] ?? 0), 0);
        $activeOnly = ($params['active_only'] ?? 'true') === 'true';

        $sql = "SELECT * FROM cwn_networks WHERE 1=1";
        $sqlParams = [];

        if ($activeOnly) {
            $sql .= " AND is_active = TRUE";
        }

        // Bounding box filter
        if (!empty($params['bbox'])) {
            $bbox = explode(',', $params['bbox']);
            if (count($bbox) === 4) {
                $sql .= " AND latitude BETWEEN ? AND ? AND longitude BETWEEN ? AND ?";
                $sqlParams = array_merge($sqlParams, $bbox);
            }
        }

        $sql .= " ORDER BY date_added DESC LIMIT ? OFFSET ?";
        $sqlParams[] = $limit;
        $sqlParams[] = $offset;

        $stmt = $this->db->prepare($sql);
        $stmt->execute($sqlParams);
        $networks = $stmt->fetchAll();

        // Get total count
        $countSql = "SELECT COUNT(*) FROM cwn_networks WHERE 1=1";
        if ($activeOnly) {
            $countSql .= " AND is_active = TRUE";
        }
        $total = $this->db->query($countSql)->fetchColumn();

    echo json_encode([
        'networks' => $networks,
        'total' => (int)$total,
        'limit' => $limit,
        'offset' => $offset
    ]);
}

/**
 * Get single network
 */
function handleGetNetwork($db)
{
    $id = (int)($_GET['id'] ?? 0);

    if ($id <= 0) {
        throw new Exception('Invalid network ID');
    }

    $stmt = $db->prepare("SELECT * FROM cwn_networks WHERE id = ?");
    $stmt->execute([$id]);
    $network = $stmt->fetch();

    if (!$network) {
        http_response_code(404);
        echo json_encode(['error' => 'Network not found']);
        return;
    }

    echo json_encode($network);
}

/**
 * Submit network
 */
function handleSubmitNetwork($db, $userId, $username)
{
    $data = json_decode(file_get_contents('php://input'), true);

    if (!$data) {
        throw new Exception('Invalid JSON data');
    }

    // Validate input
    validateNetworkData($data);

    // Check rate limit
    checkRateLimit($db, $userId, 'submission', 20);

    // Check for duplicate
    $existing = findDuplicate($db, $data['ssid'], $data['latitude'], $data['longitude']);
    if ($existing) {
        throw new Exception('A network with this SSID and location already exists');
    }

    // Insert network
    $stmt = $db->prepare("
        INSERT INTO cwn_networks
        (ssid, latitude, longitude, description, wifi_password, network_type,
         submitted_by, submitted_by_username, bbs_name)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        RETURNING id
    ");

    $stmt->execute([
        $data['ssid'],
        round($data['latitude'], 3),
        round($data['longitude'], 3),
        $data['description'],
        $data['wifi_password'] ?? null,
        $data['network_type'] ?? 'other',
        $userId,
        $username,
        \BinktermPHP\Config::get('BBS_NAME', 'YourBBS')
    ]);

    $networkId = $stmt->fetch()['id'];

    // Award credits
    UserCredit::addTransaction(
        $userId,
        3,
        'cwn_submission',
        "Submitted network: {$data['ssid']}"
    );

    echo json_encode([
        'success' => true,
        'network_id' => $networkId,
        'credits_earned' => 3,
        'message' => 'Network submitted successfully'
    ]);
}

/**
 * Update network
 */
function handleUpdateNetwork($db, $userId, $isAdmin)
{
    $id = (int)($_GET['id'] ?? 0);
    $data = json_decode(file_get_contents('php://input'), true);

    if ($id <= 0) {
        throw new Exception('Invalid network ID');
    }

    if (!$data) {
        throw new Exception('Invalid JSON data');
    }

    // Get existing network
    $stmt = $db->prepare("SELECT * FROM cwn_networks WHERE id = ?");
    $stmt->execute([$id]);
    $network = $stmt->fetch();

    if (!$network) {
        throw new Exception('Network not found');
    }

    // Check authorization
    if (!$isAdmin && $network['submitted_by'] != $userId) {
        throw new Exception('You can only edit your own submissions');
    }

    // Validate input
    validateNetworkData($data, false);

        // Build update query
        $updates = [];
        $params = [];

        if (isset($data['description'])) {
            $updates[] = 'description = ?';
            $params[] = $data['description'];
        }

        if (isset($data['wifi_password'])) {
            $updates[] = 'wifi_password = ?';
            $params[] = $data['wifi_password'];
        }

        if (isset($data['network_type'])) {
            $updates[] = 'network_type = ?';
            $params[] = $data['network_type'];
        }

        $updates[] = 'date_updated = NOW()';
        $updates[] = 'date_verified = NOW()';

    $params[] = $id;

    $sql = "UPDATE cwn_networks SET " . implode(', ', $updates) . " WHERE id = ?";
    $db->prepare($sql)->execute($params);

    echo json_encode([
        'success' => true,
        'message' => 'Network updated successfully'
    ]);
}

/**
 * Delete network
 */
function handleDeleteNetwork($db, $userId, $isAdmin)
{
    $id = (int)($_GET['id'] ?? 0);

    if ($id <= 0) {
        throw new Exception('Invalid network ID');
    }

    // Get existing network
    $stmt = $db->prepare("SELECT * FROM cwn_networks WHERE id = ?");
    $stmt->execute([$id]);
    $network = $stmt->fetch();

    if (!$network) {
        throw new Exception('Network not found');
    }

    // Check authorization
    if (!$isAdmin && $network['submitted_by'] != $userId) {
        throw new Exception('You can only delete your own submissions');
    }

    // Soft delete
    $stmt = $db->prepare("UPDATE cwn_networks SET is_active = FALSE WHERE id = ?");
    $stmt->execute([$id]);

    echo json_encode([
        'success' => true,
        'message' => 'Network deleted successfully'
    ]);
}

/**
 * Search networks
 */
function handleSearch($db, $userId)
{
    $params = json_decode(file_get_contents('php://input'), true);

    if (!$params) {
        throw new Exception('Invalid JSON data');
    }

    // Check credits
    $balance = UserCredit::getBalance($userId);
    if ($balance < 1) {
        throw new Exception('Insufficient credits. You need 1 credit to search.');
    }

    // Check rate limit
    checkRateLimit($db, $userId, 'search', 50);

    $results = [];

    if ($params['type'] === 'radius') {
        $results = searchByRadius(
            $db,
            $params['latitude'],
            $params['longitude'],
            $params['radius_km'] ?? 5,
            $params['filters'] ?? []
        );
    } elseif ($params['type'] === 'keyword') {
        $results = searchByKeyword(
            $db,
            $params['keyword'],
            $params['filters'] ?? []
        );
    }

    // Deduct credit
    UserCredit::addTransaction(
        $userId,
        -1,
        'cwn_search',
        "Searched networks ({$params['type']})"
    );

    // Log search
    $stmt = $db->prepare("
        INSERT INTO cwn_searches (user_id, search_type, search_query, results_count)
        VALUES (?, ?, ?, ?)
        RETURNING id
    ");
    $stmt->execute([
        $userId,
        $params['type'],
        json_encode($params),
        count($results)
    ]);
    $searchId = $stmt->fetch()['id'];

    echo json_encode([
        'success' => true,
        'results' => $results,
        'count' => count($results),
        'credits_spent' => 1,
        'search_id' => $searchId
    ]);
}

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

/**
 * Search by radius using Haversine formula
 */
function searchByRadius($db, float $lat, float $lon, float $radiusKm, array $filters): array
{
    $sql = "
        SELECT *,
            (6371 * acos(
                cos(radians(?)) * cos(radians(latitude)) *
                cos(radians(longitude) - radians(?)) +
                sin(radians(?)) * sin(radians(latitude))
            )) AS distance_km
        FROM cwn_networks
        WHERE is_active = TRUE
        HAVING distance_km <= ?
        ORDER BY distance_km
        LIMIT 100
    ";

    $stmt = $db->prepare($sql);
    $stmt->execute([$lat, $lon, $lat, $radiusKm]);
    return $stmt->fetchAll();
}

/**
 * Search by keyword
 */
function searchByKeyword($db, string $keyword, array $filters): array
{
    $sql = "
        SELECT * FROM cwn_networks
        WHERE is_active = TRUE
        AND (
            ssid ILIKE ? OR
            description ILIKE ?
        )
        ORDER BY date_added DESC
        LIMIT 100
    ";

    $searchTerm = "%{$keyword}%";
    $stmt = $db->prepare($sql);
    $stmt->execute([$searchTerm, $searchTerm]);
    return $stmt->fetchAll();
}

/**
 * Validate network data
 */
function validateNetworkData(array $data, bool $requireAll = true): void
{
    if ($requireAll) {
        if (empty($data['ssid'])) {
            throw new Exception('SSID is required');
        }
        if (!isset($data['latitude'])) {
            throw new Exception('Latitude is required');
        }
        if (!isset($data['longitude'])) {
            throw new Exception('Longitude is required');
        }
        if (empty($data['description'])) {
            throw new Exception('Description is required');
        }
    }

    // SSID validation
    if (isset($data['ssid'])) {
        if (strlen($data['ssid']) < 1 || strlen($data['ssid']) > 100) {
            throw new Exception('SSID must be 1-100 characters');
        }
    }

    // Coordinate validation
    if (isset($data['latitude'])) {
        if ($data['latitude'] < -90 || $data['latitude'] > 90) {
            throw new Exception('Invalid latitude');
        }
    }

    if (isset($data['longitude'])) {
        if ($data['longitude'] < -180 || $data['longitude'] > 180) {
            throw new Exception('Invalid longitude');
        }
    }

    // Description validation
    if (isset($data['description'])) {
        $len = strlen($data['description']);
        if ($len < 10 || $len > 500) {
            throw new Exception('Description must be 10-500 characters');
        }
    }

    // Password validation (optional)
    if (isset($data['wifi_password']) && strlen($data['wifi_password']) > 100) {
        throw new Exception('WiFi password too long (max 100 characters)');
    }
}

/**
 * Check for duplicate network
 */
function findDuplicate($db, string $ssid, float $lat, float $lon): ?array
{
    $stmt = $db->prepare("
        SELECT * FROM cwn_networks
        WHERE ssid = ? AND latitude = ? AND longitude = ?
    ");
    $stmt->execute([$ssid, round($lat, 3), round($lon, 3)]);
    return $stmt->fetch() ?: null;
}

/**
 * Check rate limit
 */
function checkRateLimit($db, int $userId, string $type, int $maxPerDay): void
{
    $table = $type === 'submission' ? 'cwn_networks' : 'cwn_searches';
    $field = $type === 'submission' ? 'submitted_by' : 'user_id';

    $sql = "
        SELECT COUNT(*) FROM {$table}
        WHERE {$field} = ?
        AND created_at > NOW() - INTERVAL '1 day'
    ";

    $stmt = $db->prepare($sql);
    $stmt->execute([$userId]);
    $count = $stmt->fetchColumn();

    if ($count >= $maxPerDay) {
        throw new Exception("Rate limit exceeded. Maximum {$maxPerDay} {$type}s per day.");
    }
}
```

---

## Frontend Implementation

### Map Integration (Leaflet.js)

**HTML Template:**

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Wireless Node List</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <!-- Bootstrap (from parent) -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/cwn.css">
</head>
<body>
    <div class="container-fluid p-3">
        <div class="row mb-3">
            <div class="col">
                <h3><i class="fas fa-wifi"></i> Community Wireless Node List</h3>
                <p class="text-muted">Discover and share community wireless networks</p>
            </div>
            <div class="col-auto">
                <span class="badge bg-primary">Credits: <span id="userCredits">-</span></span>
            </div>
        </div>

        <!-- Search Controls -->
        <div class="row mb-3">
            <div class="col-md-8">
                <div class="input-group">
                    <input type="text" class="form-control" id="searchInput"
                           placeholder="Search by location, SSID, or description...">
                    <button class="btn btn-primary" onclick="doSearch()">
                        <i class="fas fa-search"></i> Search (1 credit)
                    </button>
                </div>
            </div>
            <div class="col-md-4">
                <button class="btn btn-outline-primary w-100" onclick="useMyLocation()">
                    <i class="fas fa-location-arrow"></i> Use My Location
                </button>
            </div>
        </div>

        <!-- Map -->
        <div class="row mb-3">
            <div class="col">
                <div id="map" style="height: 500px; border-radius: 8px;"></div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mb-3">
            <div class="col">
                <button class="btn btn-success" onclick="showSubmitForm()">
                    <i class="fas fa-plus"></i> Submit New Network (+3 credits)
                </button>
            </div>
        </div>

        <!-- Recent Networks List -->
        <div class="row">
            <div class="col">
                <h5>Recent Networks</h5>
                <div id="networksList">
                    <div class="text-center text-muted py-3">
                        Loading networks...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals will go here -->

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="js/cwn.js"></script>
    <script src="js/map.js"></script>
</body>
</html>
```

---

## Future Enhancements (v2.0+)

### Federation via HTTP API

When ready to implement inter-BBS networking:

1. **REST API for Federation**
   - `POST /api/cwn/federation/sync` - Receive updates from other BBSs
   - `GET /api/cwn/federation/export` - Export local networks
   - JWT or API key authentication

2. **Master Node Coordination**
   - Designate master node (e.g., cwnadmin.example.com)
   - All BBSs push updates to master
   - Master broadcasts to all nodes
   - Conflict resolution strategy

3. **Update Format (JSON)**
   ```json
   {
       "action": "add",
       "network": {
           "ssid": "...",
           "latitude": 40.712,
           "longitude": -74.006,
           "description": "...",
           "wifi_password": "...",
           "source_bbs": "YourBBS"
       }
   }
   ```

4. **Benefits over Fidonet**
   - Real-time updates (no overnight batching)
   - Better error handling
   - Easier authentication (API keys)
   - JSON format (easier parsing)
   - HTTPS encryption

---

## Success Metrics

### Key Performance Indicators

1. **Adoption:** > 50% of active users try the WebDoor
2. **Submissions:** > 100 networks submitted in first month
3. **Engagement:** Average 5 searches per user per week
4. **Quality:** < 10% spam/invalid submissions
5. **Geographic Coverage:** Networks in > 20 different cities

### Analytics to Track

- Total networks in database
- Networks added per day/week/month
- Searches performed per day
- Most searched locations
- Most active submitters
- Credits earned/spent via WebDoor
- Mobile vs desktop usage
- Map interactions (zoom, pan, marker clicks)

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Spam submissions | Medium | Medium | Rate limiting, validation, admin tools |
| Invalid coordinates | Medium | Low | Validation, map picker tool |
| Privacy concerns | Low | Medium | No personal info, public networks only |
| Database growth | Low | Low | Archive old/inactive networks |
| Credit exploitation | Low | Medium | Rate limits, monitoring |

---

## Appendix A: Sample Networks

### Example Submissions

```json
{
    "ssid": "SeattleMeshNet",
    "latitude": 47.608,
    "longitude": -122.335,
    "description": "Community mesh network covering Capitol Hill. File sharing, local forums, and emergency communications.",
    "wifi_password": null,
    "network_type": "mesh"
}
```

```json
{
    "ssid": "BBS_Gateway_SF",
    "latitude": 37.774,
    "longitude": -122.419,
    "description": "Wireless BBS access point in Golden Gate Park. Dial-up BBS emulator over WiFi.",
    "wifi_password": "retrocomputing",
    "network_type": "bbs"
}
```

```json
{
    "ssid": "Community_Lib_Austin",
    "latitude": 30.267,
    "longitude": -97.743,
    "description": "Free WiFi at community library with local digital archive and e-book lending.",
    "wifi_password": "readbooks2026",
    "network_type": "community"
}
```

---

## Appendix B: Database Optimization

### Spatial Indexing

For better geospatial query performance, consider PostGIS extension:

```sql
-- Enable PostGIS
CREATE EXTENSION IF NOT EXISTS postgis;

-- Add geometry column
ALTER TABLE cwn_networks
ADD COLUMN geom GEOMETRY(Point, 4326);

-- Populate geometry from lat/lon
UPDATE cwn_networks
SET geom = ST_SetSRID(ST_MakePoint(longitude, latitude), 4326);

-- Create spatial index
CREATE INDEX idx_cwn_networks_geom ON cwn_networks USING GIST(geom);

-- Example radius query with PostGIS
SELECT *, ST_Distance(geom, ST_MakePoint(-122.419, 37.774)::geography) / 1000 AS distance_km
FROM cwn_networks
WHERE ST_DWithin(geom, ST_MakePoint(-122.419, 37.774)::geography, 5000)
ORDER BY distance_km;
```

---

## Document Revision History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-31 | AI Assistant | Initial draft - local-only implementation |

---

**END OF PROPOSAL**
