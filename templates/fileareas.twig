{% extends "base.twig" %}

{% block title %}File Areas - {{ parent() }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="fas fa-folder-open"></i>
        File Areas Management
    </h2>
    <button class="btn btn-fidonet" onclick="showAddFileareaModal()">
        <i class="fas fa-plus"></i>
        Add File Area
    </button>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">File Areas</h6>
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="radio" class="btn-check" name="filter" id="active" value="active" checked>
                        <label class="btn btn-outline-secondary" for="active">Active</label>

                        <input type="radio" class="btn-check" name="filter" id="all" value="all">
                        <label class="btn btn-outline-secondary" for="all">All</label>

                        <input type="radio" class="btn-check" name="filter" id="inactive" value="inactive">
                        <label class="btn btn-outline-secondary" for="inactive">Inactive</label>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="fileareasContainer">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        Loading file areas...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Statistics</h6>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-8">Active Areas:</dt>
                    <dd class="col-4" id="activeCount">-</dd>

                    <dt class="col-8">Total Files:</dt>
                    <dd class="col-4" id="totalFiles">-</dd>

                    <dt class="col-8">Total Size:</dt>
                    <dd class="col-4" id="totalSize">-</dd>
                </dl>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">File Area Settings</h6>
            </div>
            <div class="card-body">
                <small class="text-muted">
                    <strong>Replace Existing:</strong> When enabled, new files with the same name replace old ones (useful for NODELIST, etc.)
                    <br><br>
                    <strong>Versioning:</strong> When disabled, files with duplicate names get version suffixes (_1, _2, etc.)
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Filearea Modal -->
<div class="modal fade" id="fileareaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fileareaModalTitle">Add File Area</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="fileareaForm">
                    <input type="hidden" id="fileareaId">

                    <div class="mb-3">
                        <label for="fileareaTag" class="form-label">Tag *</label>
                        <input type="text" class="form-control text-uppercase" id="fileareaTag" name="tag" required maxlength="255">
                        <div class="form-text">File area tag (e.g., NODELIST, GENERAL_FILES)</div>
                    </div>

                    <div class="mb-3">
                        <label for="fileareaDescription" class="form-label">Description *</label>
                        <textarea class="form-control" id="fileareaDescription" name="description" rows="2" required></textarea>
                        <div class="form-text">Brief description of the file area</div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="fileareaDomain" class="form-label">Domain</label>
                            <input type="text" class="form-control" id="fileareaDomain" name="domain" maxlength="255">
                            <div class="form-text">Network domain</div>
                        </div>
                        <div class="col-md-6">
                            <label for="fileareaMaxSize" class="form-label">Max File Size (MB)</label>
                            <input type="number" class="form-control" id="fileareaMaxSize" name="max_file_size" value="10" min="1" max="1024">
                            <div class="form-text">Maximum file size</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="fileareaPassword" class="form-label">TIC Password (Optional)</label>
                        <input type="password" class="form-control" id="fileareaPassword" name="password" maxlength="255" autocomplete="new-password">
                        <div class="form-text">File echo password for TIC files (FSC-87 Pw field)</div>
                    </div>

                    <div class="mb-3">
                        <label for="fileareaAllowedExt" class="form-label">Allowed Extensions</label>
                        <input type="text" class="form-control" id="fileareaAllowedExt" name="allowed_extensions" placeholder="e.g., zip,txt,pdf">
                        <div class="form-text">Comma-separated list (leave empty for all)</div>
                    </div>

                    <div class="mb-3">
                        <label for="fileareaBlockedExt" class="form-label">Blocked Extensions</label>
                        <input type="text" class="form-control" id="fileareaBlockedExt" name="blocked_extensions" placeholder="e.g., exe,bat,sh">
                        <div class="form-text">Comma-separated list</div>
                    </div>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="fileareaReplaceExisting" name="replace_existing">
                        <label class="form-check-label" for="fileareaReplaceExisting">
                            Replace Existing Files
                        </label>
                        <div class="form-text">Replace files with same name instead of versioning</div>
                    </div>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="fileareaAllowDuplicateHash" name="allow_duplicate_hash">
                        <label class="form-check-label" for="fileareaAllowDuplicateHash">
                            Allow Duplicate Content
                        </label>
                        <div class="form-text">Allow same file content (hash) with different filenames</div>
                    </div>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="fileareaIsLocal" name="is_local">
                        <label class="form-check-label" for="fileareaIsLocal">
                            Local Only
                        </label>
                        <div class="form-text">Don't forward files to uplinks</div>
                    </div>

                    <div class="mb-3">
                        <label for="fileareaUploadPermission" class="form-label">Upload Permission</label>
                        <select class="form-select" id="fileareaUploadPermission" name="upload_permission">
                            <option value="1">Users Can Upload</option>
                            <option value="0">Admin Only</option>
                            <option value="2">Read-Only (No Uploads)</option>
                        </select>
                        <div class="form-text">Control who can upload files to this area</div>
                    </div>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="fileareaScanVirus" name="scan_virus" checked>
                        <label class="form-check-label" for="fileareaScanVirus">
                            Virus Scanning
                        </label>
                        <div class="form-text">Scan uploaded files for viruses (requires ClamAV)</div>
                    </div>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="fileareaIsActive" name="is_active" checked>
                        <label class="form-check-label" for="fileareaIsActive">
                            Active
                        </label>
                        <div class="form-text">File area is active</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <a href="/admin/filearea-rules" class="btn btn-outline-secondary me-auto">Edit Rules</a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveFilearea()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this file area: <strong id="deleteFileareaTag"></strong>?</p>
                <p class="text-danger">This will also delete all files in this area!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentFileareaId = null;

$(document).ready(function() {
    loadFileareas();
    loadStats();

    $('input[name="filter"]').change(function() {
        loadFileareas();
    });

    $('#fileareaTag').on('input', function() {
        this.value = this.value.toUpperCase().replace(/[^A-Z0-9_]/g, '');
    });
});

function loadFileareas() {
    $('#fileareasContainer').html('<div class="loading-spinner"><i class="fas fa-spinner fa-spin me-2"></i>Loading...</div>');

    let filter = $('input[name="filter"]:checked').val();
    let url = '/api/fileareas?filter=' + filter;

    $.get(url)
        .done(function(data) {
            displayFileareas(data.fileareas);
        })
        .fail(function() {
            $('#fileareasContainer').html('<div class="alert alert-danger m-3">Failed to load file areas</div>');
        });
}

function displayFileareas(fileareas) {
    if (fileareas.length === 0) {
        $('#fileareasContainer').html('<div class="alert alert-info m-3">No file areas found</div>');
        return;
    }

    let html = `
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th width="18%">Tag</th>
                        <th width="18%">Domain</th>
                        <th width="29%">Description</th>
                        <th width="10%">Files</th>
                        <th width="10%">Size</th>
                        <th width="10%">Status</th>
                        <th width="15%">Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;

    fileareas.forEach(function(area) {
        const statusBadge = area.is_active
            ? '<span class="badge bg-success">Active</span>'
            : '<span class="badge bg-secondary">Inactive</span>';

        const localBadge = area.is_local
            ? '<span class="badge bg-info ms-1">Local</span>'
            : '';

        const replaceBadge = area.replace_existing
            ? '<span class="badge bg-warning ms-1">Replace</span>'
            : '';

        const fileSize = formatBytes(area.total_size || 0);

        html += `
            <tr>
                <td><strong>${escapeHtml(area.tag)}</strong></td>
                <td>${escapeHtml(area.domain || '')}</td>
                <td>${escapeHtml(area.description || '')}</td>
                <td>${area.file_count || 0}</td>
                <td>${fileSize}</td>
                <td>${statusBadge}${localBadge}${replaceBadge}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editFilearea(${area.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="showDeleteModal(${area.id}, '${escapeHtml(area.tag)}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table></div>';
    $('#fileareasContainer').html(html);
}

function showAddFileareaModal() {
    currentFileareaId = null;
    $('#fileareaModalTitle').text('Add File Area');
    $('#fileareaForm')[0].reset();
    $('#fileareaIsActive').prop('checked', true);
    $('#fileareaDomain').val('');
    $('#fileareaPassword').val('');
    $('#fileareaMaxSize').val(10);
    new bootstrap.Modal('#fileareaModal').show();
}

function editFilearea(id) {
    currentFileareaId = id;
    $('#fileareaModalTitle').text('Edit File Area');

    $.get(`/api/fileareas/${id}`)
        .done(function(data) {
            const area = data.filearea;
            $('#fileareaId').val(area.id);
            $('#fileareaTag').val(area.tag);
            $('#fileareaDescription').val(area.description);
            $('#fileareaDomain').val(area.domain || '');
            $('#fileareaPassword').val(area.password || '');
            $('#fileareaMaxSize').val((area.max_file_size || 10485760) / 1048576);
            $('#fileareaAllowedExt').val(area.allowed_extensions || '');
            $('#fileareaBlockedExt').val(area.blocked_extensions || '');
            $('#fileareaReplaceExisting').prop('checked', area.replace_existing);
            $('#fileareaAllowDuplicateHash').prop('checked', area.allow_duplicate_hash);
            $('#fileareaIsLocal').prop('checked', area.is_local);
            $('#fileareaUploadPermission').val(area.upload_permission !== undefined ? area.upload_permission : 1);
            $('#fileareaScanVirus').prop('checked', area.scan_virus !== false);
            $('#fileareaIsActive').prop('checked', area.is_active);
            new bootstrap.Modal('#fileareaModal').show();
        })
        .fail(function() {
            showError('Failed to load file area details');
        });
}

function saveFilearea() {
    const maxSizeMB = parseFloat($('#fileareaMaxSize').val()) || 10;
    const maxSizeBytes = maxSizeMB * 1048576;

    const data = {
        tag: $('#fileareaTag').val(),
        description: $('#fileareaDescription').val(),
        domain: $('#fileareaDomain').val().trim(),
        password: $('#fileareaPassword').val(),
        max_file_size: maxSizeBytes,
        allowed_extensions: $('#fileareaAllowedExt').val(),
        blocked_extensions: $('#fileareaBlockedExt').val(),
        replace_existing: $('#fileareaReplaceExisting').is(':checked'),
        allow_duplicate_hash: $('#fileareaAllowDuplicateHash').is(':checked'),
        is_local: $('#fileareaIsLocal').is(':checked'),
        upload_permission: parseInt($('#fileareaUploadPermission').val()),
        scan_virus: $('#fileareaScanVirus').is(':checked'),
        is_active: $('#fileareaIsActive').is(':checked')
    };

    const url = currentFileareaId ? `/api/fileareas/${currentFileareaId}` : '/api/fileareas';
    const method = currentFileareaId ? 'PUT' : 'POST';

    $.ajax({
        url: url,
        method: method,
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function() {
            bootstrap.Modal.getInstance('#fileareaModal').hide();
            showSuccess(currentFileareaId ? 'File area updated' : 'File area created');
            loadFileareas();
            loadStats();
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.error || 'Failed to save file area';
            showError(error);
        }
    });
}

function showDeleteModal(id, tag) {
    currentFileareaId = id;
    $('#deleteFileareaTag').text(tag);
    new bootstrap.Modal('#deleteModal').show();

    $('#confirmDelete').off('click').on('click', function() {
        deleteFilearea();
    });
}

function deleteFilearea() {
    $.ajax({
        url: `/api/fileareas/${currentFileareaId}`,
        method: 'DELETE',
        success: function() {
            bootstrap.Modal.getInstance('#deleteModal').hide();
            showSuccess('File area deleted');
            loadFileareas();
            loadStats();
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.error || 'Failed to delete file area';
            showError(error);
        }
    });
}

function loadStats() {
    $.get('/api/fileareas/stats')
        .done(function(data) {
            $('#activeCount').text(data.active_count);
            $('#totalFiles').text(data.total_files);
            $('#totalSize').text(formatBytes(data.total_size));
        });
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}
</script>
{% endblock %}
