{% extends "base.twig" %}

{% block title %}Reset Password - {{ parent() }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-4">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-lock"></i>
                    Create New Password
                </h4>
            </div>
            <div class="card-body">
                <div id="validatingToken" class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x text-primary mb-3"></i>
                    <p class="text-muted">Validating reset token...</p>
                </div>

                <div id="invalidToken" class="alert alert-danger" style="display: none;">
                    <strong>Invalid or Expired Token</strong>
                    <p class="mb-0 mt-2">
                        This password reset link is invalid or has expired.
                        Please request a new password reset link.
                    </p>
                </div>

                <div id="resetForm" style="display: none;">
                    <p class="text-muted mb-4">
                        Please enter your new password below.
                    </p>

                    <form id="passwordResetForm">
                        <input type="hidden" id="resetToken" name="token" value="{{ token }}">

                        <div class="mb-3">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" name="newPassword" required minlength="8">
                            <div class="form-text">
                                Password must be at least 8 characters long.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                            <div id="passwordMatchError" class="text-danger small mt-1" style="display: none;">
                                Passwords do not match.
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-check"></i>
                                Reset Password
                            </button>
                        </div>
                    </form>

                    <div id="successMessage" class="alert alert-success mt-3" style="display: none;"></div>
                    <div id="errorMessage" class="alert alert-danger mt-3" style="display: none;"></div>
                </div>
            </div>
        </div>

        <div class="text-center mt-3">
            <small class="text-muted">
                <a href="/login" class="text-decoration-none">Back to Login</a>
                {% if not token %}
                | <a href="/forgot-password" class="text-decoration-none">Request New Reset Link</a>
                {% endif %}
            </small>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Get token from URL parameter
const urlParams = new URLSearchParams(window.location.search);
const token = urlParams.get('token');

if (!token) {
    $('#validatingToken').hide();
    $('#invalidToken').show();
} else {
    // Set the token in the hidden field
    $('#resetToken').val(token);

    // Validate the token
    $.ajax({
        url: '/api/auth/validate-reset-token',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ token: token }),
        success: function(response) {
            if (response.valid) {
                $('#validatingToken').hide();
                $('#resetForm').show();
                $('#newPassword').focus();
            } else {
                $('#validatingToken').hide();
                $('#invalidToken').show();
            }
        },
        error: function() {
            $('#validatingToken').hide();
            $('#invalidToken').show();
        }
    });
}

// Password matching validation
$('#confirmPassword').on('input', function() {
    const newPassword = $('#newPassword').val();
    const confirmPassword = $(this).val();

    if (confirmPassword && newPassword !== confirmPassword) {
        $('#passwordMatchError').show();
    } else {
        $('#passwordMatchError').hide();
    }
});

// Form submission
$('#passwordResetForm').on('submit', function(e) {
    e.preventDefault();

    const newPassword = $('#newPassword').val();
    const confirmPassword = $('#confirmPassword').val();

    // Validate passwords match
    if (newPassword !== confirmPassword) {
        $('#errorMessage').html('<strong>Error!</strong><br>Passwords do not match.').show();
        return;
    }

    // Validate password length
    if (newPassword.length < 8) {
        $('#errorMessage').html('<strong>Error!</strong><br>Password must be at least 8 characters long.').show();
        return;
    }

    const formData = {
        token: $('#resetToken').val(),
        newPassword: newPassword
    };

    // Hide previous messages
    $('#successMessage').hide();
    $('#errorMessage').hide();

    // Disable submit button
    const submitBtn = $('#submitBtn');
    const originalText = submitBtn.html();
    submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Resetting...');

    $.ajax({
        url: '/api/auth/reset-password',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            if (response.success) {
                $('#successMessage').html(
                    '<strong>Success!</strong><br>' +
                    response.message +
                    '<br><br>You will be redirected to the login page in 3 seconds...'
                ).show();
                $('#passwordResetForm').hide();

                // Redirect to login after 3 seconds
                setTimeout(function() {
                    window.location.href = '/login';
                }, 3000);
            }
        },
        error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Failed to reset password';
            $('#errorMessage').html('<strong>Error!</strong><br>' + error).show();
            submitBtn.prop('disabled', false).html(originalText);
        }
    });
});
</script>
{% endblock %}
