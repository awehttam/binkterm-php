{% extends "base.twig" %}

{% block title %}Dashboard - {{ parent() }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h4 id="netmailCount">0</h4>
                                <p class="mb-0">
                                    <i class="fas fa-envelope"></i>
                                    Unread Netmail
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <h4 id="echomailCount">0</h4>
                                <p class="mb-0">
                                    <i class="fas fa-comments"></i>
                                    New Echomail
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-clock me-2"></i>
                    Recent Messages
                </h6>
            </div>
            <div class="card-body">
                <div id="recentMessages">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading recent messages...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">System Information</h6>
            </div>
            <div class="card-body">
                <dl class="row">

                    <dt class="col-sm-5">Node Address:</dt>
                    <dd class="col-sm-7">{{ fidonet_origin }}</dd>
                    
                    <dt class="col-sm-5">Sysop:</dt>
                    <dd class="col-sm-7">{{ sysop_name }}</dd>
                    
                    <dt class="col-sm-5">User:</dt>
                    <dd class="col-sm-7">{{  current_user.username }}</dd>
                    
                    <dt class="col-sm-5">Address:</dt>
                    <dd class="col-sm-7">{{ fidonet_origin}} </dd>
                </dl>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">Echo Areas</h6>
            </div>
            <div class="card-body">
                <div id="echoareaList">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading echo areas...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Message View Modal -->
<div class="modal fade" id="dashboardMessageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dashboardMessageSubject">Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="dashboardMessageContent">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        Loading message...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-fidonet" id="dashboardReplyButton" style="display: none;">
                    <i class="fas fa-reply"></i>
                    Reply
                </button>
                <button type="button" class="btn btn-primary" id="dashboardGoToButton">
                    <i class="fas fa-external-link-alt"></i>
                    Go to Messages
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    loadDashboardData();
    loadRecentMessages();
    loadEchoareas();
    loadFontSettings();
    
    // Refresh every 30 seconds
    setInterval(function() {
        loadDashboardData();
        loadRecentMessages();
    }, 30000);
});

function loadDashboardData() {
    $.get('/api/dashboard/stats')
        .done(function(data) {
            $('#netmailCount').text(data.unread_netmail || 0);
            $('#echomailCount').text(data.new_echomail || 0);
        });
}

function loadRecentMessages() {
    $.get('/api/messages/recent')
        .done(function(data) {
            let html = '';
            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(function(msg) {
                    html += `
                        <div class="border-bottom py-1 message-item-clickable" onclick="viewDashboardMessage(${msg.id}, '${msg.type}', ${msg.echoarea ? `'${msg.echoarea}'` : 'null'})" style="cursor: pointer;">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1 me-2">
                                    <div class="d-flex justify-content-between">
                                        <strong class="text-truncate me-2" style="max-width: 120px;">${msg.from_name}</strong>
                                        <small class="text-muted flex-shrink-0" title="${formatFullDate(msg.date_written)}">${formatDate(msg.date_written)}</small>
                                    </div>
                                    <div class="text-truncate small" style="max-width: 250px;" title="${escapeHtml(msg.subject)}">${msg.subject}</div>
                                    <small class="text-muted" style="font-size: 0.75em;">
                                        ${msg.type === 'netmail' ? 'Netmail' : msg.echoarea}
                                    </small>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html = '<p class="text-muted">No recent messages</p>';
            }
            $('#recentMessages').html(html);
        });
}

function loadEchoareas() {
    $.get('/api/echoareas')
        .done(function(data) {
            let html = '';
            if (data.echoareas && data.echoareas.length > 0) {
                data.echoareas.forEach(function(area) {
                    html += `
                        <div class="d-flex justify-content-between align-items-center py-1">
                            <a href="/echomail/${area.tag}" class="text-decoration-none">
                                ${area.tag}
                            </a>
                            <span class="badge bg-secondary">${area.message_count || 0}</span>
                        </div>
                    `;
                });
            } else {
                html = '<p class="text-muted">No echo areas available</p>';
            }
            $('#echoareaList').html(html);
        });
}

function viewDashboardMessage(messageId, messageType, echoarea) {
    // Show loading modal
    $('#dashboardMessageContent').html(`
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin me-2"></i>
            Loading message...
        </div>
    `);
    $('#dashboardMessageModal').modal('show');
    
    // Set up "Go to Messages" button
    $('#dashboardGoToButton').off('click').on('click', function() {
        if (messageType === 'netmail') {
            window.location.href = `/netmail`;
        } else if (messageType === 'echomail') {
            if (echoarea && echoarea !== 'null') {
                window.location.href = `/echomail/${encodeURIComponent(echoarea)}`;
            } else {
                window.location.href = `/echomail`;
            }
        }
    });
    
    // Determine API endpoint
    let apiUrl;
    if (messageType === 'netmail') {
        apiUrl = `/api/messages/netmail/${messageId}`;
    } else if (messageType === 'echomail') {
        if (echoarea && echoarea !== 'null') {
            apiUrl = `/api/messages/echomail/${encodeURIComponent(echoarea)}/${messageId}`;
        } else {
            apiUrl = `/api/messages/echomail/message/${messageId}`;
        }
    }
    
    // Fetch message content
    $.get(apiUrl)
        .done(function(data) {
            displayDashboardMessage(data, messageType);
        })
        .fail(function() {
            $('#dashboardMessageContent').html('<div class="text-danger">Failed to load message</div>');
        });
}

function displayDashboardMessage(message, messageType) {
    $('#dashboardMessageSubject').text(message.subject || '(No Subject)');
    
    let parsedMessage;
    if (messageType === 'netmail') {
        parsedMessage = parseNetmailMessage(message.message_text || '');
    } else {
        parsedMessage = parseEchomailMessage(message.message_text || '', message.kludge_lines || '');
    }
    
    let html = `
        <div class="message-header-full mb-3">
            <div class="row">
                <div class="col-md-6">
                    <strong>From:</strong> ${escapeHtml(message.from_name)}<br>
                    <small class="text-muted">${formatFidonetAddress(message.from_address)}</small>
                </div>
                <div class="col-md-6">
                    <strong>To:</strong> ${escapeHtml(message.to_name || 'All')}<br>`;
    
    if (messageType === 'netmail') {
        html += `<small class="text-muted">${formatFidonetAddress(message.to_address)}</small>`;
    } else {
        html += `<span class="badge" style="background-color: ${message.echoarea_color || '#28a745'}; color: white;">${message.echoarea}</span>`;
    }
    
    html += `
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-6">
                    <strong>Date:</strong> ${formatFullDate(message.date_written)}
                </div>
                <div class="col-md-6">
                    <strong>Subject:</strong> ${escapeHtml(message.subject || '(No Subject)')}
                </div>
            </div>
        </div>
        
        ${parsedMessage.kludgeLines.length > 0 ? `
        <div class="message-headers mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 text-muted">Message Headers</h6>
                <button class="btn btn-sm btn-outline-secondary" id="toggleDashboardHeaders" onclick="toggleDashboardKludgeLines()">
                    <i class="fas fa-eye-slash" id="toggleDashboardIcon"></i>
                    <span id="toggleDashboardText">Show Headers</span>
                </button>
            </div>
            <div id="dashboardKludgeContainer" class="kludge-lines" style="display: none;">
                <pre class="bg-dark text-light p-3 rounded small">${formatKludgeLines(parsedMessage.kludgeLines)}</pre>
            </div>
        </div>
        ` : ''}
        
        <div class="message-text">
            ${formatMessageText(parsedMessage.messageBody)}
        </div>`;
    
    if (messageType === 'echomail' && message.origin_line) {
        html += `<div class="message-origin mt-2"><small class="text-muted">${escapeHtml(message.origin_line)}</small></div>`;
    }
    
    $('#dashboardMessageContent').html(html);
    
    // Set up reply button for appropriate messages
    const isSent = message.is_sent || (message.from_address && message.from_address === window.systemAddress);
    if (!isSent && messageType === 'netmail') {
        $('#dashboardReplyButton').show().off('click').on('click', function() {
            $('#dashboardMessageModal').modal('hide');
            window.location.href = `/compose/netmail?reply=${message.id}`;
        });
    } else if (messageType === 'echomail') {
        $('#dashboardReplyButton').show().off('click').on('click', function() {
            $('#dashboardMessageModal').modal('hide');
            let url = `/compose/echomail?reply=${message.id}`;
            if (message.echoarea) {
                url += `&echoarea=${encodeURIComponent(message.echoarea)}`;
            }
            window.location.href = url;
        });
    } else {
        $('#dashboardReplyButton').hide();
    }
}

function toggleDashboardKludgeLines() {
    const container = $('#dashboardKludgeContainer');
    const icon = $('#toggleDashboardIcon');
    const text = $('#toggleDashboardText');
    
    if (container.is(':visible')) {
        container.slideUp();
        icon.removeClass('fas fa-eye').addClass('fas fa-eye-slash');
        text.text('Show Headers');
    } else {
        container.slideDown();
        icon.removeClass('fas fa-eye-slash').addClass('fas fa-eye');
        text.text('Hide Headers');
    }
}

function loadFontSettings() {
    $.get('/api/user/settings')
        .done(function(data) {
            const fontFamily = data.font_family || 'Courier New, Monaco, Consolas, monospace';
            const fontSize = data.font_size || 16;
            
            // Apply font settings to message text in dashboard
            const css = `
                .message-text, .message-text pre, .message-text code,
                #dashboardMessageContent .message-text,
                #dashboardMessageContent .message-text pre,
                #dashboardMessageContent .message-text code,
                #dashboardKludgeContainer pre {
                    font-family: ${fontFamily} !important;
                    font-size: ${fontSize}px !important;
                }
            `;
            
            // Remove existing font style if any
            $('#dashboard-font-styles').remove();
            
            // Add new font styles
            $('<style id="dashboard-font-styles">' + css + '</style>').appendTo('head');
        })
        .fail(function() {
            console.log('Failed to load font settings, using defaults');
        });
}
</script>

<style>
.message-item-clickable:hover {
    background-color: #f8f9fa;
    transform: translateX(2px);
    transition: all 0.2s ease;
}

.message-item-clickable:active {
    background-color: #e9ecef;
}

/* Compact message styling */
.message-item-clickable {
    border-radius: 0.25rem;
    margin: 2px 0;
}

.message-item-clickable .small {
    font-size: 0.85em !important;
}

</style>
{% endblock %}