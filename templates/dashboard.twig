{% extends "base.twig" %}

{% block title %}Dashboard - {{ parent() }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <a href="/netmail" class="text-decoration-none">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <h4 id="netmailCount">0</h4>
                                    <p class="mb-0">
                                        <i class="fas fa-envelope"></i>
                                        Unread Netmail
                                    </p>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-6">
                        <a href="/echomail" class="text-decoration-none">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <h4 id="echomailCount">0</h4>
                                    <p class="mb-0">
                                        <i class="fas fa-comments"></i>
                                        Unread Echomail
                                    </p>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-newspaper me-2"></i>
                    System News & Information
                </h6>
            </div>
            <div class="card-body">
                <div id="systemNews">
                    {{ system_news_content|raw }}
                </div>
            </div>
        </div>

        {% if bbs_feature_enabled('shoutbox') %}
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-bullhorn me-2"></i>
                    Shoutbox
                </h6>
            </div>
            <div class="card-body">
                <div id="shoutboxMessages" class="mb-3">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading shouts...
                    </div>
                </div>
                <div class="d-flex justify-content-center mb-3">
                    <button class="btn btn-outline-secondary btn-sm" type="button" id="shoutboxLoadMore" onclick="loadMoreShouts()">
                        Load older shouts
                    </button>
                </div>
                <div class="input-group">
                    <input type="text" class="form-control" id="shoutboxInput" maxlength="280" placeholder="Leave a shout...">
                    <button class="btn btn-primary" type="button" onclick="postShout()">Post</button>
                </div>
                <div class="form-text text-muted">280 characters max.</div>
            </div>
        </div>
        {% endif %}

        {% if dashboard_ad and bbs_feature_enabled('advertising') %}
        <div class="card mt-4">
            <div class="card-body d-flex justify-content-center">
                <div class="ansi-art-container">
                    <pre class="ansi-art" id="dashboardAdAnsi">{{ dashboard_ad.content }}</pre>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">System Information</h6>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-5">Sysop:</dt>
                    <dd class="col-sm-7">{{ sysop_name }}</dd>

                    <dt class="col-sm-5">User:</dt>
                    <dd class="col-sm-7">{{ current_user.username }}</dd>

                    <dt class="col-sm-5">Addresses:</dt>
                    <dd class="col-sm-7">
                        {% if network_addresses|length > 0 %}
                            {% for addr in network_addresses %}
                                <div class="mb-1">
                                    <span class="badge bg-secondary me-1">{{ addr.domain }}</span>
                                    <code>{{ addr.address }}</code>
                                </div>
                            {% endfor %}
                        {% else %}
                            <code>{{ fidonet_origin }}</code>
                        {% endif %}
                    </dd>
                </dl>
            </div>
        </div>

        {% if bbs_feature_enabled('voting_booth') %}
        <div class="card mt-4" id="votingBoothCard">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-vote-yea me-2"></i>
                    Voting Booth
                </h6>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="pollPrevBtn" onclick="changeVotingPoll(-1)" title="Previous poll">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="pollNextBtn" onclick="changeVotingPoll(1)" title="Next poll">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="card-body" id="votingBoothBody">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin"></i>
                    Loading poll...
                </div>
            </div>
            <div class="card-footer text-end py-2">
                <a href="/polls/create" title="Create a new poll (15 credits)" style="text-decoration: none; font-size: 1.2rem;">
                    <i class="fas fa-file-circle-plus"></i>
                </a>
            </div>
        </div>
        {% endif %}

        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Echo Areas</h6>
                <a href="/subscriptions"><i class="fa-solid fa-wrench"></i></a>
                </a>
            </div>
            <div class="card-body">
                <div id="echoareaList">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading echo areas...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let votingPolls = [];
let votingPollIndex = 0;
let shoutboxOffset = 0;
const shoutboxPageSize = 5;

$(document).ready(function() {
    loadDashboardData();
    {% if bbs_feature_enabled('voting_booth') %}
    loadVotingBooth();
    {% endif %}
    loadEchoareas();
    {% if bbs_feature_enabled('shoutbox') %}
    loadShoutbox();
    {% endif %}
    renderDashboardAd();
    
    // Refresh dashboard data every 30 seconds (but not system news)
    setInterval(function() {
        loadDashboardData();
    }, 30000);
});

function loadDashboardData() {
    $.get('/api/dashboard/stats')
        .done(function(data) {
            $('#netmailCount').text(data.total_netmail || 0);
            $('#echomailCount').text(data.total_echomail || 0);
        });
}

function loadVotingBooth(keepPollId = null) {
    $.get('/api/polls/active')
        .done(function(data) {
            votingPolls = data.polls || [];
            if (votingPolls.length === 0) {
                $('#votingBoothBody').html('<p class="text-muted mb-0">No active polls right now.</p>');
                updateVotingPollNav();
                return;
            }
            if (keepPollId) {
                const idx = votingPolls.findIndex(p => p.id === keepPollId);
                votingPollIndex = idx >= 0 ? idx : 0;
            } else {
                const unansweredIndex = votingPolls.findIndex(p => !p.has_voted);
                votingPollIndex = unansweredIndex >= 0 ? unansweredIndex : 0;
            }
            renderVotingBooth();
        })
        .fail(function() {
            $('#votingBoothBody').html('<p class="text-danger mb-0">Failed to load poll.</p>');
            updateVotingPollNav();
        });
}

function renderVotingBooth() {
    if (votingPolls.length === 0) {
        $('#votingBoothBody').html('<p class="text-muted mb-0">No active polls right now.</p>');
        updateVotingPollNav();
        return;
    }

    const poll = votingPolls[votingPollIndex];
    const hasVoted = !!poll.has_voted;
    if (hasVoted) {
        const totalVotes = poll.total_votes || 0;
        let resultsHtml = `<h6 class="mb-3">${escapeHtml(poll.question)}</h6>`;
        resultsHtml += '<div class="small text-muted mb-2">Results</div>';
        if (totalVotes === 0) {
            resultsHtml += '<p class="text-muted mb-0">No votes yet.</p>';
        } else {
            (poll.results || []).forEach(result => {
                const percent = totalVotes > 0 ? Math.round((result.votes / totalVotes) * 100) : 0;
                resultsHtml += `
                    <div class="mb-2">
                        <div class="d-flex justify-content-between small">
                            <span>${escapeHtml(result.option_text)}</span>
                            <span>${result.votes} (${percent}%)</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar" role="progressbar" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            });
        }
        $('#votingBoothBody').html(resultsHtml);
        updateVotingPollNav();
        return;
    }

    let optionsHtml = `<h6 class="mb-3">${escapeHtml(poll.question)}</h6>`;
    optionsHtml += '<div class="small text-muted mb-2">Vote to see results</div>';
    optionsHtml += '<form id="votingBoothForm">';
    (poll.options || []).forEach(option => {
        optionsHtml += `
            <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="poll_option" id="pollOption${option.id}" value="${option.id}">
                <label class="form-check-label" for="pollOption${option.id}">
                    ${escapeHtml(option.option_text)}
                </label>
            </div>
        `;
    });
    optionsHtml += `
        <button type="button" class="btn btn-sm btn-primary mt-2" onclick="submitPollVote(${poll.id})">
            Submit Vote
        </button>
    `;
    optionsHtml += '</form>';
    $('#votingBoothBody').html(optionsHtml);
    updateVotingPollNav();
}

function changeVotingPoll(delta) {
    if (votingPolls.length <= 1) {
        return;
    }
    const nextIndex = votingPollIndex + delta;
    if (nextIndex < 0 || nextIndex >= votingPolls.length) {
        return;
    }
    votingPollIndex = nextIndex;
    renderVotingBooth();
}

function updateVotingPollNav() {
    const hasMultiple = votingPolls.length > 1;
    const prevBtn = document.getElementById('pollPrevBtn');
    const nextBtn = document.getElementById('pollNextBtn');
    if (!prevBtn || !nextBtn) {
        return;
    }
    prevBtn.disabled = !hasMultiple || votingPollIndex === 0;
    nextBtn.disabled = !hasMultiple || votingPollIndex === (votingPolls.length - 1);
}

function submitPollVote(pollId) {
    const selected = document.querySelector('input[name="poll_option"]:checked');
    if (!selected) {
        alert('Please select an option.');
        return;
    }

    fetch(`/api/polls/${pollId}/vote`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ option_id: selected.value })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadVotingBooth(pollId);
        } else {
            alert(data.error || 'Failed to submit vote.');
        }
    })
    .catch(() => alert('Failed to submit vote.'));
}

function escapeHtml(text) {
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
    return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
}


function loadEchoareas() {
    $.get('/api/echoareas?subscribed_only=true')
        .done(function(data) {
            let html = '';
            if (data.echoareas && data.echoareas.length > 0) {
                // Add header row
                html += `
                    <div class="d-flex justify-content-between align-items-center py-1 border-bottom mb-2">
                        <div class="fw-bold text-muted small">Echo Area</div>
                        <div class="fw-bold text-muted small">Unread&nbsp;&nbsp;Total</div>
                    </div>
                `;
                
                data.echoareas.forEach(function(area) {
                    const unreadCount = area.unread_count || 0;
                    const totalCount = area.message_count || 0;
                    const fullTag = `${area.tag}@${area.domain}`;

                    html += `
                        <div class="d-flex justify-content-between align-items-center py-1">
                            <div>
                                <a href="/echomail/${encodeURIComponent(fullTag)}" class="text-decoration-none">
                                    ${area.tag}
                                </a>
                                ${area.domain ? `<span class="badge bg-secondary ms-1" style="font-size: 0.65em; vertical-align: middle;">${area.domain}</span>` : ''}
                            </div>
                            <div class="d-flex gap-1 align-items-center">
                                <span class="badge ${unreadCount > 0 ? 'bg-warning text-dark' : 'bg-secondary'} text-center" style="min-width: 35px;">${unreadCount}</span>
                                <span class="badge bg-secondary text-center" style="min-width: 35px;">${totalCount}</span>
                            </div>
                        </div>
                    `;
                });
            } else {
                html = '<p class="text-muted">No echo areas available</p>';
            }
            $('#echoareaList').html(html);
        });
}

function loadShoutbox() {
    shoutboxOffset = 0;
    $.get(`/api/shoutbox?limit=${shoutboxPageSize}&offset=${shoutboxOffset}`)
        .done(function(data) {
            const items = data.messages || [];
            if (items.length === 0) {
                $('#shoutboxMessages').html('<p class="text-muted mb-0">No shouts yet. Be the first!</p>');
                $('#shoutboxLoadMore').prop('disabled', true);
                return;
            }
            let html = '';
            items.forEach(function(msg) {
                html += `
                    <div class="mb-2">
                        <strong>${escapeHtml(msg.username)}</strong>
                        <span class="text-muted small ms-2">${escapeHtml(msg.created_at)}</span>
                        <div>${escapeHtml(msg.message)}</div>
                    </div>
                `;
            });
            $('#shoutboxMessages').html(html);
            shoutboxOffset += items.length;
            $('#shoutboxLoadMore').prop('disabled', items.length < shoutboxPageSize);
        })
        .fail(function() {
            $('#shoutboxMessages').html('<p class="text-danger mb-0">Failed to load shouts.</p>');
            $('#shoutboxLoadMore').prop('disabled', true);
        });
}

function loadMoreShouts() {
    const button = document.getElementById('shoutboxLoadMore');
    if (button.disabled) {
        return;
    }
    button.disabled = true;
    $.get(`/api/shoutbox?limit=${shoutboxPageSize}&offset=${shoutboxOffset}`)
        .done(function(data) {
            const items = data.messages || [];
            if (items.length === 0) {
                return;
            }
            let html = '';
            items.forEach(function(msg) {
                html += `
                    <div class="mb-2">
                        <strong>${escapeHtml(msg.username)}</strong>
                        <span class="text-muted small ms-2">${escapeHtml(msg.created_at)}</span>
                        <div>${escapeHtml(msg.message)}</div>
                    </div>
                `;
            });
            $('#shoutboxMessages').append(html);
            shoutboxOffset += items.length;
            button.disabled = items.length < shoutboxPageSize;
        })
        .fail(function() {
            button.disabled = false;
        });
}

function postShout() {
    const input = document.getElementById('shoutboxInput');
    const message = input.value.trim();
    if (!message) {
        return;
    }

    fetch('/api/shoutbox', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            input.value = '';
            loadShoutbox();
        } else {
            alert(data.error || 'Failed to post shout.');
        }
    })
    .catch(() => alert('Failed to post shout.'));
}

function renderDashboardAd() {
    const pre = document.getElementById('dashboardAdAnsi');
    if (!pre) {
        return;
    }

    const renderAd = () => {
        if (typeof renderAnsiTerminal !== 'function') {
            return;
        }
        pre.innerHTML = renderAnsiTerminal(pre.textContent);
    };

    if (typeof renderAnsiTerminal === 'function') {
        renderAd();
        return;
    }

    const script = document.createElement('script');
    script.src = '/js/ansisys.js';
    script.onload = renderAd;
    document.body.appendChild(script);
}


</script>

<style>
/* Dashboard-specific styling */
#systemNews .card {
    border: none;
    box-shadow: none;
}

#systemNews .card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

#systemNews .alert {
    border-radius: 0.5rem;
}

#systemNews code {
    font-size: 0.875em;
    background-color: #f8f9fa;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
}
</style>
{% endblock %}
