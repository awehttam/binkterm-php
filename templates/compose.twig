{% extends "base.twig" %}

{% block title %}Compose {{ type|title }} - {{ parent() }}{% endblock %}


{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="fas fa-{{ type == 'netmail' ? 'envelope' : 'comments' }}"></i>
        Compose {{ type|title }}
    </h2>
    <a href="/{{ type }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left"></i>
        Back to {{ type|title }}
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="compose-form">
            <form id="composeForm">
                <input type="hidden" id="messageType" value="{{ type }}">
                <input type="hidden" id="replyToId" value="{{ reply_to_id }}">
                
                {% if type == 'netmail' %}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="toAddress" class="form-label">To Address *</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="toAddress" name="to_address" 
                                       placeholder="1:123/456" value="{{ reply_to_address }}" required>
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" 
                                        id="addressBookButton" data-bs-toggle="dropdown" aria-expanded="false"
                                        title="Select from address book">
                                    <i class="fas fa-address-book"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end" id="addressBookDropdown" style="min-width: 300px;">
                                    <li><h6 class="dropdown-header d-flex justify-content-between align-items-center">
                                        Address Book
                                        <button class="btn btn-sm btn-outline-primary" onclick="showAddAddressModal()" title="Create new address book entry">
                                            <i class="fas fa-plus" ></i>
                                        </button>
                                    </h6></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li class="px-3">
                                        <input type="text" class="form-control form-control-sm" id="composeAddressSearch" 
                                               placeholder="Search addresses..." onkeyup="searchAddressBookForCompose(this.value)">
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <div id="composeAddressList" style="max-height: 200px; overflow-y: auto;">
                                        <li><div class="text-center text-muted py-2">
                                            <i class="fas fa-spinner fa-spin"></i> Loading...
                                        </div></li>
                                    </div>
                                </ul>
                            </div>
                            <div class="form-text">Fidonet address (e.g., 1:123/456)</div>
                        </div>
                        <div class="col-md-6">
                            <label for="toName" class="form-label">To Name *</label>
                            <input type="text" class="form-control" id="toName" name="to_name" 
                                   value="{{ to_name_value }}" required>
                        </div>
                    </div>
                {% else %}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="echoarea" class="form-label">Echo Area *</label>
                            <select class="form-select" id="echoarea" name="echoarea" required>
                                <option value="">Select echo area...</option>
                                <!-- Options will be loaded via AJAX -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="toName" class="form-label">To Name</label>
                            <input type="text" class="form-control" id="toName" name="to_name" 
                                   value="{{ to_name_value }}" placeholder="All">
                            <div class="form-text">Leave as 'All' for public message</div>
                        </div>
                    </div>
                {% endif %}
                
                <div class="mb-3">
                    <label for="subject" class="form-label">Subject *</label>
                    <input type="text" class="form-control" id="subject" name="subject" 
                           value="{{ reply_subject }}" required>
                </div>
                
                <div class="mb-3">
                    <label for="messageText" class="form-label">Message *</label>
                    <textarea class="form-control" id="messageText" name="message_text" 
                              rows="15" required>{{ reply_text }}</textarea>
                    <div class="form-text">
                        Use plain text. Fidonet standard formatting applies.
                    </div>
                </div>
                
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <div>
                        {#
                        <button type="button" class="btn btn-outline-primary" onclick="saveDraft()">
                            <i class="fas fa-save"></i>
                            Save Draft
                        </button>
                        #}
                        <button type="submit" class="btn btn-fidonet">
                            <i class="fas fa-paper-plane"></i>
                            Send {{ type|title }}
                        </button>
                    </div>
                </div>
            </form>
            
            <div id="sendStatus" class="mt-3" style="display: none;"></div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Message Guidelines</h6>
            </div>
            <div class="card-body">
                {% if type == 'netmail' %}
                    <h6>Netmail Guidelines:</h6>
                    <ul class="small">
                        <li>Private messages between nodes</li>
                        <li>Use proper Fidonet addressing</li>
                        <li>Be respectful and professional</li>
                        <li>Messages are routed through the network</li>
                    </ul>
                {% else %}
                    <h6>Echomail Guidelines:</h6>
                    <ul class="small">
                        <li>Public forum messages</li>
                        <li>Stay on-topic for the echo area</li>
                        <li>Be respectful to all participants</li>
                        <li>Follow the echo rules and moderation</li>
                    </ul>
                {% endif %}
                
                <h6 class="mt-3">Technical Notes:</h6>
                <ul class="small">
                    <li>Plain text only (no HTML)</li>
                    <li>Lines should be â‰¤ 79 characters</li>
                    <li>Use --- for signature separator</li>
                    <li>Origin line added automatically</li>
                </ul>
            </div>
        </div>

        
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">Your Info</h6>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-4">Name:</dt>
                    <dd class="col-8">{{ user_name }}</dd>
                    
                    <dt class="col-4">System:</dt>
                    <dd class="col-8">{{ system_name_display }}</dd>
                    
                    <dt class="col-4">Address:</dt>
                    <dd class="col-8">{{ system_address_display }}</dd>
                </dl>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    const messageType = $('#messageType').val();
    const replyToId = $('#replyToId').val();
    
    // Font settings will be applied automatically by global settings
    
    // Load echo areas for echomail
    if (messageType === 'echomail') {
        loadEchoareas();
    }
    
    
    // Form submit handler
    $('#composeForm').on('submit', function(e) {
        e.preventDefault();
        sendMessage();
    });
    
    // Address validation for netmail
    if (messageType === 'netmail') {
        $('#toAddress').on('blur', function() {
            validateFidonetAddressField(this);
        });
    }
    
    // Auto-save draft every 2 minutes
    setInterval(function() {
        saveDraft(true); // Silent save
    }, 120000);
});

function loadEchoareas() {
    $.get('/api/echoareas')
        .done(function(data) {
            const select = $('#echoarea');
            select.empty().append('<option value="">Select echo area...</option>');
            
            if (data.echoareas) {
                data.echoareas.forEach(function(area) {
                    const colorDot = `<span style="display:inline-block; width:12px; height:12px; border-radius:50%; background-color:${area.color || '#28a745'}; margin-right:8px; vertical-align:middle;"></span>`;
                    select.append(`<option value="${area.tag}" data-color="${area.color || '#28a745'}">${area.tag} - ${area.description}</option>`);
                });
                
                // Add color styling to select options
                select.on('change', function() {
                    const selectedOption = $(this).find('option:selected');
                    const color = selectedOption.data('color');
                    if (color) {
                        $(this).css('border-left', `4px solid ${color}`);
                    }
                });
            }
            
            // Pre-select if specified in URL or template
            const urlParams = new URLSearchParams(window.location.search);
            const preselect = urlParams.get('echoarea') || '{{ echoarea }}';
            if (preselect) {
                select.val(preselect);
            }
        });
}


function validateFidonetAddressField(field) {
    const address = $(field).val().trim();
    if (address && !validateFidonetAddress(address)) {
        $(field).addClass('is-invalid');
        if (!$(field).next('.invalid-feedback').length) {
            $(field).after('<div class="invalid-feedback">Invalid Fidonet address format (e.g., 1:123/456)</div>');
        }
        return false;
    } else {
        $(field).removeClass('is-invalid');
        $(field).next('.invalid-feedback').remove();
        return true;
    }
}

function sendMessage() {
    const messageType = $('#messageType').val();
    const form = $('#composeForm');
    
    // Validate form
    if (!form[0].checkValidity()) {
        form[0].reportValidity();
        return;
    }
    
    // Additional validation for netmail
    if (messageType === 'netmail') {
        if (!validateFidonetAddressField('#toAddress')) {
            return;
        }
    }
    
    const formData = {
        type: messageType,
        to_address: $('#toAddress').val(),
        to_name: $('#toName').val(),
        echoarea: $('#echoarea').val(),
        subject: $('#subject').val(),
        message_text: $('#messageText').val(),
        reply_to_id: $('#replyToId').val() || null
    };
    
    // Show sending status
    $('#sendStatus').show().html(`
        <div class="alert alert-info">
            <i class="fas fa-spinner fa-spin me-2"></i>
            Sending ${messageType}...
        </div>
    `);
    
    // Disable form
    form.find('input, textarea, select, button').prop('disabled', true);
    
    $.ajax({
        url: `/api/messages/send`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            $('#sendStatus').html(`
                <div class="alert alert-success">
                    <i class="fas fa-check me-2"></i>
                    ${messageType.charAt(0).toUpperCase() + messageType.slice(1)} sent successfully!
                </div>
            `);
            
            setTimeout(function() {
                window.location.href = `/${messageType}`;
            }, 2000);
        },
        error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : `Failed to send ${messageType}`;
            $('#sendStatus').html(`
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${escapeHtml(error)}
                </div>
            `);
            
            // Re-enable form
            form.find('input, textarea, select, button').prop('disabled', false);
        }
    });
}

function saveDraft(silent = false) {
    const formData = {
        type: $('#messageType').val(),
        to_address: $('#toAddress').val(),
        to_name: $('#toName').val(),
        echoarea: $('#echoarea').val(),
        subject: $('#subject').val(),
        message_text: $('#messageText').val(),
        reply_to_id: $('#replyToId').val() || null
    };
    
    // Only save if there's actual content
    if (!formData.subject.trim() && !formData.message_text.trim()) {
        return;
    }
    
    $.ajax({
        url: '/api/messages/draft',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            if (!silent) {
                showSuccess('Draft saved successfully');
            }
        },
        error: function() {
            if (!silent) {
                showError('Failed to save draft');
            }
        }
    });
}

// Address Book Functions for Compose Page
function loadComposeAddressBook(search = '') {
    $.get('/api/address-book', { search: search })
        .done(function(response) {
            if (response.success) {
                renderComposeAddressBook(response.entries);
            } else {
                $('#composeAddressList').html('<li><div class="text-danger py-2">Failed to load</div></li>');
            }
        })
        .fail(function(xhr, status, error) {
            $('#composeAddressList').html('<li><div class="text-danger py-2">Failed to load</div></li>');
        });
}

function renderComposeAddressBook(entries) {
    const container = $('#composeAddressList');
    let html = '';
    
    if (entries.length === 0) {
        html = '<li><div class="text-center text-muted py-2">No entries found</div></li>';
    } else {
        entries.forEach(function(entry) {
            html += `
                <li><a class="dropdown-item" href="#" onclick="selectAddressBookEntry('${escapeHtml(entry.messaging_user_id || 'unknown')}', '${escapeHtml(entry.node_address || '')}')">
                    <div class="fw-bold">${escapeHtml(entry.name || 'Unnamed')}</div>
                    <div class="text-primary small">@${escapeHtml(entry.messaging_user_id || 'unknown')}</div>
                    <div class="text-muted small font-monospace">${escapeHtml(entry.node_address || 'No address')}</div>
                    ${entry.description ? `<div class="text-muted smaller">${escapeHtml(entry.description.substring(0, 40) + (entry.description.length > 40 ? '...' : ''))}</div>` : ''}
                </a></li>
            `;
        });
    }
    
    container.html(html);
}

function searchAddressBookForCompose(query) {
    if (query.length > 0) {
        loadComposeAddressBook(query);
    } else {
        loadComposeAddressBook();
    }
}

function selectAddressBookEntry(fullName, nodeAddress) {
    $('#toName').val(fullName);
    $('#toAddress').val(nodeAddress);
    
    // Close dropdown
    const dropdown = bootstrap.Dropdown.getInstance($('#addressBookButton'));
    if (dropdown) {
        dropdown.hide();
    }
    
    // Clear search
    $('#composeAddressSearch').val('');
}

// Initialize address book when dropdown is shown
$(document).ready(function() {
    $('#addressBookDropdown').on('show.bs.dropdown', function() {
        // Only load if not already loaded
        if ($('#composeAddressList').find('.fa-spinner').length > 0) {
            loadComposeAddressBook();
        }
    });
    
    // Pre-load address book entries on page load for faster access
    loadComposeAddressBook();
});

</script>

<!-- Address Book Entry Modal (only for netmail) -->
{% if type == 'netmail' %}
<div class="modal fade" id="addressBookModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addressBookModalTitle">Add Address Book Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addressBookForm">
                    <input type="hidden" id="addressBookEntryId">
                    
                    <div class="mb-3">
                        <label for="addressBookName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="addressBookName" required 
                               placeholder="Enter a descriptive name (e.g., John Smith)">
                        <div class="form-text">Descriptive name for this contact</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="addressBookUserId" class="form-label">User ID</label>
                        <input type="text" class="form-control" id="addressBookUserId" required 
                               placeholder="Enter the user ID for messaging">
                        <div class="form-text">User ID/handle to use when sending messages</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="addressBookNodeAddress" class="form-label">Node Address</label>
                        <input type="text" class="form-control" id="addressBookNodeAddress" required 
                               placeholder="1:234/567" pattern="^\d+:\d+\/\d+(\.\d+)?$"
                               title="Enter a valid Fidonet address (e.g., 1:234/567 or 1:234/567.0)">
                        <div class="form-text">Format: zone:net/node or zone:net/node.point</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="addressBookEmail" class="form-label">Email Address <small class="text-muted">(optional)</small></label>
                        <input type="email" class="form-control" id="addressBookEmail" 
                               placeholder="email@example.com">
                        <div class="form-text">For your reference only - not used for messaging</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="addressBookDescription" class="form-label">Description <small class="text-muted">(optional)</small></label>
                        <textarea class="form-control" id="addressBookDescription" rows="3" 
                                  placeholder="Notes about this contact..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveComposeAddressBookEntry()">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Address book modal functions for compose page
function showAddAddressModal() {
    $('#addressBookModalTitle').text('Add Address Book Entry');
    $('#addressBookEntryId').val('');
    $('#addressBookForm')[0].reset();
    $('#addressBookModal').modal('show');
}

function saveComposeAddressBookEntry() {
    const data = {
        name: $('#addressBookName').val().trim(),
        messaging_user_id: $('#addressBookUserId').val().trim(),
        node_address: $('#addressBookNodeAddress').val().trim(),
        email: $('#addressBookEmail').val().trim(),
        description: $('#addressBookDescription').val().trim()
    };
    
    // Basic validation
    if (!data.name || !data.messaging_user_id || !data.node_address) {
        showError('Name, user ID, and node address are required');
        return;
    }
    
    $.ajax({
        url: '/api/address-book/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
            if (response.success) {
                $('#addressBookModal').modal('hide');
                showSuccess('Entry added successfully');
                // Optionally populate the compose form
                if (confirm('Use this entry for the current message?')) {
                    $('#toName').val(data.messaging_user_id);
                    $('#toAddress').val(data.node_address);
                }
            } else {
                showError(response.error || 'Failed to save entry');
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            showError(response && response.error ? response.error : 'Failed to save entry');
        }
    });
}
</script>
{% endif %}
{% endblock %}