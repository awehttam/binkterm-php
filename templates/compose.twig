{% extends "base.twig" %}

{% block title %}Compose {{ type|title }} - {{ parent() }}{% endblock %}


{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="fas fa-{{ type == 'netmail' ? 'envelope' : 'comments' }}"></i>
        Compose {{ type|title }}
    </h2>
    <a href="/{{ type }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left"></i>
        Back to {{ type|title }}
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="compose-form">
            <form id="composeForm">
                <input type="hidden" id="messageType" value="{{ type }}">
                <input type="hidden" id="replyToId" value="{{ reply_to_id }}">
                <input type="hidden" id="domain" value="{{ domain }}">
                
                {% if type == 'netmail' %}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="toAddress" class="form-label">To Address (leave blank for local)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="toAddress" name="to_address" 
                                       placeholder="" value="{{ reply_to_address }}" >
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" 
                                        id="addressBookButton" data-bs-toggle="dropdown" aria-expanded="false"
                                        title="Select from address book">
                                    <i class="fas fa-address-book"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end" id="addressBookDropdown" style="min-width: 300px;">
                                    <li><h6 class="dropdown-header d-flex justify-content-between align-items-center">
                                        Address Book
                                        <button class="btn btn-sm btn-outline-primary" onclick="showAddAddressModal()" title="Create new address book entry">
                                            <i class="fas fa-plus" ></i>
                                        </button>
                                    </h6></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li class="px-3">
                                        <input type="text" class="form-control form-control-sm" id="composeAddressSearch" 
                                               placeholder="Search addresses..." onkeyup="searchAddressBookForCompose(this.value)">
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <div id="composeAddressList" style="max-height: 200px; overflow-y: auto;">
                                        <li><div class="text-center text-muted py-2">
                                            <i class="fas fa-spinner fa-spin"></i> Loading...
                                        </div></li>
                                    </div>
                                </ul>
                            </div>
                            <div class="form-text">Fidonet address (e.g., 1:123/456)</div>
                        </div>
                        <div class="col-md-6">
                            <label for="toName" class="form-label">To Name *</label>
                            <input type="text" class="form-control" id="toName" name="to_name"
                                   value="{{ to_name_value }}" required>
                        </div>
                    </div>
                    {% if crashmail_enabled %}
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="crashmail" name="crashmail"{% if prefill_crashmail %} checked{% endif %}>
                            <label class="form-check-label" for="crashmail">
                                <i class="fas fa-bolt text-warning me-1"></i>Crashmail (Direct Delivery){% if credits_enabled %} - <strong>{{ crashmail_cost }} {{ currency_symbol }}</strong>{% endif %}
                            </label>
                            <div class="form-text">
                                Attempt immediate direct delivery to the destination node, bypassing hub routing.
                                Requires the destination to be directly reachable.{% if credits_enabled %} Costs {{ crashmail_cost }} {{ currency_symbol }}.{% endif %}
                            </div>
                        </div>
                    </div>
                    <div id="attachmentSection" class="mb-3" style="display:none">
                        <label class="form-label">
                            <i class="fas fa-paperclip me-1"></i>Attach File
                            <small class="text-muted">(requires crashmail; subject will be set to filename)</small>
                        </label>
                        <input type="file" id="attachmentFile" class="form-control">
                        <div id="attachmentName" class="form-text"></div>
                    </div>
                    {% endif %}
                {% else %}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="echoarea" class="form-label">Echo Area *</label>
                            <select class="form-select" id="echoarea" name="echoarea" required>
                                <option value="">Select echo area...</option>
                                <!-- Options will be loaded via AJAX -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="toName" class="form-label">To Name</label>
                            <input type="text" class="form-control" id="toName" name="to_name"
                                   value="{{ to_name_value }}" placeholder="All">
                            <div class="form-text">Leave as 'All' for public message</div>
                        </div>
                    </div>
                    <div class="mb-3" id="crossPostSection" style="display: none;">
                        <a class="text-decoration-none" data-bs-toggle="collapse" href="#crossPostCollapse" role="button" aria-expanded="false" aria-controls="crossPostCollapse">
                            <i class="fas fa-layer-group me-1"></i>Cross-post to other areas
                            <span class="badge bg-secondary ms-1" id="crossPostBadge" style="display: none;">0/{{ max_cross_post_areas }}</span>
                        </a>
                        <div class="collapse mt-2" id="crossPostCollapse">
                            <div class="card card-body p-2" style="max-height: 200px; overflow-y: auto;" id="crossPostList">
                            </div>
                            <div class="form-text">Select additional areas to post this message to (max {{ max_cross_post_areas }}). Each area receives an independent copy.</div>
                        </div>
                    </div>
                {% endif %}
                
                <div class="mb-3">
                    <label for="subject" class="form-label">Subject *</label>
                    <input type="text" class="form-control" id="subject" name="subject" 
                           value="{{ reply_subject }}" required>
                </div>

                <div class="mb-3" id="messageTextGroup">
                    <label for="messageText" class="form-label">Message *</label>
                    <textarea class="form-control" id="messageText" name="message_text" 
                              rows="15" required>{{ reply_text }}</textarea>
                    <div class="form-text">
                        Use plain text. Fidonet standard formatting applies.
                    </div>
                </div>

                <!-- Markdown Editor (shown when "Send as Markdown" is checked) -->
                <div class="mb-3" id="markdownEditorContainer" style="display: none;">
                    <label class="form-label">Message * <small class="text-muted ms-2"><i class="fab fa-markdown me-1"></i>Markdown mode</small></label>
                    <div class="md-editor-wrapper">
                        <div class="md-editor-toolbar" role="toolbar" aria-label="Markdown formatting">
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="mdAction('bold')" title="Bold (Ctrl+B)"><strong>B</strong></button>
                                <button type="button" class="btn btn-outline-secondary" onclick="mdAction('italic')" title="Italic (Ctrl+I)"><em>I</em></button>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="mdAction('h1')" title="Heading 1">H1</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="mdAction('h2')" title="Heading 2">H2</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="mdAction('h3')" title="Heading 3">H3</button>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="mdAction('code')" title="Inline code"><i class="fas fa-code"></i></button>
                                <button type="button" class="btn btn-outline-secondary" onclick="mdAction('codeblock')" title="Code block"><i class="fas fa-file-code"></i></button>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="mdAction('link')" title="Link (Ctrl+K)"><i class="fas fa-link"></i></button>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="mdAction('ul')" title="Unordered list"><i class="fas fa-list-ul"></i></button>
                                <button type="button" class="btn btn-outline-secondary" onclick="mdAction('ol')" title="Ordered list"><i class="fas fa-list-ol"></i></button>
                                <button type="button" class="btn btn-outline-secondary" onclick="mdAction('quote')" title="Blockquote"><i class="fas fa-quote-left"></i></button>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="mdAction('hr')" title="Horizontal rule">&#8212;</button>
                            </div>
                            <div class="btn-group btn-group-sm ms-auto">
                                <button type="button" class="btn btn-secondary" id="mdEditBtn" onclick="mdSetMode('edit')" title="Edit mode">Edit</button>
                                <button type="button" class="btn btn-outline-secondary" id="mdPreviewBtn" onclick="mdSetMode('preview')" title="Preview rendered output">Preview</button>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="showMarkdownHelp()" title="Markdown quick reference"><i class="fas fa-question-circle"></i></button>
                            </div>
                        </div>
                        <div class="md-editor-body">
                            <textarea class="md-editor-textarea" id="mdEditorText" spellcheck="true" placeholder="Write your markdown message here..."></textarea>
                            <div class="md-preview-pane" id="mdPreviewPane" style="display: none;">
                                <span class="text-muted small fst-italic">Click Preview to see the rendered output.</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-text"><i class="fab fa-markdown me-1"></i>Markdown formatting active. <a href="#" onclick="showMarkdownHelp(); return false;">Quick reference</a></div>
                </div>

                <div class="mb-3" id="markdownSection" style="display: none;">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="sendMarkdown" name="send_markdown">
                        <label class="form-check-label" for="sendMarkdown">
                            <i class="fab fa-markdown me-1"></i>Send as Markdown
                        </label>
                        <div class="form-text">Adds the MARKDOWN kludge for compatible networks.</div>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="taglineSelect" class="form-label">Tagline</label>
                    <select class="form-select" id="taglineSelect" name="tagline">
                        <option value="">No tagline</option>
                        {% for tagline in taglines %}
                            <option value="{{ tagline|e('html_attr') }}" {% if default_tagline == tagline %}selected{% endif %}>{{ tagline }}</option>
                        {% endfor %}
                    </select>
                    <div class="form-text">Select a sysop-provided tagline to append below your signature.</div>
                </div>
                
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <div>

                        <button type="button" class="btn btn-outline-primary" onclick="saveDraft()">
                            <i class="fas fa-save"></i>
                            Save Draft
                        </button>

                        <button type="submit" class="btn btn-fidonet">
                            <i class="fas fa-paper-plane"></i>
                            Send {{ type|title }}
                        </button>
                    </div>
                </div>
            </form>
            
            <div id="sendStatus" class="mt-3" style="display: none;"></div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Message Guidelines</h6>
            </div>
            <div class="card-body">
                {% if type == 'netmail' %}
                    <h6>Netmail Guidelines:</h6>
                    <ul class="small">
                        <li>Private messages between nodes</li>
                        <li>Your real name is used</li>
                        <li>Use proper Fidonet addressing</li>
                        <li>Be respectful and professional</li>
                        <li>Messages are routed through the network</li>
                        {% if credits_enabled %}
                        <li><strong>Cost: {{ netmail_cost }} {{ currency_symbol }}</strong></li>
                        {% endif %}
                    </ul>
                {% else %}
                    <h6>Echomail Guidelines:</h6>
                    <ul class="small">
                        <li>Your real name is used</li>
                        <li>Public forum messages</li>
                        <li>Stay on-topic for the echo area</li>
                        <li>Be respectful to all participants</li>
                        <li>Follow the echo rules and moderation</li>
                    </ul>
                {% endif %}
                
                <h6 class="mt-3">Technical Notes:</h6>
                <ul class="small">
                    <li>Plain text only (no HTML)</li>
                    <li>Lines should be less than 79 characters</li>
                    <li>Origin line added automatically</li>
                </ul>
            </div>
        </div>

        
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">Your Info</h6>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-4">Name:</dt>
                    <dd class="col-8">{{ user_name }}</dd>
                    
                    <dt class="col-4">System:</dt>
                    <dd class="col-8">{{ system_name_display }}</dd>
                    
                    <dt class="col-4">Address:</dt>
                    <dd class="col-8">{{ system_address_display }}</dd>
                </dl>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const maxCrossPostAreas = {{ max_cross_post_areas|default(5) }};
let allEchoareas = [];
let markdownSupportTimer = null;
let markdownPrefilled = false;
let mdEditorActive = false;
let mdPreviewTimer = null;
const replyIsMarkdown = {{ reply_is_markdown ? 'true' : 'false' }};

function updateMarkdownSection(allowed) {
    const section = $('#markdownSection');
    if (allowed) {
        section.show();
        if (replyIsMarkdown && !markdownPrefilled) {
            $('#sendMarkdown').prop('checked', true);
            markdownPrefilled = true;
            initMarkdownEditor();
        }
    } else {
        if (mdEditorActive) {
            destroyMarkdownEditor();
        }
        $('#sendMarkdown').prop('checked', false);
        section.hide();
    }
}

function fetchMarkdownSupport(params) {
    $.get('/api/messages/markdown-support', params)
        .done(function(response) {
            updateMarkdownSection(!!response.allowed);
        })
        .fail(function() {
            updateMarkdownSection(false);
        });
}

function refreshMarkdownSupportForEchomail() {
    const selected = $('#echoarea').val();
    if (!selected || !selected.includes('@')) {
        updateMarkdownSection(false);
        return;
    }
    const domain = selected.split('@')[1];
    if (!domain) {
        updateMarkdownSection(false);
        return;
    }
    fetchMarkdownSupport({ domain: domain });
}

function refreshMarkdownSupportForNetmail() {
    const address = ($('#toAddress').val() || '').trim();
    if (!address) {
        updateMarkdownSection(false);
        return;
    }
    fetchMarkdownSupport({ address: address });
}

/**
 * Initialize the markdown split-pane editor, replacing the plain textarea.
 */
function initMarkdownEditor() {
    if (mdEditorActive) return;
    mdEditorActive = true;

    // Apply critical layout styles inline so they work regardless of CSS cache state
    const editorHeight = $('#messageText').outerHeight() || 300;
    $('#mdEditorText').css({
        display: 'block',
        width: '100%',
        height: editorHeight + 'px',
        resize: 'none',
        boxSizing: 'border-box'
    });
    $('#mdPreviewPane').css({
        display: 'none',  // mdSetMode('edit') will manage visibility
        width: '100%',
        height: editorHeight + 'px',
        overflowY: 'auto',
        boxSizing: 'border-box'
    });

    // Copy current plain textarea content into the editor
    $('#mdEditorText').val($('#messageText').val());

    // Start in edit mode
    mdSetMode('edit');

    // Swap visibility
    $('#messageTextGroup').hide();
    $('#markdownEditorContainer').show();

    // Set up input handler (sync to hidden textarea only — preview updates on tab switch)
    $('#mdEditorText').off('input.md').on('input.md', function() {
        $('#messageText').val($(this).val());
    });

    // Keyboard shortcuts
    $('#mdEditorText').off('keydown.md').on('keydown.md', function(e) {
        if (e.ctrlKey || e.metaKey) {
            if (e.key === 'b') { e.preventDefault(); mdAction('bold'); return; }
            if (e.key === 'i') { e.preventDefault(); mdAction('italic'); return; }
            if (e.key === 'k') { e.preventDefault(); mdAction('link'); return; }
        }
        // Tab key: insert 4 spaces
        if (e.key === 'Tab') {
            e.preventDefault();
            const ta = this;
            const s = ta.selectionStart;
            const end = ta.selectionEnd;
            ta.value = ta.value.substring(0, s) + '    ' + ta.value.substring(end);
            ta.selectionStart = ta.selectionEnd = s + 4;
            $('#messageText').val(ta.value);
        }
    });

    $('#mdEditorText').trigger('focus');
}

/**
 * Switch between Edit and Preview tabs in the markdown editor.
 * @param {string} mode - 'edit' or 'preview'
 */
function mdSetMode(mode) {
    if (mode === 'preview') {
        $('#mdEditorText').hide();
        $('#mdPreviewPane').show();
        $('#mdEditBtn').removeClass('btn-secondary').addClass('btn-outline-secondary');
        $('#mdPreviewBtn').removeClass('btn-outline-secondary').addClass('btn-secondary');
        updateMarkdownPreview();
    } else {
        $('#mdPreviewPane').hide();
        $('#mdEditorText').show();
        $('#mdEditBtn').removeClass('btn-outline-secondary').addClass('btn-secondary');
        $('#mdPreviewBtn').removeClass('btn-secondary').addClass('btn-outline-secondary');
        $('#mdEditorText').trigger('focus');
    }
}

/**
 * Tear down the markdown editor and restore the plain textarea.
 */
function destroyMarkdownEditor() {
    if (!mdEditorActive) return;

    // Sync content back to the plain textarea
    $('#messageText').val($('#mdEditorText').val());

    // Remove event handlers
    $('#mdEditorText').off('input.md keydown.md');

    // Reset to edit mode for next time
    mdSetMode('edit');

    // Swap visibility
    $('#markdownEditorContainer').hide();
    $('#messageTextGroup').show();

    mdEditorActive = false;
}

/**
 * Ensure the hidden #messageText textarea has the latest editor content.
 */
function syncEditorToTextarea() {
    if (mdEditorActive) {
        $('#messageText').val($('#mdEditorText').val());
    }
}

/**
 * Fetch a live preview from the server and update the preview pane.
 */
function updateMarkdownPreview() {
    const text = $('#mdEditorText').val();
    const preview = $('#mdPreviewPane');

    if (!text.trim()) {
        preview.html('<span class="text-muted small fst-italic">Preview will appear here as you type\u2026</span>');
        return;
    }

    preview.addClass('md-preview-loading');

    $.ajax({
        url: '/api/messages/markdown-preview',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ text: text }),
        success: function(response) {
            preview.removeClass('md-preview-loading');
            preview.html(response.html || '<span class="text-muted small fst-italic">Nothing to preview.</span>');
        },
        error: function() {
            preview.removeClass('md-preview-loading');
        }
    });
}

/**
 * Apply a markdown toolbar action to the editor textarea.
 * @param {string} action
 */
function mdAction(action) {
    const ta = document.getElementById('mdEditorText');
    if (!ta) return;

    const start = ta.selectionStart;
    const end   = ta.selectionEnd;
    const sel   = ta.value.substring(start, end);
    const before = ta.value.substring(0, start);
    const after  = ta.value.substring(end);

    let newStart = start;
    let newEnd   = end;

    switch (action) {
        case 'bold':
            if (sel) {
                ta.value = before + '**' + sel + '**' + after;
                newStart = start + 2; newEnd = end + 2;
            } else {
                ta.value = before + '**bold text**' + after;
                newStart = start + 2; newEnd = start + 11;
            }
            break;

        case 'italic':
            if (sel) {
                ta.value = before + '*' + sel + '*' + after;
                newStart = start + 1; newEnd = end + 1;
            } else {
                ta.value = before + '*italic text*' + after;
                newStart = start + 1; newEnd = start + 12;
            }
            break;

        case 'code':
            if (sel) {
                ta.value = before + '`' + sel + '`' + after;
                newStart = start + 1; newEnd = end + 1;
            } else {
                ta.value = before + '`code`' + after;
                newStart = start + 1; newEnd = start + 5;
            }
            break;

        case 'codeblock': {
            const cbPre = (before.length === 0 || before.endsWith('\n')) ? '' : '\n';
            const cbPost = (after.length === 0 || after.startsWith('\n')) ? '' : '\n';
            if (sel) {
                ta.value = before + cbPre + '```\n' + sel + '\n```' + cbPost + after;
                newStart = start + cbPre.length + 4;
                newEnd   = newStart + sel.length;
            } else {
                ta.value = before + cbPre + '```\ncode here\n```' + cbPost + after;
                newStart = start + cbPre.length + 4;
                newEnd   = start + cbPre.length + 13;
            }
            break;
        }

        case 'link':
            if (sel) {
                ta.value = before + '[' + sel + '](url)' + after;
                newStart = end + 3; newEnd = end + 6; // select 'url'
            } else {
                ta.value = before + '[link text](url)' + after;
                newStart = start + 1; newEnd = start + 10;
            }
            break;

        case 'h1':
            mdToggleLinePrefix(ta, '# ');
            $('#messageText').val(ta.value);
            if (mdPreviewTimer) clearTimeout(mdPreviewTimer);
            mdPreviewTimer = setTimeout(updateMarkdownPreview, 500);
            ta.focus();
            return;

        case 'h2':
            mdToggleLinePrefix(ta, '## ');
            $('#messageText').val(ta.value);
            if (mdPreviewTimer) clearTimeout(mdPreviewTimer);
            mdPreviewTimer = setTimeout(updateMarkdownPreview, 500);
            ta.focus();
            return;

        case 'h3':
            mdToggleLinePrefix(ta, '### ');
            $('#messageText').val(ta.value);
            if (mdPreviewTimer) clearTimeout(mdPreviewTimer);
            mdPreviewTimer = setTimeout(updateMarkdownPreview, 500);
            ta.focus();
            return;

        case 'ul':
            mdToggleLinePrefix(ta, '- ');
            $('#messageText').val(ta.value);
            if (mdPreviewTimer) clearTimeout(mdPreviewTimer);
            mdPreviewTimer = setTimeout(updateMarkdownPreview, 500);
            ta.focus();
            return;

        case 'ol':
            mdToggleLinePrefix(ta, '1. ');
            $('#messageText').val(ta.value);
            if (mdPreviewTimer) clearTimeout(mdPreviewTimer);
            mdPreviewTimer = setTimeout(updateMarkdownPreview, 500);
            ta.focus();
            return;

        case 'quote':
            mdToggleLinePrefix(ta, '> ');
            $('#messageText').val(ta.value);
            if (mdPreviewTimer) clearTimeout(mdPreviewTimer);
            mdPreviewTimer = setTimeout(updateMarkdownPreview, 500);
            ta.focus();
            return;

        case 'hr': {
            const hrPre  = (before.length === 0 || before.endsWith('\n')) ? '' : '\n';
            const hrPost = (after.length === 0 || after.startsWith('\n')) ? '' : '\n';
            ta.value = before + hrPre + '---' + hrPost + after;
            newStart = newEnd = start + hrPre.length + 3;
            break;
        }

        default:
            return;
    }

    ta.selectionStart = newStart;
    ta.selectionEnd   = newEnd;
    ta.focus();

    // Sync and schedule preview
    $('#messageText').val(ta.value);
    if (mdPreviewTimer) clearTimeout(mdPreviewTimer);
    mdPreviewTimer = setTimeout(updateMarkdownPreview, 500);
}

/**
 * Toggle a line prefix on the line containing the cursor.
 * @param {HTMLTextAreaElement} ta
 * @param {string} prefix
 */
function mdToggleLinePrefix(ta, prefix) {
    const pos  = ta.selectionStart;
    const text = ta.value;

    const lineStart = text.lastIndexOf('\n', pos - 1) + 1;
    let   lineEnd   = text.indexOf('\n', pos);
    if (lineEnd === -1) lineEnd = text.length;

    const line       = text.substring(lineStart, lineEnd);
    const beforeLine = text.substring(0, lineStart);
    const afterLine  = text.substring(lineEnd);

    let newLine, cursorDelta;
    if (line.startsWith(prefix)) {
        newLine     = line.substring(prefix.length);
        cursorDelta = -prefix.length;
    } else {
        newLine     = prefix + line;
        cursorDelta = prefix.length;
    }

    ta.value = beforeLine + newLine + afterLine;
    const newPos = Math.max(lineStart, pos + cursorDelta);
    ta.selectionStart = ta.selectionEnd = newPos;
}

/**
 * Show the markdown quick-reference help modal.
 */
function showMarkdownHelp() {
    $('#markdownHelpModal').modal('show');
}

$(document).ready(function() {
    const messageType = $('#messageType').val();
    const replyToId = $('#replyToId').val();

    // Font settings will be applied automatically by global settings

    // Check if we're loading a draft
    const urlParams = new URLSearchParams(window.location.search);
    const draftId = urlParams.get('draft');

    if (draftId) {
        // Load draft data first, then initialize other components
        loadDraft(draftId).then(function() {
            // Initialize echo areas after draft is loaded (for echomail)
            if (messageType === 'echomail') {
                loadEchoareas();
            }
        });
    } else {
        // Load echo areas for echomail (normal compose)
        if (messageType === 'echomail') {
            loadEchoareas();
        }
    }

    // Form submit handler
    $('#composeForm').on('submit', function(e) {
        e.preventDefault();
        sendMessage();
    });

    // Markdown editor toggle
    $('#sendMarkdown').on('change', function() {
        if ($(this).is(':checked')) {
            initMarkdownEditor();
        } else {
            destroyMarkdownEditor();
        }
    });

    // Address validation for netmail
    if (messageType === 'netmail') {
        $('#toAddress').on('blur', function() {
            validateFidonetAddressField(this);
        });
        $('#toAddress').on('input', function() {
            if (markdownSupportTimer) {
                clearTimeout(markdownSupportTimer);
            }
            markdownSupportTimer = setTimeout(refreshMarkdownSupportForNetmail, 300);
        });

        // Show attachment section for netmail
        $('#attachmentSection').show();

        // Handle file selection
        $('#attachmentFile').on('change', function() {
            const file = this.files[0];
            if (file) {
                // Set subject to filename and lock it
                $('#subject').val(file.name).prop('readonly', true);
                // Force crashmail on and disable the checkbox
                $('#crashmail').prop('checked', true).prop('disabled', true);
                const size = file.size < 1048576
                    ? (file.size / 1024).toFixed(1) + ' KB'
                    : (file.size / 1048576).toFixed(1) + ' MB';
                $('#attachmentName').text('Attached: ' + file.name + ' (' + size + ')');
            } else {
                // Restore subject and re-enable crashmail
                $('#subject').prop('readonly', false);
                $('#crashmail').prop('disabled', false);
                $('#attachmentName').text('');
            }
        });

        refreshMarkdownSupportForNetmail();
    }

    // Auto-save draft every 2 minutes
    setInterval(function () {
        saveDraft(true); // Silent save
    }, 120000);

});

function loadEchoareas() {
    $.get('/api/echoareas')
        .done(function(data) {
            const select = $('#echoarea');
            select.empty().append('<option value="">Select echo area...</option>');

            if (data.echoareas) {
                allEchoareas = data.echoareas;
                data.echoareas.forEach(function(area) {
                    const label = area.domain ? area.tag + '@' + area.domain : area.tag;
                    select.append(`<option value="${area.tag}@${area.domain}" data-color="${area.color || '#28a745'}">${label}</option>`);
                });

                // Add color styling to select options and refresh cross-post list
                select.on('change', function() {
                    const selectedOption = $(this).find('option:selected');
                    const color = selectedOption.data('color');
                    if (color) {
                        $(this).css('border-left', `4px solid ${color}`);
                    }
                    populateCrossPostAreas();
                    refreshMarkdownSupportForEchomail();
                });
            }
            // Pre-select if specified in URL or template, or from loaded draft
            const urlParams = new URLSearchParams(window.location.search);
            let preselect = '{{ echoarea }}' || window.draftEchoarea;

            // If echoarea is in URL, combine with domain param for proper matching
            const urlEchoarea = urlParams.get('echoarea');
            const urlDomain = urlParams.get('domain');
            if (urlEchoarea) {
                // Combine echoarea and domain if domain is provided and echoarea doesn't already contain @
                preselect = (urlDomain && !urlEchoarea.includes('@'))
                    ? urlEchoarea + '@' + urlDomain
                    : urlEchoarea;
            }

            if (preselect) {
                select.val(preselect);
                // Trigger change event to apply color styling
                select.trigger('change');
            }

            // Clear the temporary draft echoarea after using it
            if (window.draftEchoarea) {
                delete window.draftEchoarea;
            }

            // Show cross-post section for new messages (not replies) with multiple areas
            const replyToId = $('#replyToId').val();
            if (!replyToId && allEchoareas.length > 1) {
                $('#crossPostSection').show();
                populateCrossPostAreas();
            }
        });
}

function populateCrossPostAreas() {
    const primaryVal = $('#echoarea').val();
    const container = $('#crossPostList');
    container.empty();

    allEchoareas.forEach(function(area) {
        const val = area.tag + '@' + area.domain;
        if (val === primaryVal) return;

        const id = 'crosspost_' + val.replace(/[@.]/g, '_');
        const areaLabel = area.domain ? area.tag + '@' + area.domain : area.tag;
        const colorDot = `<span style="display:inline-block; width:10px; height:10px; border-radius:50%; background-color:${area.color || '#28a745'}; margin-right:6px; vertical-align:middle;"></span>`;
        container.append(
            `<div class="form-check">
                <input class="form-check-input cross-post-check" type="checkbox" value="${escapeHtml(val)}" id="${id}">
                <label class="form-check-label small" for="${id}">${colorDot}${escapeHtml(areaLabel)}</label>
            </div>`
        );
    });

    // Enforce max limit and update badge
    container.off('change', '.cross-post-check').on('change', '.cross-post-check', function() {
        enforceCrossPostLimit();
    });
    enforceCrossPostLimit();
}

function enforceCrossPostLimit() {
    const checked = $('.cross-post-check:checked').length;
    const badge = $('#crossPostBadge');

    if (checked > 0) {
        badge.text(checked + '/' + maxCrossPostAreas).show();
    } else {
        badge.hide();
    }

    if (checked >= maxCrossPostAreas) {
        $('.cross-post-check:not(:checked)').prop('disabled', true);
    } else {
        $('.cross-post-check').prop('disabled', false);
    }
}


function validateFidonetAddressField(field) {
    const address = $(field).val().trim();
    if (address && !validateFidonetAddress(address)) {
        $(field).addClass('is-invalid');
        if (!$(field).next('.invalid-feedback').length) {
            $(field).after('<div class="invalid-feedback">Invalid Fidonet address format (e.g., 1:123/456)</div>');
        }
        return false;
    } else {
        $(field).removeClass('is-invalid');
        $(field).next('.invalid-feedback').remove();
        return true;
    }
}

function sendMessage() {
    const messageType = $('#messageType').val();
    const form = $('#composeForm');

    // Validate form
    if (!form[0].checkValidity()) {
        form[0].reportValidity();
        return;
    }

    // Additional validation for netmail
    if (messageType === 'netmail') {
        if (!validateFidonetAddressField('#toAddress')) {
            return;
        }
    }

    // Sync markdown editor content to hidden textarea if active
    syncEditorToTextarea();

    // Collect cross-post areas
    const crossPostAreas = [];
    $('.cross-post-check:checked').each(function() {
        crossPostAreas.push($(this).val());
    });

        const formData = {
            type: messageType,
            to_address: $('#toAddress').val(),
            to_name: $('#toName').val(),
            echoarea: $('#echoarea').val(),
            subject: $('#subject').val(),
            message_text: $('#messageText').val(),
            reply_to_id: $('#replyToId').val() || null,
            crashmail: $('#crashmail').is(':checked'),
            tagline: $('#taglineSelect').val(),
            cross_post_areas: crossPostAreas,
            send_markdown: $('#sendMarkdown').length ? $('#sendMarkdown').is(':checked') : false
        };

    // Show sending status
    $('#sendStatus').show().html(`
        <div class="alert alert-info">
            <i class="fas fa-spinner fa-spin me-2"></i>
            Sending ${messageType}...
        </div>
    `);

    // Disable form
    form.find('input, textarea, select, button').prop('disabled', true);

    // Upload attachment first if one is selected (netmail only)
    const attachFile = document.getElementById('attachmentFile');
    const hasAttachment = messageType === 'netmail' && attachFile && attachFile.files.length > 0;

    function doSend(attachmentToken) {
        if (attachmentToken) {
            formData.attachment_token = attachmentToken;
        }

        $.ajax({
            url: `/api/messages/send`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                const areasPosted = response.areas_posted || 1;
                const crossPostMsg = areasPosted > 1 ? ` (posted to ${areasPosted} areas)` : '';
                $('#sendStatus').html(`
                    <div class="alert alert-success">
                        <i class="fas fa-check me-2"></i>
                        ${messageType.charAt(0).toUpperCase() + messageType.slice(1)} sent successfully!${crossPostMsg}
                    </div>
                `);

                // Delete draft after successful send if we loaded from a draft
                if (window.currentDraftId) {
                    deleteDraftAfterSend(window.currentDraftId);
                }

                setTimeout(function() {
                    window.location.href = `/${messageType}`;
                }, 2000);
            },
            error: function(xhr) {
                const error = xhr.responseJSON ? xhr.responseJSON.error : `Failed to send ${messageType}`;
                $('#sendStatus').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${escapeHtml(error)}
                    </div>
                `);

                // Re-enable form
                form.find('input, textarea, select, button').prop('disabled', false);
            }
        });
    } // end doSend

    if (hasAttachment) {
        // Upload the file first, then send the message with the returned token
        const uploadData = new FormData();
        uploadData.append('file', attachFile.files[0]);
        $.ajax({
            url: '/api/netmail/attachment/upload',
            method: 'POST',
            data: uploadData,
            processData: false,
            contentType: false,
            success: function(response) {
                doSend(response.token);
            },
            error: function(xhr) {
                const error = xhr.responseJSON ? xhr.responseJSON.error : 'Failed to upload attachment';
                $('#sendStatus').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${escapeHtml(error)}
                    </div>
                `);
                form.find('input, textarea, select, button').prop('disabled', false);
            }
        });
    } else {
        doSend(null);
    }
}


function saveDraft(silent = false) {
    syncEditorToTextarea();
    const formData = {
        type: $('#messageType').val(),
        to_address: $('#toAddress').val(),
        to_name: $('#toName').val(),
        echoarea: $('#echoarea').val(),
        subject: $('#subject').val(),
        message_text: $('#messageText').val(),
        reply_to_id: $('#replyToId').val() || null
    };

    // Only save if there's actual content
    if (!formData.subject.trim() && !formData.message_text.trim()) {
        if (!silent) {
            showError('Please add some content before saving draft');
        }
        return;
    }

    // Get the save draft button and show loading state (only if not silent)
    const saveButton = $('button[onclick="saveDraft()"]');
    const originalButtonHtml = saveButton.html();

    if (!silent && saveButton.length) {
        saveButton.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');
    }

    $.ajax({
        url: '/api/messages/draft',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            if (!silent) {
                // Show success state on button
                if (saveButton.length) {
                    saveButton.removeClass('btn-outline-primary').addClass('btn-success')
                        .html('<i class="fas fa-check"></i> Saved!');

                    // Reset button after 2 seconds
                    setTimeout(function() {
                        saveButton.addClass('btn-outline-primary').removeClass('btn-success')
                            .prop('disabled', false).html(originalButtonHtml);
                    }, 2000);
                } else {
                    showSuccess('Draft saved successfully');
                }
            } else {
                // For silent saves, just reset button if it was showing loading
                if (saveButton.length && saveButton.prop('disabled')) {
                    saveButton.prop('disabled', false).html(originalButtonHtml);
                }
            }
        },
        error: function() {
            if (!silent) {
                // Reset button on error
                if (saveButton.length) {
                    saveButton.removeClass('btn-success').addClass('btn-outline-primary')
                        .prop('disabled', false).html(originalButtonHtml);
                }
                showError('Failed to save draft');
            }
        }
    });
}

function loadDraft(draftId) {
    return new Promise(function(resolve, reject) {
        $.ajax({
            url: `/api/messages/drafts/${draftId}`,
            method: 'GET',
            success: function(response) {
                if (response.success && response.draft) {
                    const draft = response.draft;

                    // Populate form fields with draft data
                    if (draft.to_address) $('#toAddress').val(draft.to_address);
                    if (draft.to_name) $('#toName').val(draft.to_name);
                    if (draft.subject) $('#subject').val(draft.subject);
                    if (draft.message_text) $('#messageText').val(draft.message_text);
                    if (draft.echoarea) {
                        // For echomail, the echoarea will be set after loadEchoareas() completes
                        window.draftEchoarea = draft.echoarea;
                    }
                    if (draft.reply_to_id) $('#replyToId').val(draft.reply_to_id);

                    // Store draft ID for potential deletion after sending
                    window.currentDraftId = draftId;

                    console.log('Draft loaded successfully:', draft);
                    resolve(draft);
                } else {
                    showError('Failed to load draft');
                    reject('Draft not found');
                }
            },
            error: function() {
                showError('Failed to load draft');
                reject('API error');
            }
        });
    });
}

function deleteDraftAfterSend(draftId) {
    $.ajax({
        url: `/api/messages/drafts/${draftId}`,
        method: 'DELETE',
        success: function(response) {
            console.log('Draft deleted successfully after sending message');
        },
        error: function() {
            console.warn('Failed to delete draft after sending message');
            // Don't show error to user since message was sent successfully
        }
    });
}

// Address Book Functions for Compose Page
function loadComposeAddressBook(search = '') {
    $.get('/api/address-book', { search: search })
        .done(function(response) {
            if (response.success) {
                renderComposeAddressBook(response.entries);
            } else {
                $('#composeAddressList').html('<li><div class="text-danger py-2">Failed to load</div></li>');
            }
        })
        .fail(function(xhr, status, error) {
            $('#composeAddressList').html('<li><div class="text-danger py-2">Failed to load</div></li>');
        });
}

function renderComposeAddressBook(entries) {
    const container = $('#composeAddressList');
    let html = '';
    
    if (entries.length === 0) {
        html = '<li><div class="text-center text-muted py-2">No entries found</div></li>';
    } else {
        entries.forEach(function(entry) {
            html += `
                <li><a class="dropdown-item" href="#" onclick="selectAddressBookEntry('${escapeHtml(entry.messaging_user_id || 'unknown')}', '${escapeHtml(entry.node_address || '')}', ${entry.always_crashmail ? 'true' : 'false'})">
                    <div class="fw-bold">${escapeHtml(entry.name || 'Unnamed')}</div>
                    <div class="text-primary small">@${escapeHtml(entry.messaging_user_id || 'unknown')}</div>
                    <div class="text-muted small font-monospace">${escapeHtml(entry.node_address || 'No address')}</div>
                    ${entry.description ? `<div class="text-muted smaller">${escapeHtml(entry.description.substring(0, 40) + (entry.description.length > 40 ? '...' : ''))}</div>` : ''}
                </a></li>
            `;
        });
    }
    
    container.html(html);
}

function searchAddressBookForCompose(query) {
    if (query.length > 0) {
        loadComposeAddressBook(query);
    } else {
        loadComposeAddressBook();
    }
}

function selectAddressBookEntry(fullName, nodeAddress, alwaysCrashmail) {
    $('#toName').val(fullName);
    $('#toAddress').val(nodeAddress);

    // Set crashmail checkbox to match the contact's preference
    if ($('#crashmail').length) {
        $('#crashmail').prop('checked', alwaysCrashmail);
    }

    refreshMarkdownSupportForNetmail();

    // Close dropdown
    const dropdown = bootstrap.Dropdown.getInstance($('#addressBookButton'));
    if (dropdown) {
        dropdown.hide();
    }

    // Clear search
    $('#composeAddressSearch').val('');
}

// Initialize address book when dropdown is shown
$(document).ready(function() {
    $('#addressBookDropdown').on('show.bs.dropdown', function() {
        // Only load if not already loaded
        if ($('#composeAddressList').find('.fa-spinner').length > 0) {
            loadComposeAddressBook();
        }
    });
    
    // Pre-load address book entries on page load for faster access
    loadComposeAddressBook();
});

</script>

<!-- Address Book Entry Modal (only for netmail) -->
{% if type == 'netmail' %}
<div class="modal fade" id="addressBookModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addressBookModalTitle">Add Address Book Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addressBookForm">
                    <input type="hidden" id="addressBookEntryId">
                    
                    <div class="mb-3">
                        <label for="addressBookName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="addressBookName" required 
                               placeholder="Enter a descriptive name (e.g., John Smith)">
                        <div class="form-text">Descriptive name for this contact</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="addressBookUserId" class="form-label">User ID</label>
                        <input type="text" class="form-control" id="addressBookUserId" required 
                               placeholder="Enter the user ID for messaging">
                        <div class="form-text">User ID/handle to use when sending messages</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="addressBookNodeAddress" class="form-label">Node Address</label>
                        <input type="text" class="form-control" id="addressBookNodeAddress" required 
                               placeholder="1:234/567" pattern="^\d+:\d+\/\d+(\.\d+)?$"
                               title="Enter a valid Fidonet address (e.g., 1:234/567 or 1:234/567.0)">
                        <div class="form-text">Format: zone:net/node or zone:net/node.point</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="addressBookEmail" class="form-label">Email Address <small class="text-muted">(optional)</small></label>
                        <input type="email" class="form-control" id="addressBookEmail" 
                               placeholder="email@example.com">
                        <div class="form-text">For your reference only - not used for messaging</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="addressBookDescription" class="form-label">Description <small class="text-muted">(optional)</small></label>
                        <textarea class="form-control" id="addressBookDescription" rows="3"
                                  placeholder="Notes about this contact..."></textarea>
                    </div>

                    {% if crashmail_enabled %}
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="addressBookAlwaysCrashmail" name="always_crashmail">
                            <label class="form-check-label" for="addressBookAlwaysCrashmail">
                                <i class="fas fa-bolt text-warning me-1"></i>Always use crashmail for this Recipient
                            </label>
                            <div class="form-text">Automatically enable crashmail when composing messages to this contact.</div>
                        </div>
                    </div>
                    {% endif %}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveComposeAddressBookEntry()">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Address book modal functions for compose page
function showAddAddressModal() {
    $('#addressBookModalTitle').text('Add Address Book Entry');
    $('#addressBookEntryId').val('');
    $('#addressBookForm')[0].reset();
    $('#addressBookModal').modal('show');
}

function saveComposeAddressBookEntry() {
    const data = {
        name: $('#addressBookName').val().trim(),
        messaging_user_id: $('#addressBookUserId').val().trim(),
        node_address: $('#addressBookNodeAddress').val().trim(),
        email: $('#addressBookEmail').val().trim(),
        description: $('#addressBookDescription').val().trim(),
        always_crashmail: $('#addressBookAlwaysCrashmail').is(':checked'),
    };
    
    // Basic validation
    if (!data.name || !data.messaging_user_id || !data.node_address) {
        showError('Name, user ID, and node address are required');
        return;
    }
    
    $.ajax({
        url: '/api/address-book/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
            if (response.success) {
                $('#addressBookModal').modal('hide');
                loadComposeAddressBook();
                showSuccess('Entry added successfully');
                // Optionally populate the compose form
                if (confirm('Use this entry for the current message?')) {
                    $('#toName').val(data.messaging_user_id);
                    $('#toAddress').val(data.node_address);
                }
            } else {
                showError(response.error || 'Failed to save entry');
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            showError(response && response.error ? response.error : 'Failed to save entry');
        }
    });
}
</script>
{% endif %}

<!-- Markdown Quick Reference Modal -->
<div class="modal fade" id="markdownHelpModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fab fa-markdown me-2"></i>Markdown Quick Reference</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Text Formatting</h6>
                        <table class="table table-sm table-bordered">
                            <thead><tr><th>Syntax</th><th>Result</th></tr></thead>
                            <tbody>
                                <tr><td><code>**bold**</code></td><td><strong>bold</strong></td></tr>
                                <tr><td><code>*italic*</code></td><td><em>italic</em></td></tr>
                                <tr><td><code>`inline code`</code></td><td><code>inline code</code></td></tr>
                                <tr><td><code>[link](url)</code></td><td>hyperlink</td></tr>
                            </tbody>
                        </table>
                        <h6>Headings</h6>
                        <table class="table table-sm table-bordered">
                            <tbody>
                                <tr><td><code># Heading 1</code></td><td><strong>H1</strong></td></tr>
                                <tr><td><code>## Heading 2</code></td><td><strong>H2</strong></td></tr>
                                <tr><td><code>### Heading 3</code></td><td><strong>H3</strong></td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Lists &amp; Blocks</h6>
                        <table class="table table-sm table-bordered">
                            <tbody>
                                <tr><td><code>- item</code></td><td>Bullet list</td></tr>
                                <tr><td><code>1. item</code></td><td>Numbered list</td></tr>
                                <tr><td><code>&gt; text</code></td><td>Blockquote</td></tr>
                                <tr><td><code>---</code></td><td>Horizontal rule</td></tr>
                            </tbody>
                        </table>
                        <h6>Code Block</h6>
                        <pre class="bg-light p-2 rounded small">```
code here
```</pre>
                        <h6>Keyboard Shortcuts</h6>
                        <table class="table table-sm table-bordered">
                            <tbody>
                                <tr><td><kbd>Ctrl+B</kbd></td><td>Bold</td></tr>
                                <tr><td><kbd>Ctrl+I</kbd></td><td>Italic</td></tr>
                                <tr><td><kbd>Ctrl+K</kbd></td><td>Link</td></tr>
                                <tr><td><kbd>Tab</kbd></td><td>Indent (4 spaces)</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
