{% extends "base.twig" %}

{% block title %}BBS Settings{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">BBS Settings</h1>
    </div>

    <div class="card shadow">
        <div class="card-header">
            <h6 class="mb-0">System Settings</h6>
        </div>
        <div class="card-body">
            <div id="bbsSystemAlert"></div>
            <form id="bbsSystemForm">
                <div class="mb-3">
                    <label class="form-label" for="bbsSystemName">System Name</label>
                    <input type="text" class="form-control" id="bbsSystemName">
                </div>
                <div class="mb-3">
                    <label class="form-label" for="bbsSystemSysop">Sysop Name</label>
                    <input type="text" class="form-control" id="bbsSystemSysop">
                </div>
                <div class="mb-3">
                    <label class="form-label" for="bbsSystemLocation">Location</label>
                    <input type="text" class="form-control" id="bbsSystemLocation">
                </div>
                <div class="mb-3">
                    <label class="form-label" for="bbsSystemAddress">System Address</label>
                    <input type="text" class="form-control" id="bbsSystemAddress">
                </div>
                <div class="mb-3">
                    <label class="form-label" for="bbsSystemOrigin">Origin Line</label>
                    <input type="text" class="form-control" id="bbsSystemOrigin">
                </div>
                <button type="button" class="btn btn-primary" onclick="saveBbsSystem()">Save System Settings</button>
            </form>
        </div>
    </div>

    <div class="card shadow mt-4">
        <div class="card-header">
            <h6 class="mb-0">Binkp Configuration</h6>
        </div>
        <div class="card-body">
            <div id="bbsBinkpAlert"></div>
            <form id="bbsBinkpForm">
                <div class="mb-3">
                    <label class="form-label" for="bbsBinkpPort">Port</label>
                    <input type="number" class="form-control" id="bbsBinkpPort" min="1" max="65535">
                </div>
                <div class="mb-3">
                    <label class="form-label" for="bbsBinkpTimeout">Timeout (seconds)</label>
                    <input type="number" class="form-control" id="bbsBinkpTimeout" min="30" max="3600">
                </div>
                <div class="mb-3">
                    <label class="form-label" for="bbsBinkpMaxConnections">Max Connections</label>
                    <input type="number" class="form-control" id="bbsBinkpMaxConnections" min="1" max="100">
                </div>
                <div class="mb-3">
                    <label class="form-label" for="bbsBinkpBindAddress">Bind Address</label>
                    <input type="text" class="form-control" id="bbsBinkpBindAddress">
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="bbsBinkpPreservePackets">
                    <label class="form-check-label" for="bbsBinkpPreservePackets">Preserve Processed Packets</label>
                </div>
                <button type="button" class="btn btn-primary" onclick="saveBbsBinkp()">Save Binkp Settings</button>
            </form>
        </div>
    </div>

    <div class="card shadow mt-4">
        <div class="card-header">
            <h6 class="mb-0">BBS Features</h6>
        </div>
        <div class="card-body">
            <div id="bbsSettingsAlert"></div>
            <form id="bbsSettingsForm">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="bbsWebdoors">
                    <label class="form-check-label" for="bbsWebdoors">Enable Webdoors</label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="bbsShoutbox">
                    <label class="form-check-label" for="bbsShoutbox">Enable Shoutbox</label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="bbsAdvertising">
                    <label class="form-check-label" for="bbsAdvertising">Enable Advertising</label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="bbsVoting">
                    <label class="form-check-label" for="bbsVoting">Enable Voting Booth</label>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="bbsChat">
                    <label class="form-check-label" for="bbsChat">Enable Chat</label>
                </div>
                <button type="button" class="btn btn-primary" onclick="saveBbsSettings()">Save Settings</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadBbsSettings();
    loadBbsSystem();
    loadBbsBinkp();
});

function loadBbsSettings() {
    fetch('/admin/api/bbs-settings')
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'Failed to load settings');
            }
            const features = data.config?.features || {};
            document.getElementById('bbsWebdoors').checked = !!features.webdoors;
            document.getElementById('bbsShoutbox').checked = !!features.shoutbox;
            document.getElementById('bbsAdvertising').checked = !!features.advertising;
            document.getElementById('bbsVoting').checked = !!features.voting_booth;
            document.getElementById('bbsChat').checked = !!features.chat;
        })
        .catch(error => {
            showBbsSettingsAlert(error.message || 'Failed to load settings', 'danger');
        });
}

function saveBbsSettings() {
    const config = {
        features: {
            webdoors: document.getElementById('bbsWebdoors').checked,
            shoutbox: document.getElementById('bbsShoutbox').checked,
            advertising: document.getElementById('bbsAdvertising').checked,
            voting_booth: document.getElementById('bbsVoting').checked,
            chat: document.getElementById('bbsChat').checked
        }
    };

    fetch('/admin/api/bbs-settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ config })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            throw new Error(data.error || 'Failed to save settings');
        }
        showBbsSettingsAlert('Settings saved successfully.', 'success');
    })
    .catch(error => {
        showBbsSettingsAlert(error.message || 'Failed to save settings', 'danger');
    });
}

function loadBbsSystem() {
    fetch('/admin/api/bbs-system')
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'Failed to load system settings');
            }
            const config = data.config || {};
            document.getElementById('bbsSystemName').value = config.name || '';
            document.getElementById('bbsSystemSysop').value = config.sysop || '';
            document.getElementById('bbsSystemLocation').value = config.location || '';
            document.getElementById('bbsSystemAddress').value = config.address || '';
            document.getElementById('bbsSystemOrigin').value = config.origin || '';
        })
        .catch(error => {
            showBbsSystemAlert(error.message || 'Failed to load system settings', 'danger');
        });
}

function saveBbsSystem() {
    const config = {
        name: document.getElementById('bbsSystemName').value.trim(),
        sysop: document.getElementById('bbsSystemSysop').value.trim(),
        location: document.getElementById('bbsSystemLocation').value.trim(),
        address: document.getElementById('bbsSystemAddress').value.trim(),
        origin: document.getElementById('bbsSystemOrigin').value.trim()
    };

    fetch('/admin/api/bbs-system', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ config })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            throw new Error(data.error || 'Failed to save system settings');
        }
        showBbsSystemAlert('System settings saved successfully.', 'success');
    })
    .catch(error => {
        showBbsSystemAlert(error.message || 'Failed to save system settings', 'danger');
    });
}

function loadBbsBinkp() {
    fetch('/admin/api/bbs-binkp')
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'Failed to load binkp settings');
            }
            const config = data.config || {};
            document.getElementById('bbsBinkpPort').value = config.port ?? '';
            document.getElementById('bbsBinkpTimeout').value = config.timeout ?? '';
            document.getElementById('bbsBinkpMaxConnections').value = config.max_connections ?? '';
            document.getElementById('bbsBinkpBindAddress').value = config.bind_address ?? '';
            document.getElementById('bbsBinkpPreservePackets').checked = !!config.preserve_processed_packets;
        })
        .catch(error => {
            showBbsBinkpAlert(error.message || 'Failed to load binkp settings', 'danger');
        });
}

function saveBbsBinkp() {
    const config = {
        port: parseInt(document.getElementById('bbsBinkpPort').value, 10),
        timeout: parseInt(document.getElementById('bbsBinkpTimeout').value, 10),
        max_connections: parseInt(document.getElementById('bbsBinkpMaxConnections').value, 10),
        bind_address: document.getElementById('bbsBinkpBindAddress').value.trim(),
        preserve_processed_packets: document.getElementById('bbsBinkpPreservePackets').checked
    };

    fetch('/admin/api/bbs-binkp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ config })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            throw new Error(data.error || 'Failed to save binkp settings');
        }
        showBbsBinkpAlert('Binkp settings saved successfully.', 'success');
    })
    .catch(error => {
        showBbsBinkpAlert(error.message || 'Failed to save binkp settings', 'danger');
    });
}

function showBbsSettingsAlert(message, type) {
    const container = document.getElementById('bbsSettingsAlert');
    container.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
}

function showBbsSystemAlert(message, type) {
    const container = document.getElementById('bbsSystemAlert');
    container.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
}

function showBbsBinkpAlert(message, type) {
    const container = document.getElementById('bbsBinkpAlert');
    container.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
}
</script>
{% endblock %}
