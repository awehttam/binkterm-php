{% extends "base.twig" %}

{% block title %}Insecure Nodes - Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="fas fa-shield-alt me-2"></i>Insecure Node Allowlist</h1>
        <div class="btn-toolbar">
            <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addNodeModal">
                <i class="fas fa-plus me-1"></i>Add Node
            </button>
            <a href="/admin" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Info Alert -->
    <div class="alert alert-info mb-4">
        <i class="fas fa-info-circle me-2"></i>
        <strong>About Insecure Sessions:</strong> Nodes in this allowlist can connect via binkp without password authentication.
        Use with caution - insecure sessions are typically receive-only (they can deliver mail to you, but cannot pick up mail).
    </div>

    <!-- Nodes Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">Allowed Nodes</h6>
            <button class="btn btn-sm btn-outline-primary" id="refreshNodes">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="nodesTable">
                    <thead>
                        <tr>
                            <th>Address</th>
                            <th>Description</th>
                            <th>Receive</th>
                            <th>Send</th>
                            <th>Max Msgs</th>
                            <th>Last Session</th>
                            <th>Active</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="nodesTableBody">
                        <tr>
                            <td colspan="8" class="text-center">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Node Modal -->
<div class="modal fade" id="addNodeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Node to Allowlist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addNodeForm">
                    <div class="mb-3">
                        <label class="form-label">FTN Address <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="address" placeholder="1:123/456" required>
                        <div class="form-text">The FidoNet address of the node (e.g., 1:123/456)</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" name="description" placeholder="Node description">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Max Messages Per Session</label>
                        <input type="number" class="form-control" name="max_messages_per_session" value="100" min="1" max="10000">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="allow_receive" id="allowReceive" checked>
                            <label class="form-check-label" for="allowReceive">Allow Receive</label>
                            <div class="form-text">Allow this node to deliver mail to us</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="allow_send" id="allowSend">
                            <label class="form-check-label" for="allowSend">Allow Send (Pickup)</label>
                            <div class="form-text">Allow this node to pick up mail from us (use with caution)</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveNodeBtn">Add Node</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Node Modal -->
<div class="modal fade" id="editNodeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Node</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editNodeForm">
                    <input type="hidden" name="id" id="editNodeId">
                    <div class="mb-3">
                        <label class="form-label">FTN Address</label>
                        <input type="text" class="form-control" name="address" id="editAddress" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" name="description" id="editDescription">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Max Messages Per Session</label>
                        <input type="number" class="form-control" name="max_messages_per_session" id="editMaxMessages" min="1" max="10000">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="allow_receive" id="editAllowReceive">
                            <label class="form-check-label" for="editAllowReceive">Allow Receive</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="allow_send" id="editAllowSend">
                            <label class="form-check-label" for="editAllowSend">Allow Send (Pickup)</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="is_active" id="editIsActive">
                            <label class="form-check-label" for="editIsActive">Active</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateNodeBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadNodes();

    document.getElementById('refreshNodes').addEventListener('click', loadNodes);
    document.getElementById('saveNodeBtn').addEventListener('click', addNode);
    document.getElementById('updateNodeBtn').addEventListener('click', updateNode);
});

function loadNodes() {
    fetch('/admin/api/insecure-nodes')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('nodesTableBody');

            if (!data.nodes || data.nodes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No nodes in allowlist</td></tr>';
                return;
            }

            tbody.innerHTML = data.nodes.map(node => `
                <tr>
                    <td><code>${escapeHtml(node.address)}</code></td>
                    <td>${escapeHtml(node.description || '-')}</td>
                    <td>${node.allow_receive ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-times text-danger"></i>'}</td>
                    <td>${node.allow_send ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-times text-danger"></i>'}</td>
                    <td>${node.max_messages_per_session}</td>
                    <td>${node.last_session_at ? formatDate(node.last_session_at) : '<em>Never</em>'}</td>
                    <td>
                        ${node.is_active
                            ? '<span class="badge bg-success">Active</span>'
                            : '<span class="badge bg-secondary">Inactive</span>'}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editNode(${node.id}, '${escapeHtml(node.address)}', '${escapeHtml(node.description || '')}', ${node.max_messages_per_session}, ${node.allow_receive}, ${node.allow_send}, ${node.is_active})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteNode(${node.id}, '${escapeHtml(node.address)}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        })
        .catch(error => {
            console.error('Error loading nodes:', error);
            document.getElementById('nodesTableBody').innerHTML =
                '<tr><td colspan="8" class="text-center text-danger">Error loading nodes</td></tr>';
        });
}

function addNode() {
    const form = document.getElementById('addNodeForm');
    const formData = new FormData(form);

    const data = {
        address: formData.get('address'),
        description: formData.get('description'),
        max_messages_per_session: parseInt(formData.get('max_messages_per_session')) || 100,
        allow_receive: form.querySelector('[name="allow_receive"]').checked,
        allow_send: form.querySelector('[name="allow_send"]').checked,
        is_active: true
    };

    fetch('/admin/api/insecure-nodes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('addNodeModal')).hide();
            form.reset();
            loadNodes();
        } else {
            alert('Error: ' + (result.error || 'Failed to add node'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function editNode(id, address, description, maxMessages, allowReceive, allowSend, isActive) {
    document.getElementById('editNodeId').value = id;
    document.getElementById('editAddress').value = address;
    document.getElementById('editDescription').value = description;
    document.getElementById('editMaxMessages').value = maxMessages;
    document.getElementById('editAllowReceive').checked = allowReceive;
    document.getElementById('editAllowSend').checked = allowSend;
    document.getElementById('editIsActive').checked = isActive;

    new bootstrap.Modal(document.getElementById('editNodeModal')).show();
}

function updateNode() {
    const id = document.getElementById('editNodeId').value;
    const form = document.getElementById('editNodeForm');

    const data = {
        description: document.getElementById('editDescription').value,
        max_messages_per_session: parseInt(document.getElementById('editMaxMessages').value) || 100,
        allow_receive: document.getElementById('editAllowReceive').checked,
        allow_send: document.getElementById('editAllowSend').checked,
        is_active: document.getElementById('editIsActive').checked
    };

    fetch(`/admin/api/insecure-nodes/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('editNodeModal')).hide();
            loadNodes();
        } else {
            alert('Error: ' + (result.error || 'Failed to update node'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function deleteNode(id, address) {
    if (!confirm(`Delete ${address} from the allowlist?`)) return;

    fetch(`/admin/api/insecure-nodes/${id}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                loadNodes();
            } else {
                alert('Error: ' + (result.error || 'Failed to delete node'));
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleString();
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
