{% extends "base.twig" %}

{% block title %}Who's Online - {{ system_name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1><i class="fas fa-user-friends"></i> Who's Online</h1>
        <small class="text-muted">Active in last {{ online_minutes }} minutes</small>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">Online Users</h6>
            <span class="badge bg-secondary" id="onlineCount">{{ online_users|length }}</span>
        </div>
        <div class="card-body p-0">
            <div id="onlineTableWrap" class="{{ online_users|length > 0 ? '' : 'd-none' }}">
                <div class="table-responsive">
                    <table class="table table-striped align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Location</th>
                                {% if current_user and current_user.is_admin %}
                                <th>Last Activity</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody id="onlineUsersBody">
                            {% for user in online_users %}
                            <tr>
                                <td>{{ user.username }}</td>
                                <td>{{ user.location ?: 'Unknown' }}</td>
                                {% if current_user and current_user.is_admin %}
                                <td>{{ user.activity ?: '-' }}</td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="p-3 {{ online_users|length > 0 ? 'd-none' : '' }}" id="onlineEmptyState">
                <div class="alert alert-secondary mb-0">
                    <i class="fas fa-user-slash me-2"></i>
                    No users are online right now.
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const onlineMinutesLabel = document.querySelector('.text-muted');
    const onlineCount = document.getElementById('onlineCount');
    const onlineTableWrap = document.getElementById('onlineTableWrap');
    const onlineUsersBody = document.getElementById('onlineUsersBody');
    const onlineEmptyState = document.getElementById('onlineEmptyState');
    const isAdmin = !!(window.currentUserIsAdmin && window.currentUserIsAdmin === true);

    function updateOnlineView(payload) {
        if (!payload || !Array.isArray(payload.users)) {
            return;
        }

        const users = payload.users;
        if (onlineCount) {
            onlineCount.textContent = users.length;
        }
        if (onlineMinutesLabel && payload.online_minutes) {
            onlineMinutesLabel.textContent = `Active in last ${payload.online_minutes} minutes`;
        }

        if (users.length === 0) {
            if (onlineTableWrap) onlineTableWrap.classList.add('d-none');
            if (onlineEmptyState) onlineEmptyState.classList.remove('d-none');
            return;
        }

        if (onlineTableWrap) onlineTableWrap.classList.remove('d-none');
        if (onlineEmptyState) onlineEmptyState.classList.add('d-none');

        if (onlineUsersBody) {
            onlineUsersBody.innerHTML = users.map(user => {
                const location = user.location && user.location !== '' ? user.location : 'Unknown';
                const activityCell = isAdmin ? `<td>${user.activity && user.activity !== '' ? user.activity : '-'}</td>` : '';
                return `<tr>
                    <td>${escapeHtml(user.username || '')}</td>
                    <td>${escapeHtml(location)}</td>
                    ${activityCell}
                </tr>`;
            }).join('');
        }

    }

    function refreshOnline() {
        fetch('/api/whosonline')
            .then(res => res.json())
            .then(updateOnlineView)
            .catch(() => {});
    }

    setInterval(refreshOnline, 60000);
</script>
{% endblock %}
